<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>v8 Base | Migraine殇</title><meta name="keywords" content="仍在学习的苦旅中"><meta name="author" content="Migraine殇"><meta name="copyright" content="Migraine殇"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="V8基础相关">
<meta property="og:type" content="article">
<meta property="og:title" content="v8 Base">
<meta property="og:url" content="https://migraine-sudo.github.io/2020/02/15/v8/index.html">
<meta property="og:site_name" content="Migraine殇">
<meta property="og:description" content="V8基础相关">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://migraine-sudo.github.io/img/063Kee.jpg">
<meta property="article:published_time" content="2020-02-15T10:41:55.000Z">
<meta property="article:modified_time" content="2023-08-14T03:28:22.720Z">
<meta property="article:author" content="Migraine殇">
<meta property="article:tag" content="Exploit">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://migraine-sudo.github.io/img/063Kee.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://migraine-sudo.github.io/2020/02/15/v8/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/manifest.json"/><link rel="apple-touch-icon" sizes="180x180" href="/images/icons/icon-512x512.png"/><link rel="icon" type="image/png" sizes="32x32" href="/images/icons/icon-512x512.png"/><link rel="icon" type="image/png" sizes="16x16" href="/images/icons/icon-512x512.png"/><link rel="mask-icon" href="/images/icons/icon-512x512.png" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-08-14 11:28:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/%E6%88%88%E8%96%87.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/063Kee.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Migraine殇</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">v8 Base</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-02-15T10:41:55.000Z" title="发表于 2020-02-15 18:41:55">2020-02-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-14T03:28:22.720Z" title="更新于 2023-08-14 11:28:22">2023-08-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/v8/">v8</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note primary modern"><p>阅读辅助：</p>
<p>IE相关漏洞：<a href="https://migraine-sudo.github.io/2019/12/21/Shellcode-Write/">Shellcode编写</a>-&gt;<a href="https://migraine-sudo.github.io/2019/11/07/%E6%B5%8F%E8%A7%88%E5%99%A8UAF/">IE的UAF分析</a>-&gt; <a href="https://migraine-sudo.github.io/2019/12/01/CVE-2012-1876/">IE堆溢出利用</a> </p>
<p>JS Engine相关：<a href="https://migraine-sudo.github.io/2020/02/15/v8/">V8基础</a>-&gt;<a href="https://migraine-sudo.github.io/2019/12/20/qwn2own/">jscore exloit</a>&gt;<a href="https://migraine-sudo.github.io/2020/02/22/roll-a-v8/">roll a d8</a>-&gt;<a href="https://migraine-sudo.github.io/2020/10/06/v8-Instrumentation/">对V8进行插桩</a></p>
<p>CTF相关漏洞：<a href="https://migraine-sudo.github.io/2019/11/22/how2heap1/">how2heap One</a>-&gt;<a href="https://migraine-sudo.github.io/2019/11/25/how2heap2/">how2heap Two</a>-&gt;<a href="https://migraine-sudo.github.io/2020/01/25/how2heap3/">how2heap Three</a>-&gt;<a href="https://migraine-sudo.github.io/2020/01/27/how2heap4/">how2heap Four</a></p>
</div>

<p><em>学习v8过程中参考了很多资料以及师傅们的博客，在这里把自己实验过的&#x2F;或者需要速查的内容整理记录下来，里面引用各位师傅的博客的内容都注明了出处，特此致谢。</em></p>
<a id="more"></a>

<h2 id="V8环境配置"><a href="#V8环境配置" class="headerlink" title="V8环境配置"></a>V8环境配置</h2><p><strong>终端代理</strong></p>
<p>编译v8必须<em>科学上网</em>，本地使用<strong>crashx</strong>作为代理。</p>
<p>终端挂代理，将下面的代码写入&#x2F;etc&#x2F;bashrc，每次生成终端都会自动进行代理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export https_proxy&#x3D;http:&#x2F;&#x2F;127.0.0.1:7890</span><br><span class="line">export http_proxy&#x3D;http:&#x2F;&#x2F;127.0.0.1:7890</span><br><span class="line">export all_proxy&#x3D;socks5:&#x2F;&#x2F;127.0.0.1:7891</span><br></pre></td></tr></table></figure>
<p>或者参考<strong>自动化命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alias setproxy&#x3D;&quot;export https_proxy&#x3D;http:&#x2F;&#x2F;127.0.0.1:7890;export http_proxy&#x3D;http:&#x2F;&#x2F;127.0.0.1:7890;export all_proxy&#x3D;socks5:&#x2F;&#x2F;127.0.0.1:7891;echo \&quot;Set proxy successfully\&quot; &quot;</span><br><span class="line">alias unsetproxy&#x3D;&quot;unset http_proxy;unset https_proxy;unset all_proxy;echo \&quot;Unset proxy successfully\&quot; &quot; </span><br><span class="line">alias ipcn&#x3D;&quot;curl myip.ipip.net&quot;</span><br><span class="line">alias ip&#x3D;&quot;curl ip.sb&quot;</span><br></pre></td></tr></table></figure>
<p><code>curl cip.cc</code>检验代理(crash x开全局)</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/wDfUNM.png" alt="wDfUNM"></p>
<p><strong>编译v8</strong></p>
<p><a target="_blank" rel="noopener" href="http://eternalsakura13.com/2018/05/06/v8/">参考链接</a> </p>
<p>安装依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install binutils python2.7 perl socat git build-essential gdb gdbserver</span><br></pre></td></tr></table></figure>
<p><em>1. 准备depot_tools工具</em></p>
   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://chromium.googlesource.com/chromium/tools/depot_tools.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&#x27;export PATH=$PATH:&quot;/path/to/depot_tools&quot;&#x27;</span> &gt;&gt; ~/.bashrc		 <span class="comment">#depot_tools的目录</span></span></span><br></pre></td></tr></table></figure>
<p><em>2. ninja准备</em></p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/ninja-build/ninja.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ninja &amp;&amp; ./configure.py --bootstrap &amp;&amp; <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&#x27;export PATH=$PATH:&quot;/path/to/ninja&quot;&#x27;</span> &gt;&gt; ~/.bashrc</span></span><br></pre></td></tr></table></figure>
<p><em>3. v8编译</em></p>
<p><em>注意要使用depot_tools下的ninja而不是&#x2F;usr&#x2F;bin下的ninja,使用v8gen脚本快速构建toolchain</em></p>
   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> fetch v8 &amp;&amp; <span class="built_in">cd</span> v8&amp;&amp; gclient sync <span class="comment">#获取v8源代码同步最新源代码，如果直接clone了fetch命令可以不用</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tools/dev/v8gen.py x64.debug</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ninja -C out.gn/x64.debug				<span class="comment">#如果只编译d8的话，最后加上d8参数即可</span></span></span><br></pre></td></tr></table></figure>
<p><em>4. 运行d8</em></p>
   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./out.gn/x64.debug/d8</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./out.gn/x64.debug/v8_shell</span></span><br></pre></td></tr></table></figure>
<p>v8漏洞利用在browser pwn中一般有两种形式，都需要对v8进行patch然后再进行编译。</p>
<ul>
<li><p>直接使用真实的cve，一般提供commit的hash值。</p>
<p>在编译v8以前，需要使用<code>git reset --hard hash值</code>来对版本进行回溯–&gt;<a href>roll a d8</a></p>
</li>
<li><p>出题人给出一个patch，人为地在v8制造一个漏洞，一般提供一个diff文件&#x2F;编译好的v8可执行文件–&gt;<a href>oob-v8</a></p>
<p>需要<code>git apply &lt; diff文件</code>将diff文件加入v8源码分支。</p>
</li>
</ul>
<p><strong>范例题目</strong></p>
<p>例如<em>Star CTF 2019 oob-v8</em>，题目信息，我们需要使用对应版本的v8，然后打上我们的patch。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Yet another off by one</span><br><span class="line"></span><br><span class="line">$ nc 212.64.104.189 10000</span><br><span class="line">the v8 commits is 6dc88c191f5ecc5389dc26efa3ca0907faef3598.</span><br></pre></td></tr></table></figure>
<p>下载v8源代码并且回溯版本，不过因为编译失败，后来还是选择用fetch。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/v8/v8.git &amp;&amp; <span class="built_in">cd</span> v8 <span class="comment">#这一步改为fetch v8</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git reset --hard 6dc88c191f5ecc5389dc26efa3ca0907faef3598</span></span><br><span class="line">	Checking out files: 100% (6085/6085), done.</span><br><span class="line">	HEAD is now at 6dc88c1 Update V8 DEPS.</span><br></pre></td></tr></table></figure>
<p>将diff补丁写入代码，然后编译即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git apply &lt; oob.diff</span></span><br></pre></td></tr></table></figure>
<p><strong>diff补丁</strong></p>
<p>oob.diff</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">index b027d36..ef1002f 100644</span></span><br><span class="line"><span class="comment">--- a/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/bootstrapper.cc</span></span><br><span class="line"><span class="meta">@@ -1668,6 +1668,8 @@</span> void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">index 8df340e..9b828ab 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="meta">@@ -361,6 +361,27 @@</span> V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">index 0447230..f113a81 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="meta">@@ -368,6 +368,7 @@</span> namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line"><span class="addition">+  CPP(ArrayOob)                                                                \</span></span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line"><span class="comment">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">index ed1e4a5..c199e3a 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/typer.cc</span></span><br><span class="line"><span class="meta">@@ -1680,6 +1680,8 @@</span> Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line"><span class="addition">+    case Builtins::kArrayOob:</span></span><br><span class="line"><span class="addition">+      return Type::Receiver();</span></span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br></pre></td></tr></table></figure>
<p><strong>编译v8的问题汇总</strong></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/guillotine007/article/details/81152585">chromium-cipd : golang net&#x2F;http proxy代理</a></p>
<p><em>gclient sync的时候提示代理连接失败</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[P5912 11:57:20.290 client.go:347 W] RPC failed transiently. Will retry in 1s    &#123;&quot;error&quot;:&quot;failed to send request: Post https://chrome-infra-packages.appspot.com/prpc/cipd.Repository/GetInstanceURL: proxyconnect tcp: EOF&quot;, &quot;host&quot;:&quot;chrome-infra-packages.appspot.com&quot;, &quot;method&quot;:&quot;GetInstanceURL&quot;, &quot;service&quot;:&quot;cipd.Repository&quot;, &quot;sleepTime&quot;:&quot;1s&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>我是通过仅代理http（不使用https和sock5）来实现的(192.168.1.106是我mac主机的地址)我在Ubuntu下执行这个命令</p>
<p><code>export https_proxy=http://192.168.1.106:7890 </code> </p>
<p><em>提示Error: client not configured; see ‘gclient config’</em></p>
<p>在v8目录下创建一个.gclient文件，然后执行gclient sync</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">solutions = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;managed&quot;</span>: False,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;src&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://chromium.googlesource.com/chromium/src.git&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;custom_deps&quot;</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;deps_file&quot;</span>: <span class="string">&quot;.DEPS.git&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;safesync_url&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><strong>v8调试基础</strong></p>
<ul>
<li><p><em><strong>Google提供的gdb插件 gdb-v8-support.py</strong></em></p>
<p>可以在&#x2F;tools目录下找到.gdbinit和gdb-v8-support.py文件，然后在~&#x2F;.gdbinit文件中source引入py文件，同时将.gdbinit的内容拷贝到～&#x2F;.gdbinit中</p>
<p>其中定义了一些方法比如job，可以在gdb中作为辅助使用</p>
</li>
</ul>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/wClJ9b.png" alt="wClJ9b"></p>
<ul>
<li><p><em><strong>Allow-natives-syntax参数</strong></em></p>
<p>在运行v8时附加<code>--allow-natives-syntax</code>参数，可以通过该选项调用一些有助于调试到本地运行时函数。</p>
<ul>
<li>%DebugPrint(obj) 输出对象地址</li>
<li>%SystemBreak()插入调试中断，重新调试时还会断在此处。</li>
<li>Print在遇到CodeStubAssembler的代码时，可以用于输出变量值。</li>
</ul>
</li>
<li><p>***readline()***添加在js代码中，让程序停下等待输入，方便gdb调试。</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/inexorabletash/polyfill"><em><strong>Polyfill</strong></em></a> 包含很多js本身实现的js函数，实现逻辑和v8很类似，但是比C++阅读难度低很多。</p>
</li>
</ul>
<h2 id="v8-DEBUG"><a href="#v8-DEBUG" class="headerlink" title="v8 DEBUG"></a>v8 DEBUG</h2><h3 id="V8-Object入门"><a href="#V8-Object入门" class="headerlink" title="V8 Object入门"></a>V8 Object入门</h3><p>这部分流程基本按照<strong>THORN</strong>大神的文章思路走下来，增加了从内存角度看的内容，很大一部分大神写的太好了就直接<em>引用</em>了，在这里做<em>声明</em>。</p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5cc7dc5af265da038d0b514d">V8是怎么跑起来的</a> </p>
<p><strong>在Chrome中查看快照</strong></p>
<ul>
<li><p>在console中运行一段js代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Fool</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> a=<span class="keyword">new</span> Fool(); <span class="comment">//构造函数主要是为了更方便地在快照中找到对象</span></span><br><span class="line">a.name=<span class="string">&#x27;aaa&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>在Memory中，设置Profiles为Heap snapshot（堆快照），点击左边的小圆点。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/iSwsfJ.png" alt="iSwsfJ"></p>
</li>
</ul>
<p><strong>v8对象结构</strong></p>
<ul>
<li><p>v8的对象主要由三个指针构成</p>
<ul>
<li>Hidden Class(隐藏类)</li>
<li>Property</li>
<li>Element</li>
</ul>
</li>
</ul>
<p> 隐藏类用于描述对象的结构，Property和Element用于存放对象的属性，两者的区别主要体现在键名能否被索引。仔细的读者应该发现，在对象中还包含着名为<code>__proto__</code>的属性，这是JS对象中的<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/23090041?refer=study-fe">原型链</a>，与JS中<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/23987456">NEW的用途</a>有关。</p>
<p>  <img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/8B7ERf.png" alt="8B7ERf"></p>
<p><strong>Property和Elememt</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可索引属性会被存储到 Elements 指针指向的区域</span></span><br><span class="line">&#123; <span class="number">1</span>: <span class="string">&quot;a&quot;</span>, <span class="number">2</span>: <span class="string">&quot;b&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 命名属性会被存储到 Properties 指针指向的区域</span></span><br><span class="line">&#123; <span class="string">&quot;first&quot;</span>: <span class="number">1</span>, <span class="string">&quot;second&quot;</span>: <span class="number">2</span> &#125;</span><br></pre></td></tr></table></figure>
<p>参照ECMA规范中的要求，可索引属性需要按照索引值大小升序排列，而命令属性根据创建的顺序升序排列。</p>
<p>让我们运行以下代码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = &#123; <span class="number">1</span>: <span class="string">&quot;a&quot;</span>, <span class="number">2</span>: <span class="string">&quot;b&quot;</span>, <span class="string">&quot;first&quot;</span>: <span class="number">1</span>, <span class="number">3</span>: <span class="string">&quot;c&quot;</span>, <span class="string">&quot;second&quot;</span>: <span class="number">2</span> &#125;</span><br><span class="line"><span class="keyword">var</span> b = &#123; <span class="string">&quot;second&quot;</span>: <span class="number">2</span>, <span class="number">1</span>: <span class="string">&quot;a&quot;</span>, <span class="number">3</span>: <span class="string">&quot;c&quot;</span>, <span class="number">2</span>: <span class="string">&quot;b&quot;</span>, <span class="string">&quot;first&quot;</span>: <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/j5oJ6n.png" alt="j5oJ6n"></p>
<p>对象a以<strong>可索引属性</strong>开头，存储时按照可索引对象升序排列，命名属性first比second要早创建，所以first排列在secnod前。对象b以<strong>命名属性</strong>开头，存储时与可索引部分与a相同，命名属性按照创建先后排列，second在first之前。而可索引属性和命名属性都很明显是分开的，也验证了两者时<strong>分开存储</strong>的理论。</p>
<p><em>结论</em></p>
<ul>
<li>索引的属性按照升序排列，命名属性根据创建的顺序升序排列</li>
<li>同时使用两种属性时，两个属性分开存储</li>
</ul>
<p>让我们来实际论证一下这个理论，通过之前的Heap快照来查看内存中的对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo1</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> Foo1()</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> Foo1()</span><br><span class="line"></span><br><span class="line">a.name = <span class="string">&#x27;aaa&#x27;</span></span><br><span class="line">a.text = <span class="string">&#x27;aaa&#x27;</span></span><br><span class="line">b.name = <span class="string">&#x27;bbb&#x27;</span></span><br><span class="line">b.text = <span class="string">&#x27;bbb&#x27;</span></span><br><span class="line"></span><br><span class="line">a[<span class="number">1</span>] = <span class="string">&#x27;aaa&#x27;</span></span><br><span class="line">a[<span class="number">2</span>] = <span class="string">&#x27;aaa&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//v8调试用</span></span><br><span class="line"><span class="comment">//%DebugPrint(a)</span></span><br><span class="line"><span class="comment">//%DebugPrint(b)</span></span><br><span class="line"><span class="comment">//%SystemBreak()</span></span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/GTtP0c.png" alt="GTtP0c"></p>
<p>a和b都包含命名属性name和text，a还拥有两个可索引属性。</p>
<p>a和b两个对象指向的<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30638831/article/details/90552912">隐藏类</a>是同一个(图中的Map @111025)，即说明a和b的对象具有相同的结构。</p>
<p><em>思考一下，为什么a和b的属性并不相同，但是两者却拥有相同的结构？</em>THORN大神的文章中解释，可索引属性本身就是有序排列，并不需要通过结构去查找，所以也就不会和隐藏类有什么关系了。两者拥有相同隐藏类的原因还是取决于包含相同的命名属性name和text。</p>
<p>大神还给出另外一个案例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a[<span class="number">1111</span>]=<span class="string">&#x27;aaa&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/r3FqGA.png" alt="r3FqGA"></p>
<p>在a对象增加了一个可索引属性[1111]。a对象和b对象，两者的隐藏类发生了变化。可索引数组Elememet中的数组也忽然没有了规律。因为写入了a[1111]之后，数组变成了稀疏数组，而为了节省空间，稀疏数组会转换为哈希存储的方式，而不是用一个完整的数组来描述这块空间。有趣的事，上文隐藏类似乎与可索引属性并没有什么关系，但是在这里，Elements从数组变成了稀疏数组，Property并没有变化，但是隐藏类却发生了变化。</p>
<p>大神的分析(咱也不懂，咱也不敢问)</p>
<blockquote>
<p>可能是为了描述 <code>Element</code> 的结构发生改变</p>
</blockquote>
<p><em>让我们从调试角度再来回顾一下上文的内容</em></p>
<p>通过*%DebugPrint(a)<em>来查看对象a在内存中的分布，也可以通过</em>job 0x2c671120f451*来查看这个结构。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(a)</span><br><span class="line">DebugPrint: <span class="number">0x2c671120f451</span>: [JS_OBJECT_TYPE]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x3ef5ef90ce91</span> &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x2c671120f349</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x3ef5ef90cee9</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x2c671120fae9</span> &lt;FixedArray[<span class="number">19</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: <span class="number">0x2296bb502251</span> &lt;FixedArray[<span class="number">0</span>]&gt; &#123;</span><br><span class="line">    <span class="meta">#name: 0x200db42b661 <span class="meta-string">&lt;String[3]: aaa&gt; (data field 0)</span></span></span><br><span class="line">    <span class="meta">#text: 0x200db42b661 <span class="meta-string">&lt;String[3]: aaa&gt; (data field 1)</span></span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: <span class="number">0x2c671120fae9</span> &lt;FixedArray[<span class="number">19</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">0x2296bb502321</span> &lt;the_hole&gt;</span><br><span class="line">           <span class="number">1</span>: <span class="number">0x200db42b661</span> &lt;String[<span class="number">3</span>]: aaa&gt;</span><br><span class="line">        <span class="number">2</span><span class="number">-18</span>: <span class="number">0x2296bb502321</span> &lt;the_hole&gt;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="number">0x3ef5ef90ce91</span>: [Map]</span><br><span class="line"> - type: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: <span class="number">104</span></span><br><span class="line"> - inobject properties: <span class="number">10</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">8</span></span><br><span class="line"> - <span class="keyword">enum</span> length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x3ef5ef90ce39</span> &lt;Map(HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x2296bb502629</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">2</span>: <span class="number">0x2c671120f831</span> &lt;DescriptorArray[<span class="number">8</span>]&gt;</span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - prototype: <span class="number">0x2c671120f349</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x3ef5ef90cee9</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x200db427329</span> &lt;JSFunction Foo1 (sfi = <span class="number">0x200db427149</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x2296bb502251</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - construction counter: <span class="number">5</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="number">1</span>: <span class="string">&quot;aaa&quot;</span>, name: <span class="string">&quot;aaa&quot;</span>, text: <span class="string">&quot;aaa&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(b)</span><br><span class="line">DebugPrint: <span class="number">0x2c671120f531</span>: [JS_OBJECT_TYPE]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x3ef5ef90ce91</span> &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x2c671120f349</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x3ef5ef90cee9</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x2296bb502251</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: <span class="number">0x2296bb502251</span> &lt;FixedArray[<span class="number">0</span>]&gt; &#123;</span><br><span class="line">    <span class="meta">#name: 0x200db42bd11 <span class="meta-string">&lt;String[3]: bbb&gt; (data field 0)</span></span></span><br><span class="line">    <span class="meta">#text: 0x200db42bd11 <span class="meta-string">&lt;String[3]: bbb&gt; (data field 1)</span></span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="number">0x3ef5ef90ce91</span>: [Map]</span><br><span class="line"> - type: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: <span class="number">104</span></span><br><span class="line"> - inobject properties: <span class="number">10</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">8</span></span><br><span class="line"> - <span class="keyword">enum</span> length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x3ef5ef90ce39</span> &lt;Map(HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x2296bb502629</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">2</span>: <span class="number">0x2c671120f831</span> &lt;DescriptorArray[<span class="number">8</span>]&gt;</span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - prototype: <span class="number">0x2c671120f349</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x3ef5ef90cee9</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x200db427329</span> &lt;JSFunction Foo1 (sfi = <span class="number">0x200db427149</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x2296bb502251</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - construction counter: <span class="number">5</span></span><br><span class="line"></span><br><span class="line">&#123;name: <span class="string">&quot;bbb&quot;</span>, text: <span class="string">&quot;bbb&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>通过telescope命令(可见显示指针关系)，比较接近在Chrome中的观感。需要注意的是<em><strong>v8为了区别对象和值类型的区别，在对象的最低位设置为1，所以使用命令时需要-1才能获得正确的值。</strong></em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x2c671120f451</span><span class="number">-1</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│   <span class="number">0x2c671120f450</span> —▸ <span class="number">0x3ef5ef90ce91</span> ◂— <span class="number">0xd00002c8ca6a022</span>			<span class="comment">//map: 0x3ef5ef90ce91</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│   <span class="number">0x2c671120f458</span> —▸ <span class="number">0x2296bb502251</span> ◂— <span class="number">0x2c8ca6a023</span>						<span class="comment">//properties: 0x2296bb502251 &lt;FixedArray[0]&gt;</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│   <span class="number">0x2c671120f460</span> —▸ <span class="number">0x2c671120fae9</span> ◂— <span class="number">0x2c8ca6a023</span>						<span class="comment">//elements: 0x2c671120fae9 &lt;FixedArray[19]&gt;</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│   <span class="number">0x2c671120f468</span> —▸ <span class="number">0x200db42b661</span> ◂— <span class="number">0xbe00002c8ca6a024</span>			<span class="comment">//properties[name/text](共用): 0x200db42b661</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│   <span class="number">0x2c671120f478</span> —▸ <span class="number">0x2c8ca6a023b9</span> ◂— <span class="number">0x100002c8ca6a022</span>			<span class="comment">//slot</span></span><br><span class="line">... ↓</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x2c671120f531</span><span class="number">-1</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│   <span class="number">0x2c671120f530</span> —▸ <span class="number">0x3ef5ef90ce91</span> ◂— <span class="number">0xd00002c8ca6a022</span>			<span class="comment">//map: 0x3ef5ef90ce91</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│   <span class="number">0x2c671120f538</span> —▸ <span class="number">0x2296bb502251</span> ◂— <span class="number">0x2c8ca6a023</span>						<span class="comment">//properties</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│   <span class="number">0x2c671120f548</span> —▸ <span class="number">0x200db42bd11</span> ◂— <span class="number">0xc600002c8ca6a024</span>			<span class="comment">//elements</span></span><br><span class="line">... ↓</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│   <span class="number">0x2c671120f558</span> —▸ <span class="number">0x2c8ca6a023b9</span> ◂— <span class="number">0x100002c8ca6a022</span>			<span class="comment">//properties[name]</span></span><br></pre></td></tr></table></figure>
<p>验证前文property和element属性的分开存放的假设，初始时两者的值是相同的。<em>properties</em>数组中存放的值如果相同（例如都是’aaa’），也会引用同一块内存用来节省空间，类似隐藏类的实现。</p>
<p><strong>命名属性（property）的不同存储方式</strong></p>
<p>V8 中命名属性有三种的不同存储方式：对象内属性（in-object）、快属性（fast）和慢属性（slow）</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/nd7e92.png" alt="nd7e92"></p>
<ul>
<li>对象内属性，保存在对象本身，访问速度最快</li>
<li>快属性，比前者多一次寻址次数</li>
<li>慢属性速度最慢，将属性的完整结构存储在内（前两种属性的结构会将结构放在隐藏类中描述）</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//三种不同类型的 Property 存储模式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo2</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> Foo2()</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> Foo2()</span><br><span class="line"><span class="keyword">var</span> c = <span class="keyword">new</span> Foo2()</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++) &#123;</span><br><span class="line">  a[<span class="keyword">new</span> <span class="built_in">Array</span>(i+<span class="number">2</span>).join(<span class="string">&#x27;a&#x27;</span>)] = <span class="string">&#x27;aaa&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">12</span>; i ++) &#123;</span><br><span class="line">  b[<span class="keyword">new</span> <span class="built_in">Array</span>(i+<span class="number">2</span>).join(<span class="string">&#x27;b&#x27;</span>)] = <span class="string">&#x27;bbb&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i ++) &#123;</span><br><span class="line">  c[<span class="keyword">new</span> <span class="built_in">Array</span>(i+<span class="number">2</span>).join(<span class="string">&#x27;c&#x27;</span>)] = <span class="string">&#x27;ccc&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对象内属性和快属性的结构基本相同，对象内属性因为对象存储空间的限制，所以在超过10个属性之后多余的部分就会进入property（命名属性）中。</p>
<p><em>对象内属性</em></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/u5vm0G.png" alt="u5vm0G"></p>
<p><em>快属性</em>：多出的两个属性被存入property中，并且有序索引。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/mzVIMk.png" alt="mzVIMk"></p>
<p><em>慢属性</em>：property中的索引变得无序，说明这个对象已经采用了hash存取结构了。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/Kk2crN.png" alt="Kk2crN"></p>
<p>至于为什么要采用三种方式进行存储，无非是为了让v8更快一些。这里就不做记录了，有兴趣可以看参考文献。</p>
<p><strong>隐藏类</strong></p>
<p><em><strong>Hidden Class</strong></em>，即隐藏类，V8借用了类和偏移位置的思想，将本来通过属性名匹配来访问属性值的方法进行了改进，使用类似C++编译器的偏移位置机制来实现。在V8的Memory检查器中，隐藏类被称为<em><strong>Map</strong></em>。在SpiderMonkey中，类似的设计被称为<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/38202123">Shape</a>。</p>
<p>隐藏类的目的只有两个，运行更快和占内存空间更小。我们这里从节省内存空间讨论。</p>
<p>在 ECMAScript 中，<a target="_blank" rel="noopener" href="https://tc39.github.io/ecma262/#sec-property-attributes">对象属性的 Attribute</a>被描述为以下结构。</p>
<ul>
<li><code>[[Value]]</code>：属性的值</li>
<li><code>[[Writable]]</code>：定义属性是否可写（即是否能被重新分配）</li>
<li><code>[[Enumerable]]</code>：定义属性是否可枚举</li>
<li><code>[[Configurable]]</code>：定义属性是否可配置（删除）</li>
</ul>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/QajU2V.png" alt="QajU2V"></p>
<p>隐藏类的引入，将属性的 <code>Value</code> 与其它 <code>Attribute</code> 分开。一般情况下，对象的 Value 是经常会发生变动的，而 <code>Attribute</code> 是几乎不怎么会变的。没有没有必要重复Attribute的剩余部分。</p>
<p><strong>隐藏类的创建</strong></p>
<p>对象创建过程中，每添加一个命名属性，都会对应一个生成一个新的隐藏类。在 V8 的底层实现了一个将隐藏类连接起来的转换树，如果以相同的顺序添加相同的属性，转换树会保证最后得到相同的隐藏类。</p>
<p>下面的例子中，a 在空对象时、添加 <code>name</code>属性后、添加 <code>text</code>属性后会分别对应不同的隐藏类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo3</span> (<span class="params"></span>)</span>&#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> a = <span class="keyword">new</span> Foo3();</span><br><span class="line">a.name = <span class="string">&#x27;migraine1&#x27;</span></span><br><span class="line">a.text = <span class="string">&#x27;migraine2&#x27;</span></span><br></pre></td></tr></table></figure>
<p><em>隐藏类生成概念图</em></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/5WU8yj.png" alt="5WU8yj"></p>
<p>查看堆内存快照，在创建name时，Hidden Class1创建了一个Attribute，当Hidden Class2创建的时候，name部分的属性会直接饮用Hidden Class1的Attribute。快照中可以看到back_pointer指向前一个Hidden Class。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/mkZCAu.png" alt="mkZCAu"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/Aqwc3r.png" alt="Aqwc3r"></p>
<p><strong>隐藏类的结构</strong></p>
<p>让我们从上文DebugPrint(a)的数据来看</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo1</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> Foo1()</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> Foo1()</span><br><span class="line"></span><br><span class="line">a.name = <span class="string">&#x27;aaa&#x27;</span></span><br><span class="line">a.text = <span class="string">&#x27;aaa&#x27;</span></span><br><span class="line">b.name = <span class="string">&#x27;bbb&#x27;</span></span><br><span class="line">b.text = <span class="string">&#x27;bbb&#x27;</span></span><br><span class="line"></span><br><span class="line">a[<span class="number">1</span>] = <span class="string">&#x27;aaa&#x27;</span></span><br><span class="line">a[<span class="number">2</span>] = <span class="string">&#x27;aaa&#x27;</span></span><br></pre></td></tr></table></figure>
<p><em>a对象中的map</em>，各个部分的意义在注释中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x3ef5ef90ce91</span>: [Map]</span><br><span class="line"> - type: JS_OBJECT_TYPE				<span class="comment">//实例类型</span></span><br><span class="line"> - instance size: <span class="number">104</span>					<span class="comment">//实例大小</span></span><br><span class="line"> - inobject properties: <span class="number">10</span>		<span class="comment">//对象内属性存储空间</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">8</span>  <span class="comment">//未使用slot数</span></span><br><span class="line"> - <span class="class"><span class="keyword">enum</span> <span class="title">length</span>:</span> invalid</span><br><span class="line"> - stable_map									<span class="comment">//处于快属性模式 （dictionary_map：慢属性/字典模式）</span></span><br><span class="line"> - back pointer: <span class="number">0x3ef5ef90ce39</span> &lt;Map(HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x2296bb502629</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">2</span>: <span class="number">0x2c671120f831</span> &lt;DescriptorArray[<span class="number">8</span>]&gt;<span class="comment">//标识对象实例的属性名与其值的存取位置（a和b的描述符相同，结构也相同）</span></span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - prototype: <span class="number">0x2c671120f349</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x3ef5ef90cee9</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x200db427329</span> &lt;JSFunction Foo1 (sfi = <span class="number">0x200db427149</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x2296bb502251</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - construction counter: <span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>job查看其中的对象实例</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   pwndbg&gt; job <span class="number">0x2c671120f831</span></span><br><span class="line">Descriptor <span class="built_in">array</span> #<span class="number">2</span>:</span><br><span class="line">  [<span class="number">0</span>]: <span class="meta">#name (data field 0:h, p: 0, attrs: [WEC]) @ Any</span></span><br><span class="line">  [<span class="number">1</span>]: <span class="meta">#text (data field 1:h, p: 1, attrs: [WEC]) @ Any</span></span><br></pre></td></tr></table></figure>
<p><em>通过内存实验,验证一下MAP创建的过程。</em></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Foo3</span> (<span class="params"></span>)</span>&#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> a = <span class="keyword">new</span> Foo3();</span><br><span class="line">a.name = <span class="string">&#x27;migraine1&#x27;</span></span><br><span class="line">a.text = <span class="string">&#x27;migraine2&#x27;</span></span><br></pre></td></tr></table></figure>
<p>创建a.name之后，a.text之前的MAP</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x296dce70cf41</span>: [Map]</span><br><span class="line"> - type: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: <span class="number">104</span></span><br><span class="line"> - inobject properties: <span class="number">10</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">9</span></span><br><span class="line"> - <span class="class"><span class="keyword">enum</span> <span class="title">length</span>:</span> invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x296dce70ccd9</span> &lt;Map(HOLEY_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0xc850a002629</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">1</span>: <span class="number">0x39ca33d90331</span> &lt;DescriptorArray[<span class="number">5</span>]&gt;</span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - prototype: <span class="number">0x39ca33d8f379</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x296dce70cde1</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x3e90a04a7329</span> &lt;JSFunction Foo3 (sfi = <span class="number">0x3e90a04a7149</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0xc850a002251</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - construction counter: <span class="number">6</span></span><br><span class="line"></span><br><span class="line">&#123;name: <span class="string">&quot;migriane1&quot;</span>&#125;</span><br><span class="line">-----</span><br><span class="line">pwndbg&gt; job <span class="number">0x39ca33d90331</span>        <span class="comment">//对象实例name</span></span><br><span class="line">Descriptor <span class="built_in">array</span> #<span class="number">1</span>:</span><br><span class="line">  [<span class="number">0</span>]: <span class="meta">#name (data field 0:h, p: 0, attrs: [WEC]) @ Any</span></span><br></pre></td></tr></table></figure>
<p>创建a.text之后的MAP</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x296dce70cff1</span>: [Map]</span><br><span class="line"> - type: JS_OBJECT_TYPE</span><br><span class="line"> - instance size: <span class="number">104</span></span><br><span class="line"> - inobject properties: <span class="number">10</span></span><br><span class="line"> - elements kind: HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">8</span>																<span class="comment">//a.text 占用了对象内属性空间</span></span><br><span class="line"> - <span class="class"><span class="keyword">enum</span> <span class="title">length</span>:</span> invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: <span class="number">0x296dce70cf41</span> &lt;Map(HOLEY_ELEMENTS)&gt;       <span class="comment">//之前之前的MAP地址</span></span><br><span class="line"> - prototype_validity cell: <span class="number">0xc850a002629</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors (own) #<span class="number">2</span>: <span class="number">0x39ca33d90891</span> &lt;DescriptorArray[<span class="number">8</span>]&gt;</span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - prototype: <span class="number">0x39ca33d8f379</span> &lt;Object <span class="built_in">map</span> = <span class="number">0x296dce70cf99</span>&gt;</span><br><span class="line"> - constructor: <span class="number">0x3e90a04a7329</span> &lt;JSFunction Foo3 (sfi = <span class="number">0x3e90a04a7149</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0xc850a002251</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - construction counter: <span class="number">6</span></span><br><span class="line"></span><br><span class="line">&#123;name: <span class="string">&quot;migriane1&quot;</span>, text: <span class="string">&quot;migraine2&quot;</span>&#125;</span><br><span class="line">---</span><br><span class="line">pwndbg&gt; job <span class="number">0x39ca33d90891</span></span><br><span class="line">Descriptor <span class="built_in">array</span> #<span class="number">2</span>:</span><br><span class="line">  [<span class="number">0</span>]: <span class="meta">#name (data field 0:h, p: 1, attrs: [WEC]) @ Any</span></span><br><span class="line">  [<span class="number">1</span>]: <span class="meta">#text (data field 1:h, p: 0, attrs: [WEC]) @ Any</span></span><br></pre></td></tr></table></figure>
<h3 id="V8内存模型"><a href="#V8内存模型" class="headerlink" title="V8内存模型"></a>V8内存模型</h3><p><a target="_blank" rel="noopener" href="http://eternalsakura13.com/2018/05/06/v8/">v8 exploit</a> </p>
<p>V8的Object内存继承关系如下，继承比较复杂看源代码的时候需要注意从基类继承下来的变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Object</span><br><span class="line">	Smi</span><br><span class="line">	HeapObject</span><br><span class="line">		HeapNumber</span><br><span class="line">		PropertyCell</span><br><span class="line">		Name</span><br><span class="line">				String</span><br><span class="line">		Oddball</span><br><span class="line">		JSReceiver</span><br><span class="line">			JSObject</span><br><span class="line">				JSFunction</span><br><span class="line">				JSArray</span><br><span class="line">				JSArrayBuffer</span><br></pre></td></tr></table></figure>
<p><strong>Object</strong></p>
<p>Object主要包含两种类型</p>
<ul>
<li>Smi(Samll Integer) &lt;–整数<ul>
<li>整数由带符号的31位范围表示</li>
<li>整数由带符号的32位范围表示<ul>
<li>最后一bit(LSB)始终为0</li>
</ul>
</li>
</ul>
</li>
<li>HeapObject. &lt;–V8大部分存储类型的基类<ul>
<li>除了整数以外的其他类（包括范围在Smi表达以外的整数，例如Double）<ul>
<li>始终有个指向Map的指针。</li>
<li>最后一bit位始终是1，在解引用的时候要做-1操作</li>
</ul>
</li>
<li>HeapObject基本上由GC管理，因此位于GC区域，而不是HEAP的区域（堆喷射中一连串均匀的非HEAP内存，那个一般就是JS的GC堆）</li>
</ul>
</li>
</ul>
<p><strong>Tagged Values</strong></p>
<p>同时表示指向Smi和HeapObject的指针的机制（gdb中通过job查看内存会自动进行区分）</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/0zUFQE.png" alt="0zUFQE"></p>
<ul>
<li>指向SMI时（LSB&#x3D;0）<ul>
<li>32bit ：通过右移一位获得原始值</li>
<li>64bit：通过右移32位获得原始值（64bit原始值在高32位）</li>
</ul>
</li>
</ul>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/5wvZ0a.png" alt="5wvZ0a"></p>
<ul>
<li><p>指向HeapObject时</p>
<ul>
<li>32bit：Ptr-1直接指向HeapObject</li>
<li>64bit:  Ptr-1 直接指向HeapObject</li>
</ul>
<p>因为GC上的CHUNK都是4&#x2F;8字节对齐的，所以<em>指针</em>在不人为改动的情况下HeapObject最低位LSB始终是0，所以Pointer不需要和Smi一样左移来空出多余的一位。</p>
</li>
</ul>
<p><strong>HeapNumber</strong></p>
<p>当对象的值位Double，数据无法在Smi范围内表达，就需要借用HeapObject来存储数据。</p>
<p>V8中的HeapObject内部没有定义成员变量，这些内部指针是通过偏移量实现的。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/w2Cl0B.png" alt="w2Cl0B"></p>
<p>也同样做一遍实验，存储Smi(0xdeadbee)和Double(0xdeadbeef),后者要大于0x7fffffff，所以需要放在数组中。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/oG6cDV.png" alt="oG6cDV"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x10bf2190d441</span><br><span class="line">0x10bf2190d441: [FixedArray]</span><br><span class="line"> - map: 0x2f1f4b9826d1 &lt;Map&gt;</span><br><span class="line"> - length: 3</span><br><span class="line">           0: 233495534</span><br><span class="line">           1: 0x236edc27151 &lt;Number 3.73593e+09&gt;</span><br><span class="line">           2: 0x236edc27021 &lt;String[6]: 123123&gt;</span><br></pre></td></tr></table></figure>
<p>写入内存之后，通过job可以看到这个数组内容，不过这次我们需要直接用x&#x2F;看</p>
<p><em>Smi类型是直接存在FixedArray中高32位置</em></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/zRoK95.png" alt="zRoK95"></p>
<p><em>非Smi类型，存放在指针中，解引用的时候需要-1</em></p>
<p>0x41ebd5bdde0000是0xdeadbeef的double存储方式</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/noMmcP.png" alt="noMmcP"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/flphXO.png" alt="flphXO"></p>
<p>HeapNumber对象和其他对象连续，中间没有任何间隙（自己做的图好丑）</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/4iMv3n.png" alt="4iMv3n"></p>
<p><em>这部分还有一些坑，之后再填，先学下面的部分</em></p>
<p><strong>JSObject</strong></p>
<p>这部分在上文有过比较详细实验，简单总结一下。</p>
<p>JSObject用于表示Javascript中的对象</p>
<p>​	继承自<em>Object-&gt;HeapObject-&gt;JSReceiver</em></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/vdqCSg.png" alt="vdqCSg"></p>
<ul>
<li>JSObject从JSReceiver继承Property（命名属性），用于存放命名属性</li>
<li>JSObject定义了Elements（可索引属性），用于存放可索引属性</li>
</ul>
<p><strong>JSFunction</strong></p>
<p>用于指向Javascript Function的对象</p>
<p>​	继承自 <em>Object-&gt;HeapObject-&gt;JSRecviver-&gt;JSObject</em></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/Lp1jtk.png" alt="Lp1jtk"></p>
<p>实验一下</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/cY5Oz0.png" alt="cY5Oz0"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;20xg  0x6d0e21a7308  &lt;-- function f()</span><br><span class="line">0x6d0e21a7308:	0x00000dd381902519 &lt;--KMapOffset*	0x000030bd03f82251</span><br><span class="line">0x6d0e21a7318:	0x000030bd03f82251	0x000006d0e21a7129</span><br><span class="line">0x6d0e21a7328:	0x000006d0e2183eb1	0x000006d0e21a72e9</span><br><span class="line">0x6d0e21a7338:	0x000014a2d8e1fe41 &lt;--kCodeEntry	0x000030bd03f82321</span><br><span class="line">0x6d0e21a7348:	0x00001bdd17582a41	</span><br></pre></td></tr></table></figure>
<ul>
<li><p>kCodeEntryOffset是一个指向JIT code（可读可执行的区域），很多exploit都会在这个部分写入shellcode。当然前提是这个funciton变热才会使用JIT</p>
<ul>
<li><p>V8 <em>6.7版本</em>之后JIT的区域不再可写，可能需要结合JIT Spray才能利用。（这个知识点还不太懂，没试过）</p>
</li>
<li><p>向JIT的RWX内存实现利用可以看我写的<a href="https://migraine-sudo.github.io/2019/12/20/qwn2own/">JS Engine Exploit-qwn2own</a></p>
</li>
</ul>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/YxmYWC.png" alt="YxmYWC"></p>
<p>​							<em><strong>GC区域中 标注位Code的部分大概就是JIT的执行区域</strong></em></p>
</li>
</ul>
<p><strong>JSArray</strong></p>
<p> 继承自 Object-&gt;HeapObject-&gt;JSReceiver-&gt;JSObject</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/923PSg.png" alt="923PSg"></p>
<p><strong>JSArrayBuffer</strong></p>
<p><em>ArrayBuffer &amp; TypedArray</em></p>
<p>​	ArrayBuffer是一个直接从Javascript访问内存的特殊数组</p>
<ul>
<li><p>ArrayBuffer仅仅准备了一个内存缓冲区</p>
</li>
<li><p>BackingStore，可以使用TypedArray指定的类型读取和写入该区域</p>
<ul>
<li><em>BackingStore指针，属于HEAP而不是GC管理区域</em></li>
</ul>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/uNlKzE.png" alt="uNlKzE"></p>
</li>
<li><p>实际应用中，有必要和TypedArray和DataView一起使用</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/vBi7I1.png" alt="vBi7I1"></p>
<p><em>一些Demo</em></p>
<ul>
<li><p>不使用TypeArray</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; var a=<span class="keyword">new</span> ArrayBuffer(<span class="number">8</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d8&gt; %DebugPrint(a)</span><br><span class="line">DebugPrint: <span class="number">0x2be37c28d469</span>: [JSArrayBuffer]</span><br><span class="line"> - <span class="built_in">map</span>: <span class="number">0x2ed11a983fe9</span> &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br></pre></td></tr></table></figure></li>
<li><p>prototype: 0x34a749712981 <Object map="0x2ed11a984041"></Object></p>
<ul>
<li>elements: 0x9d3c4182251 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</li>
</ul>
</li>
<li><p>embedder fields: 2</p>
<ul>
<li>backing_store: 0x55b2de6d7c40   –&gt;指向HEAP区而不是GC区</li>
<li>byte_length: 8<br> …<br>}<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 使用TypeArray</span><br><span class="line"></span><br><span class="line">  *制定长度，初始化为0*</span><br><span class="line"></span><br><span class="line">  &#96;t_arr&#x3D;new Uint8Array(128)&#96;&#x2F;&#x2F;ArrayBuffer被创建在内部</span><br><span class="line"></span><br><span class="line">  *使用特定值初始化*</span><br><span class="line"></span><br><span class="line">  &#96;t_arr&#x3D;new Uint8Array([1,2,3,4])&#96;&#x2F;&#x2F;ArrayBuffer被创建在内部</span><br><span class="line"></span><br><span class="line">*事先构建缓冲区并使用它*</span><br><span class="line"></span><br></pre></td></tr></table></figure>
arr_buf&#x3D;new ArrayBuffer(8);<br>t_arr1&#x3D;new Uint16Array(arr_buf);&#x2F;&#x2F;创建一个Uint16数组<br>t_arr2&#x3D;new Uint16Array(arr_buf,0,4);&#x2F;&#x2F;或者，您也可以指定数组的开始和结束位置<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/8hWdrz.png" alt="8hWdrz"></p>
<p>[此图参考Hpasserby师傅文章的绘制]:(<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5190#toc-9">https://xz.aliyun.com/t/5190#toc-9</a>)	“，继承的C++ CLASS太多，内容太复杂了。这个结构肉眼看起来好累。。还容易画错”</p>
<ul>
<li><p>BackingStore指向存储ArrayBuffer数据的HEAP。</p>
<ul>
<li>所以在攻击中，覆盖BackingStore指针来实现一个oob是一个很好的思路</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">arr=<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x20</span>);</span><br><span class="line">u32=<span class="keyword">new</span> <span class="built_in">Uint32Array</span>(arr);</span><br><span class="line">u32[<span class="number">0</span>]=<span class="number">0x1234</span>;</span><br><span class="line">u32[<span class="number">1</span>]=<span class="number">0x5678</span>;</span><br><span class="line">%DebugPrint(u32);</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/39RjhN.png" alt="39RjhN"></p>
<ul>
<li><p>ArrayBuffer也可以在不同的TypedArray之间共享</p>
<ul>
<li>准备ArrayBuffer</li>
</ul>
<p>​	<code>var ab = new ArrayBuffer(0x100);</code></p>
<ul>
<li>向ArrayBuffer写入Float64的值</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(ab);</span><br><span class="line">t64[<span class="number">0</span>] = <span class="number">6.953328187651540e-310</span>;<span class="comment">//字节序列是0x00007fffdeadbeef</span></span><br></pre></td></tr></table></figure>
<p><strong>当某些地址在V8上泄露时，通常在大多数情况下被迫将其解释为双精度值，为了正确计算偏移量等，需要将其转换为整数值。 对于完成该转换，ArrayBuffer是最佳的。</strong></p>
<ul>
<li><p>从ArrayBuffer读取两个unit32</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> t32 = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(ab);</span><br><span class="line">k = [t32[<span class="number">1</span>],t32[<span class="number">0</span>]]</span><br></pre></td></tr></table></figure>
<p><strong>k是6.953328187651540e-310,将字节序列按照4个字节去分开，然后解释为Uint32,于是得到:</strong><br><strong>k&#x3D;[0x00007fff，0xdeadbeef]</strong></p>
</li>
</ul>
<h2 id="代码阅读引导"><a href="#代码阅读引导" class="headerlink" title="代码阅读引导"></a>代码阅读引导</h2><p><em>摘自</em></p>
<p><a target="_blank" rel="noopener" href="http://eternalsakura13.com/2018/07/09/zujian/">V8 javascript engine代码阅读</a> </p>
<p><em>目录：</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">src ---+</span><br><span class="line">       |</span><br><span class="line">       +---arm</span><br><span class="line">       +---arm64</span><br><span class="line">       +---mips</span><br><span class="line">       +---mips64</span><br><span class="line">A      +---ia32</span><br><span class="line">       +---x64</span><br><span class="line">       +---ppc</span><br><span class="line">       +---s390</span><br><span class="line">       +---wasm</span><br><span class="line">       +---asmjs</span><br><span class="line">       |</span><br><span class="line">       +---ast</span><br><span class="line">       +---compiler</span><br><span class="line">B      +---compiler-dispatcher</span><br><span class="line">       +---interpreter</span><br><span class="line">       +---parsing</span><br><span class="line">       |</span><br><span class="line">       +---js</span><br><span class="line">       +---builtins</span><br><span class="line">C      +---runtime</span><br><span class="line">       +---snapshot</span><br><span class="line">       +---regexp</span><br><span class="line">       +---profiler</span><br><span class="line">       |</span><br><span class="line">D      +---ic</span><br><span class="line">       |</span><br><span class="line">       +---heap</span><br><span class="line">E      +---heap-symbols.h</span><br><span class="line">       +---zone</span><br><span class="line">       +---objects</span><br><span class="line">       |</span><br><span class="line">F      +---inspector</span><br><span class="line">       |</span><br><span class="line">       +---base</span><br><span class="line">       +---debug</span><br><span class="line">       +---tracing</span><br><span class="line">       +---extensions</span><br><span class="line">G      +---libplatform</span><br><span class="line">       +---libsampler</span><br><span class="line">       +---third_party</span><br><span class="line">       +---trap-handler</span><br><span class="line">       |</span><br><span class="line">       +---*.cc&#x2F;*.h</span><br><span class="line">       .</span><br><span class="line">       .</span><br><span class="line">       .</span><br></pre></td></tr></table></figure>
<ul>
<li>A:存储汇编代码，反汇编程序，宏汇编程序，模拟器等，对于不同CPU不同。</li>
<li>B:code generation系统，例如parse, compile, interpreter, etc.</li>
<li>C:JS built-in function和runtime helper function</li>
<li>D:Inline Cache code</li>
<li>E:object model(对象模型)和memory(内存)相关代码</li>
<li>F:Inspector</li>
<li>G:Debugging and platform abstraction layer codes are stored.</li>
</ul>
<p><em>必读部分</em></p>
<ul>
<li>api.h&#x2F;api.cc<br>An API for Embedder is defined.</li>
<li>objects.h&#x2F;objects.cc<br>定义了v8的所有对象模型</li>
<li>compiler&#x2F;compiler.cc<br>编译的入口点</li>
<li>compiler&#x2F;pipeline.cc<br>和compiler.cc关联，放置TurboFan</li>
<li>runtime&#x2F;runtime-*.cc<br>A runtime function is defined.</li>
<li>builtins&#x2F;builtin-*.cc<br>A faster runtime function group. It is described in CodeStubAssembler (commentary) or Assembler.</li>
<li>interpreter&#x2F;*.cc<br>Ignition解释器</li>
<li>ic&#x2F;*.cc<br>Inline Caching的实现<br>存储Runtime(?)</li>
</ul>
<h2 id="扩展阅读："><a href="#扩展阅读：" class="headerlink" title="扩展阅读："></a>扩展阅读：</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Bideam/p/6730759.html">从Chrome源码看JS Object的实现</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5dc4d823f265da4d4c202d3b?from=groupmessage">V8 是怎么跑起来的 —— V8 的 JavaScript 执行管道</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30638831/article/details/90552912">js中v8引擎的详解</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000020420800">探究JS V8引擎下的“数组”底层实现</a> &lt;–JSArray是个特殊的JSObject</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/from">Array.from()</a> &lt;–比起内容，更重要的是认识到Polyfill这个开源项目</p>
<p> <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/82854566">V8 小整数（smi）和指针</a> </p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/28780798">奇技淫巧学 V8 之二，对象在 V8 内的表达</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34122548/article/details/90590704">V8 Ignition：JS 引擎与字节码的不解之缘</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/24982678">V8 Object 内存结构与属性访问详解</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.5udou.cn/blog/nodejsShen-Ru-Xue-Xi-Xi-Lie-Zhi-v8Ji-Chu-Pian-2">nodejs深入学习系列之v8基础篇</a> &lt;–v8编译的几种方式</p>
<p><a target="_blank" rel="noopener" href="https://www.chenquan.me/archives/280">如何用GN编译V8引擎</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/23090041?refer=study-fe">什么是JS原型链</a></p>
<p><a target="_blank" rel="noopener" href="https://benediktmeurer.de/2018/06/14/javascript-engine-fundamentals-shapes-and-inline-caches/">JavaScript engine fundamentals: Shapes and Inline Caches</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/push0ebp/v8-starter-guide">v8漏洞利用-韩语</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000021779743">V8引擎内存管理（译文）</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Migraine殇</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://migraine-sudo.github.io/2020/02/15/v8/">https://migraine-sudo.github.io/2020/02/15/v8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://migraine-sudo.github.io" target="_blank">Migraine殇</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Exploit/">Exploit</a></div><div class="post_share"><div class="social-share" data-image="/img/063Kee.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/02/22/roll-a-v8/"><img class="prev-cover" src="/img/tJBFnf.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">PlaidCTF - roll a d8</div></div></a></div><div class="next-post pull-right"><a href="/2020/01/27/how2heap4/"><img class="next-cover" src="/img/%E5%A0%86%E5%88%A9%E7%94%A8.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">How2Heap堆利用学习笔记(四)House Of Spirit/poison_null_byte</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2019/10/22/HeapSpray/" title="HeapSpray入门"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/heap2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-22</div><div class="title">HeapSpray入门</div></div></a></div><div><a href="/2019/12/01/CVE-2012-1876/" title="IE堆漏洞利用（CVE-2012-1876）"><img class="cover" src="/img/XsPKP4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-12-01</div><div class="title">IE堆漏洞利用（CVE-2012-1876）</div></div></a></div><div><a href="/2019/12/21/Shellcode-Write/" title="一步步编写Shellcode"><img class="cover" src="/img/9tBe6z.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-12-21</div><div class="title">一步步编写Shellcode</div></div></a></div><div><a href="/2019/10/18/Win-exploitS-E-H/" title="Windows下漏洞利用 S.E.H深入分析"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/J9yzMy.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-18</div><div class="title">Windows下漏洞利用 S.E.H深入分析</div></div></a></div><div><a href="/2021/04/02/QEMU-CVE-2015-5165/" title="QEMU:CVE-2015-5165"><img class="cover" src="https://z3.ax1x.com/2021/07/09/RvdfH0.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-02</div><div class="title">QEMU:CVE-2015-5165</div></div></a></div><div><a href="/2020/02/22/roll-a-v8/" title="PlaidCTF - roll a d8"><img class="cover" src="/img/tJBFnf.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-02-22</div><div class="title">PlaidCTF - roll a d8</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/%E6%88%88%E8%96%87.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Migraine殇</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/migraine-sudo"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/migraine-sudo" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2576361468@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://twitter.com/0xp0kerface" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎光临寒舍，右下角可以设置夜间模式</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#V8%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">V8环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#v8-DEBUG"><span class="toc-number">2.</span> <span class="toc-text">v8 DEBUG</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#V8-Object%E5%85%A5%E9%97%A8"><span class="toc-number">2.1.</span> <span class="toc-text">V8 Object入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#V8%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.2.</span> <span class="toc-text">V8内存模型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB%E5%BC%95%E5%AF%BC"><span class="toc-number">3.</span> <span class="toc-text">代码阅读引导</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB%EF%BC%9A"><span class="toc-number">4.</span> <span class="toc-text">扩展阅读：</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2099/12/14/Diary/" title="Diary"><img src="/img/IMG_7932.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Diary"/></a><div class="content"><a class="title" href="/2099/12/14/Diary/" title="Diary">Diary</a><time datetime="2099-12-13T16:01:36.000Z" title="发表于 2099-12-14 00:01:36">2099-12-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/30/nexus5/" title="Nexus5折腾小记"><img src="https://img-blog.csdnimg.cn/img_convert/182eb0788d06c05a6c26308aaa0150a1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nexus5折腾小记"/></a><div class="content"><a class="title" href="/2022/07/30/nexus5/" title="Nexus5折腾小记">Nexus5折腾小记</a><time datetime="2022-07-30T15:54:15.000Z" title="发表于 2022-07-30 23:54:15">2022-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/12/%E7%95%99%E7%BB%99%E8%BF%99%E4%B8%8D%E9%95%BF%E4%B8%8D%E7%9F%AD%E7%9A%84%E6%97%B6%E5%85%89/" title="留给这不长不短的时光"><img src="https://z3.ax1x.com/2021/07/17/W13xu4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="留给这不长不短的时光"/></a><div class="content"><a class="title" href="/2021/07/12/%E7%95%99%E7%BB%99%E8%BF%99%E4%B8%8D%E9%95%BF%E4%B8%8D%E7%9F%AD%E7%9A%84%E6%97%B6%E5%85%89/" title="留给这不长不短的时光">留给这不长不短的时光</a><time datetime="2021-07-12T15:53:34.000Z" title="发表于 2021-07-12 23:53:34">2021-07-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/02/QEMU-CVE-2015-5165/" title="QEMU:CVE-2015-5165"><img src="https://z3.ax1x.com/2021/07/09/RvdfH0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="QEMU:CVE-2015-5165"/></a><div class="content"><a class="title" href="/2021/04/02/QEMU-CVE-2015-5165/" title="QEMU:CVE-2015-5165">QEMU:CVE-2015-5165</a><time datetime="2021-04-02T07:52:34.000Z" title="发表于 2021-04-02 15:52:34">2021-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/30/mips-pwn/" title="Mips 漏洞入门与分析（CVE-2020-8423）"><img src="/img/7GdBdp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Mips 漏洞入门与分析（CVE-2020-8423）"/></a><div class="content"><a class="title" href="/2021/01/30/mips-pwn/" title="Mips 漏洞入门与分析（CVE-2020-8423）">Mips 漏洞入门与分析（CVE-2020-8423）</a><time datetime="2021-01-29T17:50:25.000Z" title="发表于 2021-01-30 01:50:25">2021-01-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Migraine殇</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>